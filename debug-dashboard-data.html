<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Dashboard Data</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .btn { background: #1565c0; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 10px 5px; }
        .section { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîç Debug Dashboard Data Issues</h1>

    <button id="checkVisitsBtn" class="btn">üìä Check Visits Table</button>
    <button id="testQueriesBtn" class="btn">üîç Test Dashboard Queries</button>
    <button id="checkActivitiesBtn" class="btn">üìã Check Activities Table</button>

    <div id="results"></div>
    <div class="log" id="log"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://lmsuyhzcmgdpjynosxvp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxtc3V5aHpjbWdkcGp5bm9zeHZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NzM5NjksImV4cCI6MjA3MzI0OTk2OX0.rRpHs_0ZLW3erdFnm2SwFTAmyQJYRMpcSlNzMBlcq4U';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message) {
            const logElement = document.getElementById('log');
            logElement.innerHTML += message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showResults(content) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += `<div class="section">${content}</div>`;
        }

        async function checkVisitsTable() {
            log('üìä Checking visits table after migration...');

            try {
                const { count: totalVisits } = await supabase
                    .from('visits')
                    .select('*', { count: 'exact', head: true });

                log(`Total visits: ${totalVisits}`);

                const { data: sampleVisits, error } = await supabase
                    .from('visits')
                    .select('school_name, student_count, teacher_count, status, submitted_at')
                    .limit(5);

                if (error) {
                    log(`‚ùå Error: ${error.message}`);
                    return;
                }

                log('Sample visits:');
                sampleVisits.forEach((visit, index) => {
                    log(`${index + 1}. ${visit.school_name}: ${visit.student_count} students, ${visit.teacher_count} teachers, status: ${visit.status}`);
                });

                showResults(`
                    <h3>üìä Visits Table Status</h3>
                    <p><strong>Total visits:</strong> ${totalVisits}</p>
                    <p><strong>Sample data:</strong> ${sampleVisits.length > 0 ? 'Found' : 'None'}</p>
                `);

            } catch (error) {
                log(`‚ùå Error checking visits: ${error.message}`);
            }
        }

        async function testDashboardQueries() {
            log('üîç Testing the exact queries from dashboard...');

            try {
                // Test pending count query
                const { count: pendingCount } = await supabase
                    .from('visits')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pending');

                log(`Pending visits: ${pendingCount}`);

                // Test monthly count query
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                startOfMonth.setHours(0, 0, 0, 0);

                const { count: monthlyCount } = await supabase
                    .from('visits')
                    .select('*', { count: 'exact', head: true })
                    .gte('submitted_at', startOfMonth.toISOString());

                log(`This month visits: ${monthlyCount}`);

                // Test all visits query
                const { data: allVisits } = await supabase
                    .from('visits')
                    .select('*');

                log(`All visits data: ${allVisits ? allVisits.length : 0} records`);

                if (allVisits && allVisits.length > 0) {
                    const uniqueSchools = [...new Set(allVisits.map(r => r.school_name))].length;
                    log(`Unique schools: ${uniqueSchools}`);

                    const totalVisitors = allVisits.reduce((sum, r) => {
                        const students = parseInt(r.student_count) || 0;
                        const adults = parseInt(r.teacher_count) || parseInt(r.accompanying_adults) || 2;
                        return sum + students + adults;
                    }, 0);

                    log(`Total visitors: ${totalVisitors}`);

                    const today = new Date();
                    let completedVisits = 0;

                    allVisits.forEach(visit => {
                        const confirmedDate = visit.confirmed_date ? new Date(visit.confirmed_date) : null;
                        const submittedDate = visit.submitted_at ? new Date(visit.submitted_at) : null;

                        const isDateInPast = confirmedDate && confirmedDate < today;
                        const isOldApproved = (visit.status === 'approved' || visit.status === 'scheduled') &&
                                             submittedDate && (today - submittedDate) > (30 * 24 * 60 * 60 * 1000);
                        const isCompleted = visit.status === 'completed';

                        if (isDateInPast || isOldApproved || isCompleted) {
                            completedVisits++;
                        }
                    });

                    log(`Completed visits: ${completedVisits}`);

                    showResults(`
                        <h3>üîç Dashboard Query Results</h3>
                        <p><strong>Pending:</strong> ${pendingCount}</p>
                        <p><strong>This Month:</strong> ${monthlyCount}</p>
                        <p><strong>Total Schools:</strong> ${uniqueSchools}</p>
                        <p><strong>Total Visitors:</strong> ${totalVisitors}</p>
                        <p><strong>Completed Visits:</strong> ${completedVisits}</p>
                    `);
                } else {
                    log('‚ùå No visits data found!');
                }

            } catch (error) {
                log(`‚ùå Error testing queries: ${error.message}`);
            }
        }

        async function checkActivitiesTable() {
            log('üìã Checking activities table after migration...');

            try {
                const { count: totalActivities } = await supabase
                    .from('activities')
                    .select('*', { count: 'exact', head: true });

                log(`Remaining activities: ${totalActivities}`);

                const { data: activities, error } = await supabase
                    .from('activities')
                    .select('title, max_participants, activity_type_id')
                    .limit(10);

                if (error) {
                    log(`‚ùå Error: ${error.message}`);
                    return;
                }

                log('Remaining activities:');
                activities.forEach((activity, index) => {
                    log(`${index + 1}. ${activity.title} (${activity.max_participants} participants)`);
                });

                showResults(`
                    <h3>üìã Activities Table Status</h3>
                    <p><strong>Remaining activities:</strong> ${totalActivities}</p>
                    <p><strong>Should be:</strong> Only catalog items (not visit records)</p>
                `);

            } catch (error) {
                log(`‚ùå Error checking activities: ${error.message}`);
            }
        }

        document.getElementById('checkVisitsBtn').addEventListener('click', checkVisitsTable);
        document.getElementById('testQueriesBtn').addEventListener('click', testDashboardQueries);
        document.getElementById('checkActivitiesBtn').addEventListener('click', checkActivitiesTable);

        // Auto-check on load
        checkVisitsTable();
    </script>
</body>
</html>