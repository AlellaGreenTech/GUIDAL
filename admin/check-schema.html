<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Schema - GUIDAL</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .container { max-width: 1000px; margin: 2rem auto; padding: 2rem; }
        .status { padding: 1rem; margin: 1rem 0; border-radius: 4px; }
        .info { background: #d1ecf1; color: #0c5460; }
        .error { background: #f8d7da; color: #721c24; }
        button { background: #28a745; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.9rem; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>GUIDAL Schema Check</h1>
        </div>
    </header>

    <main class="container">
        <h2>Check scheduled_visits Table Columns</h2>
        <button onclick="checkSchema()">Check Table Schema</button>
        <div id="results"></div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script>
        async function waitForSupabase() {
            let attempts = 0;
            while (!window.supabaseClient && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            return window.supabaseClient;
        }

        async function checkSchema() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info status">Checking schema...</div>';

            try {
                const supabase = await waitForSupabase();

                // Try to get one row to see all columns
                const { data, error } = await supabase
                    .from('scheduled_visits')
                    .select('*')
                    .limit(1);

                if (error) {
                    resultsDiv.innerHTML = `<div class="error status">Error: ${error.message}</div>`;
                    return;
                }

                let html = '<h3>scheduled_visits Table Columns:</h3>';

                if (data && data.length > 0) {
                    const columns = Object.keys(data[0]);
                    html += '<p><strong>Available columns (' + columns.length + '):</strong></p>';
                    html += '<pre>' + JSON.stringify(columns, null, 2) + '</pre>';
                    html += '<h4>Sample row:</h4>';
                    html += '<pre>' + JSON.stringify(data[0], null, 2) + '</pre>';
                } else {
                    html += '<p>No data in table, but we can try to insert a minimal record to see required fields...</p>';

                    // Try inserting with minimal data to see what's required
                    const testData = {
                        title: 'Test Event',
                        visit_type: 'public_event',
                        scheduled_date: '2025-10-25T12:30:00+00:00'
                    };

                    const { data: insertData, error: insertError } = await supabase
                        .from('scheduled_visits')
                        .insert([testData])
                        .select();

                    if (insertError) {
                        html += '<div class="error status">Insert error: ' + insertError.message + '</div>';
                    } else {
                        html += '<div class="info status">Successfully inserted test record!</div>';
                        const columns = Object.keys(insertData[0]);
                        html += '<p><strong>Available columns (' + columns.length + '):</strong></p>';
                        html += '<pre>' + JSON.stringify(columns, null, 2) + '</pre>';
                        html += '<h4>Inserted row:</h4>';
                        html += '<pre>' + JSON.stringify(insertData[0], null, 2) + '</pre>';

                        // Delete test record
                        await supabase.from('scheduled_visits').delete().eq('id', insertData[0].id);
                        html += '<p><em>Test record deleted.</em></p>';
                    }
                }

                resultsDiv.innerHTML = html;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error status">Error: ${error.message}</div>`;
                console.error(error);
            }
        }
    </script>
</body>
</html>
