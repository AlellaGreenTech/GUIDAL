<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pumpkin Patch Orders - Admin Dashboard</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #ff6b35;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b35;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 500;
            font-size: 0.9rem;
            color: #333;
        }

        .filter-group input,
        .filter-group select {
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #ff6b35;
            color: white;
        }

        .btn-primary:hover {
            background: #e55a28;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .orders-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
            overflow-y: visible;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1200px;
        }

        tbody {
            position: relative;
        }

        th {
            background: #ff6b35;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        tr {
            position: relative;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Items column formatting */
        .order-items {
            max-width: 120px;
            min-width: 100px;
            font-size: 0.7rem;
            line-height: 1.3;
            overflow: hidden;
        }

        .order-items div {
            margin-bottom: 0.15rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Order status badges */
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #cfe2ff;
            color: #084298;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-refunded {
            background: #e2e3e5;
            color: #41464b;
        }

        .status-failed {
            background: #f8d7da;
            color: #842029;
        }

        .order-items {
            font-size: 0.9rem;
            color: #666;
        }

        .email-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: #28a745;
            margin-left: 0.5rem;
        }

        .email-indicator.no-email {
            color: #dc3545;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            white-space: nowrap;
            min-width: 60px;
            justify-content: center;
            overflow: visible;
            position: relative;
        }

        .action-dropdown {
            position: relative;
            display: flex;
            gap: 0.25rem;
        }

        .btn-dropdown {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s;
            line-height: 1;
        }

        .btn-dropdown:hover {
            background: #5a6268;
        }

        .action-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 180px;
            margin-top: 0.25rem;
        }

        .action-menu.show {
            display: block;
        }

        .action-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            color: #333;
        }

        .action-menu button:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .action-menu button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .action-menu button:not(:last-child) {
            border-bottom: 1px solid #eee;
        }

        /* Sticky status and action columns */
        th:nth-last-child(-n+2),
        td:nth-last-child(-n+2) {
            position: sticky;
            z-index: 10;
        }

        /* Keep header cells above data cells */
        th:nth-last-child(-n+2) {
            background: #ff6b35;
            z-index: 20;
        }

        /* Data cells need white background */
        td:nth-last-child(-n+2) {
            background: white;
        }

        th:nth-last-child(2),
        td:nth-last-child(2) {
            right: 60px;
            box-shadow: -2px 0 4px rgba(0,0,0,0.05);
        }

        th:last-child,
        td:last-child {
            right: 0;
            box-shadow: -2px 0 4px rgba(0,0,0,0.1);
        }

        .status-cell {
            min-width: 90px;
            text-align: center;
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .hide-mobile {
                display: none !important;
            }

            .admin-container {
                padding: 1rem;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .dashboard-header > div {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .filters {
                flex-direction: column;
                gap: 0.75rem;
            }

            .filter-group {
                width: 100%;
            }

            .filter-group input,
            .filter-group select {
                width: 100%;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }

            .order-number {
                font-size: 0.75rem;
                min-width: 60px;
            }

            .order-date {
                font-size: 0.75rem;
                min-width: 50px;
            }

            .status-badge {
                font-size: 0.7rem;
                padding: 0.25rem 0.4rem;
            }

            .btn-dropdown {
                padding: 0.25rem 0.4rem;
                font-size: 1rem;
            }

            th:nth-last-child(2),
            td:nth-last-child(2) {
                right: 50px;
            }

            th:last-child,
            td:last-child {
                min-width: 50px;
            }
        }

        /* Tablet responsive styles */
        @media (max-width: 1024px) and (min-width: 769px) {
            .hide-tablet {
                display: none !important;
            }

            .admin-container {
                padding: 1.5rem;
            }

            table {
                font-size: 0.9rem;
            }

            th, td {
                padding: 0.6rem 0.4rem;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .admin-container {
                padding: 0.5rem;
            }

            .dashboard-header h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 0.75rem;
            }

            table {
                font-size: 0.75rem;
            }

            th, td {
                padding: 0.4rem 0.2rem;
            }

            .order-number {
                font-size: 0.7rem;
                min-width: 55px;
            }

            .order-date {
                font-size: 0.7rem;
                min-width: 45px;
            }

            .status-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.3rem;
            }

            th:nth-last-child(2),
            td:nth-last-child(2) {
                right: 45px;
            }

            th:last-child,
            td:last-child {
                min-width: 45px;
            }

            .btn-dropdown {
                padding: 0.2rem 0.35rem;
                font-size: 0.9rem;
            }
        }

        th:last-child {
            background: #ff6b35;
            z-index: 2;
        }

        tr:hover td:last-child {
            background: #f8f9fa;
        }

        .btn-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .no-orders {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .order-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #ff6b35;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 500;
            color: #333;
        }

        .detail-value {
            color: #666;
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="container" style="display: flex; align-items: center; justify-content: space-between; gap: 2rem;">
            <a href="../index.html" style="text-decoration: none; display: flex; flex-direction: column; padding: 0.75rem 0;">
                <span style="font-size: 1.5rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); line-height: 1;">GUIDAL</span>
                <span style="font-size: 0.7rem; color: white; opacity: 0.85; margin-top: 0.15rem;">at Alella Green Tech</span>
            </a>
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <a href="pumpkin-orders.html" style="color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border-radius: 4px;">
                    🎃 Orders
                </a>
                <a href="email-templates.html" style="color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem;">
                    📧 Templates
                </a>
                <a href="../pages/profile.html" style="color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem;">
                    👤 Profile
                </a>
                <span id="userEmail" style="color: white; font-size: 0.9rem; opacity: 0.8;"></span>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <div class="dashboard-header">
            <div>
                <h1>🎃 Pumpkin Patch Orders</h1>
                <p style="color: #666;">Manage and track all orders</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <a href="notification-settings.html" class="btn btn-primary" style="text-decoration: none; display: flex; align-items: center;">
                    📧 Notification Settings
                </a>
                <button class="btn btn-success" onclick="exportToCSV()">
                    📊 Export to CSV
                </button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">-</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">€0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingPayments">-</div>
                <div class="stat-label">Pending Payments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="paidOrders">-</div>
                <div class="stat-label">Paid Orders</div>
            </div>
        </div>

        <!-- Event Summary Cards -->
        <div class="stats-grid" style="margin-bottom: 2rem;">
            <div class="stat-card" style="background: linear-gradient(135deg, #ff6b35, #ff8c42); color: white;">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">🎃 Oct 25th Maxi-Party</div>
                <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 1rem;">
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="oct25Adults">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Adults</div>
                    </div>
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="oct25Children">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Children</div>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #ff8c42, #ffa500); color: white;">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">🎃 Nov 1st Mini-Party</div>
                <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 1rem;">
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="nov1Adults">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Adults</div>
                    </div>
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="nov1Children">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Children</div>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #28a745, #5cb85c); color: white;">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">👨👶 Visit Passes</div>
                <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 1rem;">
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="visitTotal">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Visitors</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>Search</label>
                <input type="text" id="searchInput" placeholder="Name, email, order #...">
            </div>
            <div class="filter-group">
                <label>Payment Status</label>
                <select id="statusFilter">
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date From</label>
                <input type="date" id="dateFrom">
            </div>
            <div class="filter-group">
                <label>Date To</label>
                <input type="date" id="dateTo">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" onclick="loadOrders()">Apply Filters</button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-table">
            <div id="loadingState" class="loading">
                Loading orders...
            </div>
            <div id="noOrdersState" class="no-orders" style="display: none;">
                No orders found
            </div>
            <table id="ordersTable" style="display: none;">
                <thead>
                    <tr>
                        <th style="cursor: pointer;" onclick="sortByStatus()">
                            Status <span id="statusSortIcon">↕️</span>
                        </th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th class="hide-mobile">Email</th>
                        <th class="hide-mobile">Party Date</th>
                        <th class="hide-tablet">Adults</th>
                        <th class="hide-tablet">Children</th>
                        <th class="hide-mobile">Items</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" class="order-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Order Details</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Order details will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Email Preview Modal -->
    <div id="emailPreviewModal" class="order-details-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>📧 Email Preview</h2>
                <button class="close-modal" onclick="closeEmailPreview()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 5px 0;"><strong>To:</strong> <span id="previewEmailTo"></span></p>
                    <p style="margin: 5px 0;">
                        <strong>Subject:</strong>
                        <span id="previewEmailSubjectDisplay"></span>
                        <input type="text" id="previewEmailSubjectEdit" style="display: none; width: 100%; padding: 0.5rem; border: 2px solid #ff6b35; border-radius: 4px; font-size: 1rem; margin-top: 0.5rem;">
                    </p>
                </div>
                <iframe id="emailPreviewFrame" style="width: 100%; height: 500px; border: 1px solid #ddd; border-radius: 8px; background: white;"></iframe>
                <div id="emailEditContainer" style="display: none;">
                    <div id="emailBodyEdit" contenteditable="true" style="width: 100%; min-height: 500px; border: 2px solid #ff6b35; border-radius: 8px; padding: 20px; background: white; overflow-y: auto;"></div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem; justify-content: flex-end;">
                    <button id="editEmailBtn" class="btn btn-primary" onclick="toggleEmailEdit()">✏️ Edit Email</button>
                    <button id="sendEditedEmailBtn" class="btn btn-success" style="display: none;" onclick="sendEditedEmail()">📧 Send Email</button>
                    <button id="cancelEditBtn" class="btn" style="display: none; background: #6c757d; color: white;" onclick="cancelEmailEdit()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Email Modal -->
    <div id="sendEmailModal" class="order-details-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>📧 Send Email</h2>
                <button class="close-modal" onclick="closeSendEmailModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p style="margin-bottom: 1.5rem;">Select an email template to send to the customer:</p>
                <select id="sendEmailTemplateSelect" style="width: 100%; padding: 0.75rem; border: 2px solid #ff6b35; border-radius: 4px; font-size: 1rem; margin-bottom: 1.5rem;">
                    <option value="entrance_ticket">🎃 Party Entrance Ticket</option>
                    <option value="visit_pass">🎟️ Visit Pass Confirmation</option>
                </select>
                <button class="btn btn-primary" onclick="sendEmailFromModal()" style="width: 100%; padding: 0.75rem; font-size: 1rem;">
                    📧 Send Email
                </button>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: #666; text-align: center;">
                    <em>Note: Entrance ticket email is auto-sent when marking order as PAID</em>
                </p>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Alella Green Tech Foundation. <a href="../index.html">Back to GUIDAL</a></p>
        </div>
    </footer>

    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>

    <script>
        let allOrders = [];
        let statusSortOrder = 'none'; // 'none', 'asc', 'desc'

        // Load orders on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is admin
            const { data: { user } } = await window.supabaseClient.auth.getUser();

            if (!user) {
                alert('⚠️ Please log in as admin to access this page');
                window.location.href = '../pages/auth/login.html';
                return;
            }

            // Check if user is admin
            const { data: profile } = await window.supabaseClient
                .from('profiles')
                .select('user_type')
                .eq('id', user.id)
                .single();

            if (!profile || profile.user_type !== 'admin') {
                alert('⚠️ Admin access required');
                window.location.href = '../index.html';
                return;
            }

            // Display user email in nav
            document.getElementById('userEmail').textContent = user.email;

            await loadOrders();
        });

        // Logout function
        async function logout() {
            const { error } = await window.supabaseClient.auth.signOut();
            if (error) {
                console.error('Logout error:', error);
                alert('Error logging out');
            } else {
                window.location.href = '../index.html';
            }
        }

        async function loadOrders() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('ordersTable').style.display = 'none';
                document.getElementById('noOrdersState').style.display = 'none';

                // Get filter values
                const search = document.getElementById('searchInput').value.toLowerCase();
                const status = document.getElementById('statusFilter').value;
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;

                // Fetch orders with items
                let query = window.supabaseClient
                    .from('pumpkin_patch_orders')
                    .select(`
                        *,
                        items:pumpkin_patch_order_items(*)
                    `)
                    .order('created_at', { ascending: false });

                const { data: orders, error } = await query;

                if (error) throw error;

                // Fetch email logs for all orders
                const orderIds = orders.map(o => o.id);
                const { data: emailLogs } = await window.supabaseClient
                    .from('pumpkin_patch_email_log')
                    .select('order_id, template_type, sent_at, status')
                    .in('order_id', orderIds)
                    .eq('status', 'sent');

                // Attach email logs to orders
                orders.forEach(order => {
                    order.email_logs = emailLogs?.filter(log => log.order_id === order.id) || [];
                });

                // Apply backend filters on the orders array
                let filteredOrders = orders;
                if (status !== 'all') {
                    filteredOrders = filteredOrders.filter(order => order.payment_status === status);
                }
                if (dateFrom) {
                    filteredOrders = filteredOrders.filter(order => order.created_at >= dateFrom);
                }
                if (dateTo) {
                    filteredOrders = filteredOrders.filter(order => order.created_at <= dateTo + 'T23:59:59');
                }

                // Apply search filter
                allOrders = filteredOrders.filter(order => {
                    if (!search) return true;
                    return (
                        order.first_name.toLowerCase().includes(search) ||
                        order.last_name.toLowerCase().includes(search) ||
                        order.email.toLowerCase().includes(search) ||
                        order.order_number.toLowerCase().includes(search)
                    );
                });

                displayOrders(allOrders);
                updateStatistics(allOrders);

                document.getElementById('loadingState').style.display = 'none';

            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('loadingState').innerHTML =
                    '<p style="color: red;">Error loading orders: ' + error.message + '</p>';
            }
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('ordersBody');

            if (orders.length === 0) {
                document.getElementById('noOrdersState').style.display = 'block';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td class="status-cell">
                        <span class="status-badge status-${order.payment_status}">
                            ${order.payment_status}
                        </span>
                    </td>
                    <td class="order-date">
                        ${new Date(order.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}<br>
                        <small class="hide-mobile">${new Date(order.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>
                    </td>
                    <td>
                        <strong>${order.first_name} ${order.last_name}</strong>
                        ${order.email_logs && order.email_logs.length > 0
                            ? `<span class="email-indicator" title="Confirmation email sent: ${new Date(order.email_logs[0].sent_at).toLocaleString()}">✉️</span>`
                            : `<span class="email-indicator no-email" title="No confirmation email sent">✉️</span>`
                        }
                    </td>
                    <td class="hide-mobile">${order.email}</td>
                    <td class="hide-mobile">${order.party_date ? `
                        <strong style="color: #ff6b35;">🎃 ${new Date(order.party_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</strong>
                    ` : '<span style="color: #999;">-</span>'}</td>
                    <td class="hide-tablet"><strong>${order.items.filter(item => item.item_name.includes('Adult')).reduce((sum, item) => sum + item.quantity, 0)}</strong></td>
                    <td class="hide-tablet"><strong>${order.items.filter(item => item.item_name.includes('Child')).reduce((sum, item) => sum + item.quantity, 0)}</strong></td>
                    <td class="order-items hide-mobile">
                        ${order.items.map(item => {
                            // Shorten common item names - order matters!
                            let shortName = item.item_name
                                .replace('Individual SCARES (for food, activities, etc.)', 'SCARES')
                                .replace('Adult Entrance Party Ticket', 'Adult')
                                .replace('Child Entrance Party Ticket', 'Child')
                                .replace('Visit Pass (Adult or Child)', 'Pass')
                                .replace('Small Pumpkin', 'Sm Pmpkn')
                                .replace('Medium Pumpkin', 'Md Pmpkn')
                                .replace('Large Pumpkin', 'Lg Pmpkn')
                                .replace(' (5 SCARES)', '')
                                .replace(' (10 SCARES)', '')
                                .replace(' (15 SCARES)', '');
                            return `<div style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.quantity}× ${shortName}</div>`;
                        }).join('')}
                    </td>
                    <td><strong>€${order.total_amount}</strong></td>
                    <td class="action-buttons">
                        <div class="action-dropdown">
                            <button class="btn-dropdown" onclick="toggleActionMenu('${order.id}')">
                                ⋮
                            </button>
                            <div class="action-menu" id="menu-${order.id}">
                                <button onclick="viewOrder('${order.id}'); closeAllMenus();">
                                    👁️ View Details
                                </button>
                                ${order.status !== 'cancelled' ? `
                                    ${order.payment_status === 'pending' ? `
                                        <button onclick="markAsPaid('${order.id}'); closeAllMenus();">
                                            💰 Mark as Paid
                                        </button>
                                    ` : ''}
                                    <button onclick="showEmailModal('${order.id}'); closeAllMenus();">
                                        📧 Send Email
                                    </button>
                                    <button onclick="cancelOrder('${order.id}'); closeAllMenus();" style="color: #dc3545;">
                                        🗑️ Cancel Order
                                    </button>
                                ` : `
                                    <button disabled style="color: #999;">
                                        ❌ Order Cancelled
                                    </button>
                                `}
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('ordersTable').style.display = 'table';
        }

        function updateStatistics(orders) {
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);
            const pendingPayments = orders.filter(o => o.payment_status === 'pending').length;
            const paidOrders = orders.filter(o => o.payment_status === 'paid').length;

            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('totalRevenue').textContent = '€' + totalRevenue.toFixed(2);
            document.getElementById('pendingPayments').textContent = pendingPayments;
            document.getElementById('paidOrders').textContent = paidOrders;

            // Calculate event-specific totals
            let oct25Adults = 0, oct25Children = 0;
            let nov1Adults = 0, nov1Children = 0;
            let visitTotal = 0;

            orders.forEach(order => {
                if (order.party_date === '2025-10-25') {
                    oct25Adults += order.adult_count || 0;
                    oct25Children += order.child_count || 0;
                } else if (order.party_date === '2025-11-01') {
                    nov1Adults += order.adult_count || 0;
                    nov1Children += order.child_count || 0;
                }

                // Count visit passes (orders with visit items)
                const visitItems = order.items.filter(item =>
                    item.item_name.toLowerCase().includes('visit') ||
                    item.item_name.toLowerCase().includes('non-party')
                );
                visitTotal += visitItems.reduce((sum, item) => sum + item.quantity, 0);
            });

            document.getElementById('oct25Adults').textContent = oct25Adults;
            document.getElementById('oct25Children').textContent = oct25Children;
            document.getElementById('nov1Adults').textContent = nov1Adults;
            document.getElementById('nov1Children').textContent = nov1Children;
            document.getElementById('visitTotal').textContent = visitTotal;
        }

        async function viewOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            console.log('Order data:', order);
            console.log('Party date:', order.party_date);

            // Fetch email history for this order
            const { data: emailLogs, error: emailError } = await window.supabaseClient
                .from('pumpkin_patch_email_log')
                .select('*')
                .eq('order_id', orderId)
                .order('sent_at', { ascending: false });

            const emailHistory = emailLogs && emailLogs.length > 0 ? `
                <div style="margin: 1.5rem 0; padding-top: 1rem; border-top: 2px solid #ff6b35;">
                    <h3 style="margin-bottom: 1rem;">📧 Email History:</h3>
                    ${emailLogs.map(log => `
                        <div class="detail-row" style="background: ${log.status === 'sent' ? '#d4edda' : '#f8d7da'}; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                            <div>
                                <strong>${log.template_type.replace('_', ' ').toUpperCase()}</strong><br>
                                <small>Sent: ${new Date(log.sent_at).toLocaleString()}</small><br>
                                <small>Status: ${log.status === 'sent' ? '✅ Delivered' : '❌ Failed'}</small>
                                ${log.error_message ? `<br><small style="color: #721c24;">Error: ${log.error_message}</small>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '';

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Order Number:</span>
                    <span class="detail-value">${order.order_number}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span class="detail-value">${new Date(order.created_at).toLocaleString()}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Customer:</span>
                    <span class="detail-value">${order.first_name} ${order.last_name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${order.email}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${order.phone || 'N/A'}</span>
                </div>
                ${order.party_date ? `
                <div class="detail-row" style="background: #fff3cd; padding: 0.75rem; border-radius: 4px; border-left: 4px solid #ff6b35;">
                    <span class="detail-label">🎃 Party Date:</span>
                    <span class="detail-value" style="font-weight: bold; color: #ff6b35;">
                        ${new Date(order.party_date).toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        })}
                    </span>
                </div>
                ` : ''}
                <div class="detail-row">
                    <span class="detail-label">Adults:</span>
                    <span class="detail-value">${order.adult_count || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Children:</span>
                    <span class="detail-value">${order.child_count || 0}</span>
                </div>
                <div style="margin: 1.5rem 0; padding-top: 1rem; border-top: 2px solid #ff6b35;">
                    <h3 style="margin-bottom: 1rem;">Order Items:</h3>
                    ${order.items.map(item => {
                        const counts = [];
                        if (item.adult_count && item.adult_count > 0) counts.push(`${item.adult_count} adults`);
                        if (item.child_count && item.child_count > 0) counts.push(`${item.child_count} children`);
                        const countStr = counts.length > 0 ? `<br><small style="color: #666;">${counts.join(', ')}</small>` : '';
                        return `
                        <div class="detail-row">
                            <span class="detail-label">${item.quantity}x ${item.item_name}${countStr}</span>
                            <span class="detail-value">€${item.total_price}</span>
                        </div>
                        `;
                    }).join('')}
                </div>
                <div class="detail-row" style="border-top: 2px solid #ff6b35; padding-top: 1rem; font-weight: bold; font-size: 1.2rem;">
                    <span class="detail-label">Total:</span>
                    <span class="detail-value" style="color: #ff6b35;">€${order.total_amount}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Status:</span>
                    <span class="status-badge status-${order.payment_status}">${order.payment_status}</span>
                </div>
                ${order.notes ? `
                    <div class="detail-row">
                        <span class="detail-label">Notes:</span>
                        <span class="detail-value">${order.notes}</span>
                    </div>
                ` : ''}
                ${emailHistory}
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #eee; display: flex; gap: 1rem; align-items: center;">
                    <select id="emailTemplateSelect" style="flex: 1; padding: 0.75rem; border: 2px solid #ff6b35; border-radius: 4px; font-size: 1rem;">
                        <option value="entrance_ticket">🎃 Party Entrance Ticket</option>
                        <option value="visit_pass">🎟️ Visit Pass Confirmation</option>
                    </select>
                    <button class="btn btn-primary" onclick="sendEmailToOrder('${order.id}')" style="padding: 0.75rem 2rem;">
                        📧 Send Email
                    </button>
                </div>
            `;

            document.getElementById('orderModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        async function sendEmailToOrder(orderId) {
            const templateType = document.getElementById('emailTemplateSelect').value;

            if (!confirm(`Send ${templateType.replace('_', ' ')} email to customer?`)) return;

            try {
                const order = allOrders.find(o => o.id === orderId);
                if (!order) throw new Error('Order not found');

                // Get the selected template
                const { data: template, error: templateError } = await window.supabaseClient
                    .from('pumpkin_patch_email_templates')
                    .select('*')
                    .eq('template_type', templateType)
                    .eq('is_active', true)
                    .single();

                if (templateError) throw new Error('Template not found: ' + templateError.message);

                // Generate QR code
                const scares = order.items.find(item => item.item_name.includes('SCARE'))?.quantity || 0;
                const partyDateFormatted = order.party_date ?
                    new Date(order.party_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) :
                    'Visit Pass';

                const qrData = `ORDER:${order.order_number}|NAME:${order.first_name} ${order.last_name}|ADULTS:${order.adult_count || 0}|CHILDREN:${order.child_count || 0}|EVENT:${partyDateFormatted}|SCARES:${scares}|TOTAL:€${order.total_amount}`;
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}`;

                // Format data for template
                let partyDateForEmail = 'Visit Pass (any non-party day)';
                if (order.party_date) {
                    const date = new Date(order.party_date);
                    partyDateForEmail = date.toLocaleDateString('en-US', {
                        month: 'long',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }

                const itemsList = order.items.map(item =>
                    `${item.quantity}x ${item.item_name}`
                ).join('<br>');

                const emailData = {
                    '{{order_number}}': order.order_number,
                    '{{first_name}}': order.first_name,
                    '{{last_name}}': order.last_name,
                    '{{email}}': order.email,
                    '{{phone}}': order.phone || 'Not provided',
                    '{{party_date}}': partyDateForEmail,
                    '{{adult_count}}': order.adult_count || 0,
                    '{{child_count}}': order.child_count || 0,
                    '{{items}}': itemsList,
                    '{{total_amount}}': order.total_amount.toFixed(2),
                    '{{qr_code}}': qrCodeUrl
                };

                let emailBody = template.html_body;
                let emailSubject = template.subject;

                Object.entries(emailData).forEach(([key, value]) => {
                    emailBody = emailBody.replaceAll(key, value);
                    emailSubject = emailSubject.replaceAll(key, value);
                });

                // Call Edge Function to send email via Resend
                const { data: { session } } = await window.supabaseClient.auth.getSession();

                const functionResponse = await fetch(
                    `${window.supabaseClient.supabaseUrl}/functions/v1/send-pumpkin-email`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            orderId: orderId,
                            templateType: templateType
                        })
                    }
                );

                const result = await functionResponse.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to send email');
                }

                alert(`✅ Email sent successfully to ${order.email}\n\nResend ID: ${result.resendId}`);

                // Refresh the order details to show new email in history
                closeModal();
                await viewOrder(orderId);

            } catch (error) {
                console.error('Error sending email:', error);
                alert('❌ Failed to send email: ' + error.message);
            }
        }

        async function markAsPaid(orderId) {
            if (!confirm('Mark this order as paid and send confirmation email?')) return;

            try {
                // Update payment status and order status
                const { error: updateError } = await window.supabaseClient
                    .from('pumpkin_patch_orders')
                    .update({
                        payment_status: 'paid',
                        status: 'paid',
                        paid_at: new Date().toISOString()
                    })
                    .eq('id', orderId);

                if (updateError) throw updateError;

                // Send confirmation email
                await sendConfirmationEmail(orderId);

                // Send admin notification for order_paid
                await sendAdminNotification(orderId, 'order_paid');

                alert('✅ Order marked as paid and confirmation email sent!');
                await loadOrders();

            } catch (error) {
                console.error('Error updating order:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        async function sendConfirmationEmail(orderId) {
            try {
                // Get order details
                const { data: order, error: orderError } = await window.supabaseClient
                    .from('pumpkin_patch_orders')
                    .select('*')
                    .eq('id', orderId)
                    .single();

                if (orderError) throw orderError;

                // Get order items separately
                const { data: items, error: itemsError } = await window.supabaseClient
                    .from('pumpkin_patch_order_items')
                    .select('*')
                    .eq('order_id', orderId);

                if (itemsError) throw itemsError;

                // Determine template type based on order items
                const hasEntranceTicket = items.some(item =>
                    item.item_name.includes('Adult') || item.item_name.includes('Child')
                );
                const templateType = hasEntranceTicket ? 'entrance_ticket' : 'visit_pass';

                // Call Edge Function to send email via Resend
                const { data: { session } } = await window.supabaseClient.auth.getSession();

                const functionResponse = await fetch(
                    `${window.supabaseClient.supabaseUrl}/functions/v1/send-pumpkin-email`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            orderId: orderId,
                            templateType: templateType
                        })
                    }
                );

                const result = await functionResponse.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to send email');
                }

                console.log('✅ Email sent successfully via Resend');
                console.log('Resend ID:', result.resendId);

            } catch (error) {
                console.error('Error sending confirmation email:', error);
                throw error;
            }
        }

        function exportToCSV() {
            if (allOrders.length === 0) {
                alert('No orders to export');
                return;
            }

            // Create CSV content
            const headers = ['Order Number', 'Date', 'First Name', 'Last Name', 'Email', 'Phone', 'Party Date', 'Adults', 'Children', 'Items', 'Total Amount', 'Payment Status'];
            const rows = allOrders.map(order => [
                order.order_number,
                new Date(order.created_at).toLocaleString(),
                order.first_name,
                order.last_name,
                order.email,
                order.phone || '',
                order.party_date || 'N/A',
                order.adult_count || 0,
                order.child_count || 0,
                order.items.map(item => `${item.quantity}x ${item.item_name}`).join('; '),
                order.total_amount,
                order.payment_status
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pumpkin-orders-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            alert('✅ CSV exported successfully!');
        }

        async function previewEmail(orderId) {
            try {
                // Get order details
                const { data: order, error: orderError } = await window.supabaseClient
                    .from('pumpkin_patch_orders')
                    .select('*, items:pumpkin_patch_order_items(*)')
                    .eq('id', orderId)
                    .single();

                if (orderError) throw orderError;

                // Determine template type based on order items
                const hasEntranceTicket = order.items.some(item =>
                    item.item_name.includes('Adult') || item.item_name.includes('Child')
                );
                const templateType = hasEntranceTicket ? 'entrance_ticket' : 'visit_pass';

                // Get active template for this type
                const { data: template, error: templateError } = await window.supabaseClient
                    .from('pumpkin_patch_email_templates')
                    .select('*')
                    .eq('template_type', templateType)
                    .eq('is_active', true)
                    .single();

                if (templateError) {
                    alert('⚠️ No active email template found for this order type');
                    return;
                }

                // Generate QR code data
                const scares = order.items.find(item => item.item_name.includes('SCARE'))?.quantity || 0;
                const partyDateFormatted = order.party_date ?
                    new Date(order.party_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) :
                    'Visit Pass';

                const qrData = `ORDER:${order.order_number}|NAME:${order.first_name} ${order.last_name}|ADULTS:${order.adult_count || 0}|CHILDREN:${order.child_count || 0}|EVENT:${partyDateFormatted}|SCARES:${scares}|TOTAL:€${order.total_amount}`;
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}`;

                // Format party date for email
                let partyDateForEmail = 'Visit Pass (any non-party day)';
                if (order.party_date) {
                    const date = new Date(order.party_date);
                    partyDateForEmail = date.toLocaleDateString('en-US', {
                        month: 'long',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }

                // Format items list for email
                const itemsList = order.items.map(item =>
                    `${item.quantity}x ${item.item_name}`
                ).join('<br>');

                // Replace variables in template
                const emailData = {
                    '{{order_number}}': order.order_number,
                    '{{first_name}}': order.first_name,
                    '{{last_name}}': order.last_name,
                    '{{email}}': order.email,
                    '{{phone}}': order.phone || 'Not provided',
                    '{{party_date}}': partyDateForEmail,
                    '{{adult_count}}': order.adult_count || 0,
                    '{{child_count}}': order.child_count || 0,
                    '{{items}}': itemsList,
                    '{{total_amount}}': order.total_amount.toFixed(2),
                    '{{qr_code}}': qrCodeUrl
                };

                let emailBody = template.html_body;
                let emailSubject = template.subject;

                Object.entries(emailData).forEach(([key, value]) => {
                    emailBody = emailBody.replaceAll(key, value);
                    emailSubject = emailSubject.replaceAll(key, value);
                });

                // Store current email data for editing
                window.currentEmailData = {
                    orderId: orderId,
                    to: order.email,
                    subject: emailSubject,
                    body: emailBody,
                    templateType: templateType
                };

                // Display preview
                document.getElementById('previewEmailTo').textContent = order.email;
                document.getElementById('previewEmailSubjectDisplay').textContent = emailSubject;
                document.getElementById('previewEmailSubjectEdit').value = emailSubject;

                const previewFrame = document.getElementById('emailPreviewFrame');
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                previewDoc.open();
                previewDoc.write(emailBody);
                previewDoc.close();

                // Reset to preview mode
                document.getElementById('emailPreviewFrame').style.display = 'block';
                document.getElementById('emailEditContainer').style.display = 'none';
                document.getElementById('previewEmailSubjectDisplay').style.display = 'inline';
                document.getElementById('previewEmailSubjectEdit').style.display = 'none';
                document.getElementById('editEmailBtn').style.display = 'inline-block';
                document.getElementById('sendEditedEmailBtn').style.display = 'none';
                document.getElementById('cancelEditBtn').style.display = 'none';

                document.getElementById('emailPreviewModal').style.display = 'flex';
            } catch (error) {
                console.error('Error previewing email:', error);
                alert('Failed to preview email: ' + error.message);
            }
        }

        function closeEmailPreview() {
            document.getElementById('emailPreviewModal').style.display = 'none';
        }

        function toggleEmailEdit() {
            // Switch to edit mode
            document.getElementById('emailPreviewFrame').style.display = 'none';
            document.getElementById('emailEditContainer').style.display = 'block';
            document.getElementById('previewEmailSubjectDisplay').style.display = 'none';
            document.getElementById('previewEmailSubjectEdit').style.display = 'block';
            document.getElementById('editEmailBtn').style.display = 'none';
            document.getElementById('sendEditedEmailBtn').style.display = 'inline-block';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';

            // Load current body into editable div
            document.getElementById('emailBodyEdit').innerHTML = window.currentEmailData.body;
        }

        function cancelEmailEdit() {
            // Switch back to preview mode
            document.getElementById('emailPreviewFrame').style.display = 'block';
            document.getElementById('emailEditContainer').style.display = 'none';
            document.getElementById('previewEmailSubjectDisplay').style.display = 'inline';
            document.getElementById('previewEmailSubjectEdit').style.display = 'none';
            document.getElementById('editEmailBtn').style.display = 'inline-block';
            document.getElementById('sendEditedEmailBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';

            // Reset to original values
            document.getElementById('previewEmailSubjectEdit').value = window.currentEmailData.subject;
            document.getElementById('emailBodyEdit').innerHTML = window.currentEmailData.body;
        }

        async function sendEditedEmail() {
            if (!window.currentEmailData) {
                alert('Error: No email data available');
                return;
            }

            const editedSubject = document.getElementById('previewEmailSubjectEdit').value;
            const editedBody = document.getElementById('emailBodyEdit').innerHTML;

            if (!confirm(`Send this edited email to ${window.currentEmailData.to}?`)) return;

            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();

                const functionResponse = await fetch(
                    `${window.supabaseClient.supabaseUrl}/functions/v1/send-pumpkin-email`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            orderId: window.currentEmailData.orderId,
                            templateType: window.currentEmailData.templateType,
                            customSubject: editedSubject,
                            customBody: editedBody
                        })
                    }
                );

                const result = await functionResponse.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to send email');
                }

                alert(`✅ Email sent successfully to ${window.currentEmailData.to}\n\nResend ID: ${result.resendId}`);

                // Close modal and reload orders to show email indicator
                closeEmailPreview();
                await loadOrders();

            } catch (error) {
                console.error('Error sending email:', error);
                alert('❌ Failed to send email: ' + error.message);
            }
        }

        let currentEmailOrderId = null;

        function showEmailModal(orderId) {
            currentEmailOrderId = orderId;
            const order = allOrders.find(o => o.id === orderId);

            // Auto-select the appropriate template based on order type
            const hasEntranceTicket = order.items.some(item =>
                item.item_name.includes('Adult') || item.item_name.includes('Child')
            );
            const templateSelect = document.getElementById('sendEmailTemplateSelect');
            templateSelect.value = hasEntranceTicket ? 'entrance_ticket' : 'visit_pass';

            document.getElementById('sendEmailModal').style.display = 'flex';
        }

        function closeSendEmailModal() {
            document.getElementById('sendEmailModal').style.display = 'none';
            currentEmailOrderId = null;
        }

        async function sendEmailFromModal() {
            const templateType = document.getElementById('sendEmailTemplateSelect').value;

            if (!currentEmailOrderId) {
                alert('Error: No order selected');
                return;
            }

            if (!confirm(`Send ${templateType.replace('_', ' ')} email to customer?`)) return;

            try {
                const order = allOrders.find(o => o.id === currentEmailOrderId);
                if (!order) throw new Error('Order not found');

                // Call Edge Function to send email via Resend
                const { data: { session } } = await window.supabaseClient.auth.getSession();

                const functionResponse = await fetch(
                    `${window.supabaseClient.supabaseUrl}/functions/v1/send-pumpkin-email`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            orderId: currentEmailOrderId,
                            templateType: templateType
                        })
                    }
                );

                const result = await functionResponse.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to send email');
                }

                alert(`✅ Email sent successfully to ${order.email}\n\nResend ID: ${result.resendId}`);

                // Close modal
                closeSendEmailModal();

            } catch (error) {
                console.error('Error sending email:', error);
                alert('❌ Failed to send email: ' + error.message);
            }
        }

        // Close modal when clicking outside
        document.getElementById('orderModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('emailPreviewModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmailPreview();
            }
        });

        document.getElementById('sendEmailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSendEmailModal();
            }
        });

        // Send admin notification
        async function sendAdminNotification(orderId, notificationType) {
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();

                const functionUrl = `${window.supabaseClient.supabaseUrl}/functions/v1/send-admin-notification`;

                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        notificationType: notificationType
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('✅ Admin notification sent:', notificationType, result.message);
                } else {
                    console.warn('⚠️ Admin notification failed:', result.error);
                }
            } catch (error) {
                console.error('❌ Error sending admin notification:', error);
                // Don't fail the operation if notification fails
            }
        }

        // Toggle action menu dropdown
        function toggleActionMenu(orderId) {
            const menu = document.getElementById(`menu-${orderId}`);
            const isCurrentlyOpen = menu.classList.contains('show');

            // Close all other menus first
            closeAllMenus();

            // Toggle this menu
            if (!isCurrentlyOpen) {
                menu.classList.add('show');
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.action-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.action-dropdown')) {
                closeAllMenus();
            }
        });

        // Cancel order function
        async function cancelOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                alert('Order not found');
                return;
            }

            if (order.status === 'cancelled') {
                alert('This order is already cancelled');
                return;
            }

            const confirmMessage = order.payment_status === 'paid'
                ? `Cancel this PAID order?\n\nOrder: ${order.order_number}\nCustomer: ${order.first_name} ${order.last_name}\nAmount: €${order.total_amount}\n\n⚠️ This will:\n- Mark the order as cancelled\n- Subtract €${order.total_amount} from total revenue\n- Send a cancellation email to the customer`
                : `Cancel this order?\n\nOrder: ${order.order_number}\nCustomer: ${order.first_name} ${order.last_name}\nAmount: €${order.total_amount}\n\nThis will send a cancellation email to the customer.`;

            if (!confirm(confirmMessage)) return;

            try {
                // Update order status to cancelled
                const { error: updateError } = await window.supabaseClient
                    .from('pumpkin_patch_orders')
                    .update({
                        status: 'cancelled',
                        payment_status: 'refunded',
                        cancelled_at: new Date().toISOString()
                    })
                    .eq('id', orderId);

                if (updateError) throw updateError;

                // Send cancellation email
                await sendCancellationEmail(orderId);

                alert('✅ Order cancelled successfully! Cancellation email sent to customer.');
                await loadOrders();

            } catch (error) {
                console.error('Error cancelling order:', error);
                alert('❌ Error cancelling order: ' + error.message);
            }
        }

        // Send cancellation email
        async function sendCancellationEmail(orderId) {
            try {
                const { data: { session } } = await window.supabaseClient.auth.getSession();

                const functionResponse = await fetch(
                    `${window.supabaseClient.supabaseUrl}/functions/v1/send-pumpkin-email`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            orderId: orderId,
                            templateType: 'cancellation'
                        })
                    }
                );

                const result = await functionResponse.json();

                if (!result.success) {
                    console.warn('Failed to send cancellation email:', result.error);
                }
            } catch (error) {
                console.error('Error sending cancellation email:', error);
                // Don't fail the cancellation if email fails
            }
        }

        // Sort by status
        function sortByStatus() {
            const statusOrder = {
                'pending': 1,
                'confirmed': 2,
                'paid': 3,
                'completed': 4,
                'cancelled': 5,
                'refunded': 6
            };

            if (statusSortOrder === 'none' || statusSortOrder === 'desc') {
                // Sort ascending
                statusSortOrder = 'asc';
                allOrders.sort((a, b) => {
                    const statusA = statusOrder[a.payment_status] || 999;
                    const statusB = statusOrder[b.payment_status] || 999;
                    return statusA - statusB;
                });
                document.getElementById('statusSortIcon').textContent = '↑';
            } else {
                // Sort descending
                statusSortOrder = 'desc';
                allOrders.sort((a, b) => {
                    const statusA = statusOrder[a.payment_status] || 999;
                    const statusB = statusOrder[b.payment_status] || 999;
                    return statusB - statusA;
                });
                document.getElementById('statusSortIcon').textContent = '↓';
            }

            displayOrders(allOrders);
        }
    </script>
</body>
</html>
