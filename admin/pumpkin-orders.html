<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pumpkin Patch Orders - Admin Dashboard</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #ff6b35;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b35;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 500;
            font-size: 0.9rem;
            color: #333;
        }

        .filter-group input,
        .filter-group select {
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #ff6b35;
            color: white;
        }

        .btn-primary:hover {
            background: #e55a28;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .orders-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #ff6b35;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .order-items {
            font-size: 0.9rem;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .no-orders {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .order-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #ff6b35;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 500;
            color: #333;
        }

        .detail-value {
            color: #666;
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="container" style="display: flex; align-items: center; justify-content: space-between; gap: 2rem;">
            <a href="../index.html" style="text-decoration: none; display: flex; flex-direction: column; padding: 0.75rem 0;">
                <span style="font-size: 1.5rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); line-height: 1;">GUIDAL</span>
                <span style="font-size: 0.7rem; color: white; opacity: 0.85; margin-top: 0.15rem;">at Alella Green Tech</span>
            </a>
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <a href="pumpkin-orders.html" style="color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border-radius: 4px;">
                    🎃 Orders
                </a>
                <a href="email-templates.html" style="color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem;">
                    📧 Templates
                </a>
                <a href="../pages/profile.html" style="color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem;">
                    👤 Profile
                </a>
                <span id="userEmail" style="color: white; font-size: 0.9rem; opacity: 0.8;"></span>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <div class="dashboard-header">
            <div>
                <h1>🎃 Pumpkin Patch Orders</h1>
                <p style="color: #666;">Manage and track all orders</p>
            </div>
            <button class="btn btn-success" onclick="exportToCSV()">
                📊 Export to CSV
            </button>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">-</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">€0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingPayments">-</div>
                <div class="stat-label">Pending Payments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="paidOrders">-</div>
                <div class="stat-label">Paid Orders</div>
            </div>
        </div>

        <!-- Event Summary Cards -->
        <div class="stats-grid" style="margin-bottom: 2rem;">
            <div class="stat-card" style="background: linear-gradient(135deg, #ff6b35, #ff8c42); color: white;">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">🎃 Oct 25th Maxi-Party</div>
                <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 1rem;">
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="oct25Adults">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Adults</div>
                    </div>
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="oct25Children">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Children</div>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #ff8c42, #ffa500); color: white;">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">🎃 Nov 1st Mini-Party</div>
                <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 1rem;">
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="nov1Adults">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Adults</div>
                    </div>
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="nov1Children">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Children</div>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #28a745, #5cb85c); color: white;">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">👨👶 Visit Passes</div>
                <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 1rem;">
                    <div>
                        <div style="font-size: 1.8rem; font-weight: bold;" id="visitTotal">-</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Total Visitors</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>Search</label>
                <input type="text" id="searchInput" placeholder="Name, email, order #...">
            </div>
            <div class="filter-group">
                <label>Payment Status</label>
                <select id="statusFilter">
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date From</label>
                <input type="date" id="dateFrom">
            </div>
            <div class="filter-group">
                <label>Date To</label>
                <input type="date" id="dateTo">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" onclick="loadOrders()">Apply Filters</button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-table">
            <div id="loadingState" class="loading">
                Loading orders...
            </div>
            <div id="noOrdersState" class="no-orders" style="display: none;">
                No orders found
            </div>
            <table id="ordersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Email</th>
                        <th>Party Date</th>
                        <th>Items</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" class="order-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Order Details</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Order details will be inserted here -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Alella Green Tech Foundation. <a href="../index.html">Back to GUIDAL</a></p>
        </div>
    </footer>

    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>

    <script>
        let allOrders = [];

        // Load orders on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is admin
            const { data: { user } } = await window.supabaseClient.auth.getUser();

            if (!user) {
                alert('⚠️ Please log in as admin to access this page');
                window.location.href = '../pages/auth/login.html';
                return;
            }

            // Check if user is admin
            const { data: profile } = await window.supabaseClient
                .from('profiles')
                .select('user_type')
                .eq('id', user.id)
                .single();

            if (!profile || profile.user_type !== 'admin') {
                alert('⚠️ Admin access required');
                window.location.href = '../index.html';
                return;
            }

            // Display user email in nav
            document.getElementById('userEmail').textContent = user.email;

            await loadOrders();
        });

        // Logout function
        async function logout() {
            const { error } = await window.supabaseClient.auth.signOut();
            if (error) {
                console.error('Logout error:', error);
                alert('Error logging out');
            } else {
                window.location.href = '../index.html';
            }
        }

        async function loadOrders() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('ordersTable').style.display = 'none';
                document.getElementById('noOrdersState').style.display = 'none';

                // Get filter values
                const search = document.getElementById('searchInput').value.toLowerCase();
                const status = document.getElementById('statusFilter').value;
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;

                // Fetch orders with items
                let query = window.supabaseClient
                    .from('pumpkin_patch_orders')
                    .select(`
                        *,
                        items:pumpkin_patch_order_items(*)
                    `)
                    .order('created_at', { ascending: false });

                // Apply filters
                if (status !== 'all') {
                    query = query.eq('payment_status', status);
                }
                if (dateFrom) {
                    query = query.gte('created_at', dateFrom);
                }
                if (dateTo) {
                    query = query.lte('created_at', dateTo + 'T23:59:59');
                }

                const { data: orders, error } = await query;

                if (error) throw error;

                // Apply search filter
                allOrders = orders.filter(order => {
                    if (!search) return true;
                    return (
                        order.first_name.toLowerCase().includes(search) ||
                        order.last_name.toLowerCase().includes(search) ||
                        order.email.toLowerCase().includes(search) ||
                        order.order_number.toLowerCase().includes(search)
                    );
                });

                displayOrders(allOrders);
                updateStatistics(allOrders);

                document.getElementById('loadingState').style.display = 'none';

            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('loadingState').innerHTML =
                    '<p style="color: red;">Error loading orders: ' + error.message + '</p>';
            }
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('ordersBody');

            if (orders.length === 0) {
                document.getElementById('noOrdersState').style.display = 'block';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${new Date(order.created_at).toLocaleDateString()}<br>
                        <small>${new Date(order.created_at).toLocaleTimeString()}</small>
                    </td>
                    <td>${order.first_name} ${order.last_name}</td>
                    <td>${order.email}</td>
                    <td>${order.party_date ? `
                        <strong style="color: #ff6b35;">🎃 ${new Date(order.party_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</strong>
                    ` : '<span style="color: #999;">-</span>'}</td>
                    <td class="order-items">
                        ${order.items.map(item =>
                            `${item.quantity}x ${item.item_name}`
                        ).join('<br>')}
                    </td>
                    <td><strong>€${order.total_amount}</strong></td>
                    <td>
                        <span class="status-badge status-${order.payment_status}">
                            ${order.payment_status}
                        </span>
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-small" onclick="viewOrder('${order.id}')">
                            View
                        </button>
                        ${order.payment_status === 'pending' ? `
                            <button class="btn btn-success btn-small" onclick="markAsPaid('${order.id}')">
                                Mark Paid
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');

            document.getElementById('ordersTable').style.display = 'table';
        }

        function updateStatistics(orders) {
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);
            const pendingPayments = orders.filter(o => o.payment_status === 'pending').length;
            const paidOrders = orders.filter(o => o.payment_status === 'paid').length;

            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('totalRevenue').textContent = '€' + totalRevenue.toFixed(2);
            document.getElementById('pendingPayments').textContent = pendingPayments;
            document.getElementById('paidOrders').textContent = paidOrders;

            // Calculate event-specific totals
            let oct25Adults = 0, oct25Children = 0;
            let nov1Adults = 0, nov1Children = 0;
            let visitTotal = 0;

            orders.forEach(order => {
                if (order.party_date === '2025-10-25') {
                    oct25Adults += order.adult_count || 0;
                    oct25Children += order.child_count || 0;
                } else if (order.party_date === '2025-11-01') {
                    nov1Adults += order.adult_count || 0;
                    nov1Children += order.child_count || 0;
                }

                // Count visit passes (orders with visit items)
                const visitItems = order.items.filter(item =>
                    item.item_name.toLowerCase().includes('visit') ||
                    item.item_name.toLowerCase().includes('non-party')
                );
                visitTotal += visitItems.reduce((sum, item) => sum + item.quantity, 0);
            });

            document.getElementById('oct25Adults').textContent = oct25Adults;
            document.getElementById('oct25Children').textContent = oct25Children;
            document.getElementById('nov1Adults').textContent = nov1Adults;
            document.getElementById('nov1Children').textContent = nov1Children;
            document.getElementById('visitTotal').textContent = visitTotal;
        }

        function viewOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            console.log('Order data:', order);
            console.log('Party date:', order.party_date);

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Order Number:</span>
                    <span class="detail-value">${order.order_number}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date:</span>
                    <span class="detail-value">${new Date(order.created_at).toLocaleString()}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Customer:</span>
                    <span class="detail-value">${order.first_name} ${order.last_name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${order.email}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${order.phone || 'N/A'}</span>
                </div>
                ${order.party_date ? `
                <div class="detail-row" style="background: #fff3cd; padding: 0.75rem; border-radius: 4px; border-left: 4px solid #ff6b35;">
                    <span class="detail-label">🎃 Party Date:</span>
                    <span class="detail-value" style="font-weight: bold; color: #ff6b35;">
                        ${new Date(order.party_date).toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        })}
                    </span>
                </div>
                ` : ''}
                <div class="detail-row">
                    <span class="detail-label">Adults:</span>
                    <span class="detail-value">${order.adult_count || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Children:</span>
                    <span class="detail-value">${order.child_count || 0}</span>
                </div>
                <div style="margin: 1.5rem 0; padding-top: 1rem; border-top: 2px solid #ff6b35;">
                    <h3 style="margin-bottom: 1rem;">Order Items:</h3>
                    ${order.items.map(item => `
                        <div class="detail-row">
                            <span class="detail-label">${item.quantity}x ${item.item_name}</span>
                            <span class="detail-value">€${item.total_price}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="detail-row" style="border-top: 2px solid #ff6b35; padding-top: 1rem; font-weight: bold; font-size: 1.2rem;">
                    <span class="detail-label">Total:</span>
                    <span class="detail-value" style="color: #ff6b35;">€${order.total_amount}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Payment Status:</span>
                    <span class="status-badge status-${order.payment_status}">${order.payment_status}</span>
                </div>
                ${order.notes ? `
                    <div class="detail-row">
                        <span class="detail-label">Notes:</span>
                        <span class="detail-value">${order.notes}</span>
                    </div>
                ` : ''}
            `;

            document.getElementById('orderModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        async function markAsPaid(orderId) {
            if (!confirm('Mark this order as paid and send confirmation email?')) return;

            try {
                // Update payment status
                const { error: updateError } = await window.supabaseClient
                    .from('pumpkin_patch_orders')
                    .update({
                        payment_status: 'paid',
                        paid_at: new Date().toISOString()
                    })
                    .eq('id', orderId);

                if (updateError) throw updateError;

                // Send confirmation email
                await sendConfirmationEmail(orderId);

                alert('✅ Order marked as paid and confirmation email sent!');
                await loadOrders();

            } catch (error) {
                console.error('Error updating order:', error);
                alert('❌ Error: ' + error.message);
            }
        }

        async function sendConfirmationEmail(orderId) {
            try {
                // Get order details
                const { data: order, error: orderError } = await window.supabaseClient
                    .from('pumpkin_patch_orders')
                    .select('*, items:pumpkin_patch_order_items(*)')
                    .eq('id', orderId)
                    .single();

                if (orderError) throw orderError;

                // Determine template type based on order items
                const hasEntranceTicket = order.items.some(item =>
                    item.item_name.includes('Adult') || item.item_name.includes('Child')
                );
                const templateType = hasEntranceTicket ? 'entrance_ticket' : 'visit_pass';

                // Get active template for this type
                const { data: template, error: templateError } = await window.supabaseClient
                    .from('pumpkin_patch_email_templates')
                    .select('*')
                    .eq('template_type', templateType)
                    .eq('is_active', true)
                    .single();

                if (templateError) {
                    console.warn('No active template found for type:', templateType);
                    return; // Don't fail the whole operation
                }

                // Generate QR code data
                const scares = order.items.find(item => item.item_name.includes('SCARE'))?.quantity || 0;
                const partyDateFormatted = order.party_date ?
                    new Date(order.party_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) :
                    'Visit Pass';

                const qrData = `ORDER:${order.order_number}|NAME:${order.first_name} ${order.last_name}|ADULTS:${order.adult_count || 0}|CHILDREN:${order.child_count || 0}|EVENT:${partyDateFormatted}|SCARES:${scares}|TOTAL:€${order.total_amount}`;
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrData)}`;

                // Replace variables in template
                const emailData = {
                    '{{order_number}}': order.order_number,
                    '{{first_name}}': order.first_name,
                    '{{last_name}}': order.last_name,
                    '{{email}}': order.email,
                    '{{phone}}': order.phone || 'Not provided',
                    '{{adult_count}}': order.adult_count || 0,
                    '{{child_count}}': order.child_count || 0,
                    '{{total_amount}}': order.total_amount.toFixed(2),
                    '{{qr_code}}': qrCodeUrl
                };

                let emailBody = template.html_body;
                let emailSubject = template.subject;

                Object.entries(emailData).forEach(([key, value]) => {
                    emailBody = emailBody.replaceAll(key, value);
                    emailSubject = emailSubject.replaceAll(key, value);
                });

                // Log the email (in production, you'd actually send it here via API)
                const { error: logError } = await window.supabaseClient
                    .from('pumpkin_patch_email_log')
                    .insert([{
                        order_id: orderId,
                        template_id: template.id,
                        recipient_email: order.email,
                        subject: emailSubject,
                        status: 'sent'
                    }]);

                if (logError) throw logError;

                console.log('✅ Email logged successfully');
                console.log('To:', order.email);
                console.log('Subject:', emailSubject);
                console.log('Body preview:', emailBody.substring(0, 200) + '...');

                // TODO: Integrate with actual email service (Resend, SendGrid, etc.)
                // For now, we're just logging to the database

            } catch (error) {
                console.error('Error sending confirmation email:', error);
                throw error;
            }
        }

        function exportToCSV() {
            if (allOrders.length === 0) {
                alert('No orders to export');
                return;
            }

            // Create CSV content
            const headers = ['Order Number', 'Date', 'First Name', 'Last Name', 'Email', 'Phone', 'Party Date', 'Adults', 'Children', 'Items', 'Total Amount', 'Payment Status'];
            const rows = allOrders.map(order => [
                order.order_number,
                new Date(order.created_at).toLocaleString(),
                order.first_name,
                order.last_name,
                order.email,
                order.phone || '',
                order.party_date || 'N/A',
                order.adult_count || 0,
                order.child_count || 0,
                order.items.map(item => `${item.quantity}x ${item.item_name}`).join('; '),
                order.total_amount,
                order.payment_status
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pumpkin-orders-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            alert('✅ CSV exported successfully!');
        }

        // Close modal when clicking outside
        document.getElementById('orderModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
