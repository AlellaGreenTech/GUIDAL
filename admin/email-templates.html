<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Templates - GUIDAL Admin</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .templates-grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .template-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .template-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-entrance { background: #ffe5d5; color: #ff6b35; }
        .badge-visit { background: #d4edda; color: #28a745; }
        .badge-active { background: #d1ecf1; color: #0c5460; }
        .badge-inactive { background: #f8d7da; color: #721c24; }

        .template-actions {
            display: flex;
            gap: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .template-variables {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .template-variables h4 {
            margin-top: 0;
        }

        .variable-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .variable-tag {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: monospace;
            cursor: pointer;
        }

        .variable-tag:hover {
            background: #dee2e6;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #28a745;
            color: white;
        }

        .btn-primary:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.9rem;
        }

        .preview-frame {
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 400px;
            background: white;
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="container" style="display: flex; align-items: center; justify-content: space-between; gap: 2rem;">
            <a href="../index.html" style="text-decoration: none; display: flex; flex-direction: column; padding: 0.75rem 0;">
                <span style="font-size: 1.5rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); line-height: 1;">GUIDAL</span>
                <span style="font-size: 0.7rem; color: white; opacity: 0.85; margin-top: 0.15rem;">at Alella Green Tech</span>
            </a>
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <a href="pumpkin-orders.html" style="color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem;">
                    ðŸŽƒ Orders
                </a>
                <a href="email-templates.html" style="color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border-radius: 4px;">
                    ðŸ“§ Templates
                </a>
                <a href="../pages/profile.html" style="color: white; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem;">
                    ðŸ‘¤ Profile
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>ðŸ“§ Email Templates</h1>
            <button class="btn btn-primary" onclick="openCreateModal()">+ Create Template</button>
        </div>

        <div id="templatesGrid" class="templates-grid">
            <p>Loading templates...</p>
        </div>
    </div>

    <!-- Edit/Create Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Create Email Template</h2>

            <div class="template-variables">
                <h4>Available Variables (click to copy):</h4>
                <div class="variable-tags">
                    <span class="variable-tag" onclick="copyVariable('{{order_number}}')">{{order_number}}</span>
                    <span class="variable-tag" onclick="copyVariable('{{first_name}}')">{{first_name}}</span>
                    <span class="variable-tag" onclick="copyVariable('{{last_name}}')">{{last_name}}</span>
                    <span class="variable-tag" onclick="copyVariable('{{email}}')">{{email}}</span>
                    <span class="variable-tag" onclick="copyVariable('{{phone}}')">{{phone}}</span>
                    <span class="variable-tag" onclick="copyVariable('{{adult_count}}')">{{adult_count}}</span>
                    <span class="variable-tag" onclick="copyVariable('{{child_count}}')">{{child_count}}</span>
                    <span class="variable-tag" onclick="copyVariable('{{total_amount}}')">{{total_amount}}</span>
                </div>
            </div>

            <form id="templateForm">
                <input type="hidden" id="templateId">

                <div class="form-group">
                    <label for="templateName">Template Name</label>
                    <input type="text" id="templateName" required>
                </div>

                <div class="form-group">
                    <label for="templateType">Template Type</label>
                    <select id="templateType" required>
                        <option value="entrance_ticket">Entrance Ticket</option>
                        <option value="visit_pass">Visit Pass</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="templateSubject">Email Subject</label>
                    <input type="text" id="templateSubject" required>
                </div>

                <div class="form-group">
                    <label for="templateBody">HTML Body</label>
                    <textarea id="templateBody" required></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="templateActive" checked>
                        Active (use this template for new orders)
                    </label>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="previewTemplate()">Preview</button>
                    <button type="submit" class="btn btn-primary">Save Template</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <h2>Email Preview</h2>
            <iframe id="previewFrame" class="preview-frame" style="width: 100%; height: 500px;"></iframe>
            <div style="margin-top: 1rem; text-align: right;">
                <button class="btn btn-secondary" onclick="closePreview()">Close</button>
            </div>
        </div>
    </div>

    <script src="../js/supabase-client.js"></script>
    <script src="../js/auth-nav.js"></script>
    <script>
        let templates = [];
        let editingTemplateId = null;

        async function loadTemplates() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('pumpkin_patch_email_templates')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                templates = data;
                renderTemplates();
            } catch (error) {
                console.error('Error loading templates:', error);
                alert('Failed to load templates: ' + error.message);
            }
        }

        function renderTemplates() {
            const grid = document.getElementById('templatesGrid');

            if (templates.length === 0) {
                grid.innerHTML = '<p>No templates yet. Create your first template!</p>';
                return;
            }

            grid.innerHTML = templates.map(template => `
                <div class="template-card">
                    <div class="template-header">
                        <div>
                            <h3>${template.name}</h3>
                            <div style="margin-top: 0.5rem;">
                                <span class="template-badge badge-${template.template_type === 'entrance_ticket' ? 'entrance' : 'visit'}">
                                    ${template.template_type === 'entrance_ticket' ? 'ðŸŽƒ Entrance Ticket' : 'ðŸŽƒ Visit Pass'}
                                </span>
                                <span class="template-badge badge-${template.is_active ? 'active' : 'inactive'}">
                                    ${template.is_active ? 'âœ“ Active' : 'âœ— Inactive'}
                                </span>
                            </div>
                        </div>
                        <div class="template-actions">
                            <button class="btn btn-small btn-secondary" onclick="editTemplate('${template.id}')">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTemplate('${template.id}')">Delete</button>
                        </div>
                    </div>
                    <p><strong>Subject:</strong> ${template.subject}</p>
                    <p style="color: #666; font-size: 0.9rem;">Updated: ${new Date(template.updated_at).toLocaleString()}</p>
                </div>
            `).join('');
        }

        function openCreateModal() {
            editingTemplateId = null;
            document.getElementById('modalTitle').textContent = 'Create Email Template';
            document.getElementById('templateForm').reset();
            document.getElementById('templateId').value = '';
            document.getElementById('templateModal').classList.add('show');
        }

        function editTemplate(id) {
            const template = templates.find(t => t.id === id);
            if (!template) return;

            editingTemplateId = id;
            document.getElementById('modalTitle').textContent = 'Edit Email Template';
            document.getElementById('templateId').value = id;
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateType').value = template.template_type;
            document.getElementById('templateSubject').value = template.subject;
            document.getElementById('templateBody').value = template.html_body;
            document.getElementById('templateActive').checked = template.is_active;
            document.getElementById('templateModal').classList.add('show');
        }

        async function deleteTemplate(id) {
            if (!confirm('Are you sure you want to delete this template?')) return;

            try {
                const { error } = await window.supabaseClient
                    .from('pumpkin_patch_email_templates')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Template deleted successfully!');
                await loadTemplates();
            } catch (error) {
                console.error('Error deleting template:', error);
                alert('Failed to delete template: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('templateModal').classList.remove('show');
        }

        function copyVariable(variable) {
            navigator.clipboard.writeText(variable);
            alert('Copied: ' + variable);
        }

        function previewTemplate() {
            const html = document.getElementById('templateBody').value;
            const subject = document.getElementById('templateSubject').value;

            // Replace variables with sample data
            const sampleData = {
                '{{order_number}}': 'PUMP-2025-001',
                '{{first_name}}': 'John',
                '{{last_name}}': 'Doe',
                '{{email}}': 'john@example.com',
                '{{phone}}': '+32 123 456 789',
                '{{adult_count}}': '2',
                '{{child_count}}': '3',
                '{{total_amount}}': '75.00'
            };

            let preview = html;
            Object.entries(sampleData).forEach(([key, value]) => {
                preview = preview.replaceAll(key, value);
            });

            const previewFrame = document.getElementById('previewFrame');
            const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            previewDoc.open();
            previewDoc.write(preview);
            previewDoc.close();

            document.getElementById('previewModal').classList.add('show');
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
        }

        document.getElementById('templateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const templateData = {
                name: document.getElementById('templateName').value,
                template_type: document.getElementById('templateType').value,
                subject: document.getElementById('templateSubject').value,
                html_body: document.getElementById('templateBody').value,
                is_active: document.getElementById('templateActive').checked,
                updated_at: new Date().toISOString()
            };

            try {
                if (editingTemplateId) {
                    // Update existing template
                    const { error } = await window.supabaseClient
                        .from('pumpkin_patch_email_templates')
                        .update(templateData)
                        .eq('id', editingTemplateId);

                    if (error) throw error;
                    alert('Template updated successfully!');
                } else {
                    // Create new template
                    const { error } = await window.supabaseClient
                        .from('pumpkin_patch_email_templates')
                        .insert([templateData]);

                    if (error) throw error;
                    alert('Template created successfully!');
                }

                closeModal();
                await loadTemplates();
            } catch (error) {
                console.error('Error saving template:', error);
                alert('Failed to save template: ' + error.message);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', loadTemplates);
    </script>
</body>
</html>
