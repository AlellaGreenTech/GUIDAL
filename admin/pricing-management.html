<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Management - GUIDAL Admin</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .admin-nav {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .admin-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 2rem;
        }

        .admin-nav a {
            text-decoration: none;
            color: #495057;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }

        .admin-nav a:hover,
        .admin-nav a.active {
            background: #1565c0;
            color: white;
        }

        .pricing-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .section-header h3 {
            margin: 0;
            color: #1565c0;
        }

        .section-content {
            padding: 1.5rem;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .price-input {
            display: flex;
            flex-direction: column;
        }

        .price-input label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .price-input input {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .price-input input:focus {
            outline: none;
            border-color: #1565c0;
        }

        .euro-symbol {
            position: relative;
        }

        .euro-symbol::before {
            content: '‚Ç¨';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }

        .euro-symbol input {
            padding-left: 2rem;
        }

        .percent-symbol {
            position: relative;
        }

        .percent-symbol::after {
            content: '%';
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }

        .percent-symbol input {
            padding-right: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #1565c0;
            color: white;
        }

        .btn-primary:hover {
            background: #0d47a1;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .school-override {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }

        .school-override h4 {
            margin: 0 0 1rem 0;
            color: #1565c0;
        }

        .override-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .school-search {
            margin-bottom: 1rem;
            position: relative;
            overflow: visible;
        }

        .school-search select {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            width: 100%;
            background: white;
            position: relative;
            z-index: 10;

            /* Force dropdown direction */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        .school-search select:focus {
            outline: none;
            border-color: #1565c0;
        }

        /* Ensure parent containers don't interfere */
        .section-content {
            overflow: visible !important;
        }

        .pricing-section {
            overflow: visible !important;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <h1>üè¢ GUIDAL Admin - Pricing Management</h1>
            <p>Configure standard pricing and school-specific overrides</p>
        </div>
    </header>

    <nav class="admin-nav">
        <div class="container">
            <ul>
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="visits.html">Visits</a></li>
                <li><a href="pricing-management.html" class="active">Pricing</a></li>
                <li><a href="invoices.html">Invoices</a></li>
                <li><a href="form-editor.html">Form Editor</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div id="messages"></div>

        <!-- Standard Pricing Configuration -->
        <div class="pricing-section">
            <div class="section-header">
                <h3>üìä Standard Pricing Configuration</h3>
            </div>
            <div class="section-content">
                <form id="standardPricingForm">
                    <div class="pricing-grid">
                        <div class="price-input">
                            <label for="visitPriceChild">Visit Price - Child</label>
                            <div class="euro-symbol">
                                <input type="number" id="visitPriceChild" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="price-input">
                            <label for="visitPriceAdult">Visit Price - Adult</label>
                            <div class="euro-symbol">
                                <input type="number" id="visitPriceAdult" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="price-input">
                            <label for="mealPriceChild">Meal Price - Child</label>
                            <div class="euro-symbol">
                                <input type="number" id="mealPriceChild" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="price-input">
                            <label for="mealPriceAdult">Meal Price - Adult</label>
                            <div class="euro-symbol">
                                <input type="number" id="mealPriceAdult" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="price-input">
                            <label for="vatRate">VAT Rate</label>
                            <div class="percent-symbol">
                                <input type="number" id="vatRate" step="0.01" min="0" max="100" value="21" required>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">üíæ Update Standard Pricing</button>
                </form>
            </div>
        </div>

        <!-- School-Specific Overrides -->
        <div class="pricing-section">
            <div class="section-header">
                <h3>üè´ School-Specific Pricing Overrides</h3>
            </div>
            <div class="section-content">
                <!-- Add New Override -->
                <div style="margin-bottom: 3rem; padding: 1rem; border: 2px dashed #dee2e6; border-radius: 6px; position: relative; overflow: visible;">
                    <h4>‚ûï Add New School Override</h4>
                    <form id="newOverrideForm">
                        <div class="school-search">
                            <label for="schoolNameSelect">School Name</label>
                            <select id="schoolNameSelect" required>
                                <option value="">Select a school...</option>
                                <option value="OTHER">Other (specify below)</option>
                            </select>
                            <div id="customSchoolDiv" style="display: none; margin-top: 0.5rem;">
                                <input type="text" id="customSchoolInput" placeholder="Enter new school name..." style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px;">
                            </div>
                        </div>

                        <div class="pricing-grid">
                            <div class="price-input">
                                <label for="overrideVisitChild">Visit Price - Child</label>
                                <div class="euro-symbol">
                                    <input type="number" id="overrideVisitChild" step="0.01" min="0" placeholder="Leave blank for standard">
                                </div>
                            </div>

                            <div class="price-input">
                                <label for="overrideVisitAdult">Visit Price - Adult</label>
                                <div class="euro-symbol">
                                    <input type="number" id="overrideVisitAdult" step="0.01" min="0" placeholder="Leave blank for standard">
                                </div>
                            </div>

                            <div class="price-input">
                                <label for="overrideMealChild">Meal Price - Child</label>
                                <div class="euro-symbol">
                                    <input type="number" id="overrideMealChild" step="0.01" min="0" placeholder="Leave blank for standard">
                                </div>
                            </div>

                            <div class="price-input">
                                <label for="overrideMealAdult">Meal Price - Adult</label>
                                <div class="euro-symbol">
                                    <input type="number" id="overrideMealAdult" step="0.01" min="0" placeholder="Leave blank for standard">
                                </div>
                            </div>

                            <div class="price-input">
                                <label for="discountPercentage">Discount</label>
                                <div class="percent-symbol">
                                    <input type="number" id="discountPercentage" step="0.01" min="0" max="100" placeholder="Optional">
                                </div>
                            </div>
                        </div>

                        <div style="margin: 1rem 0;">
                            <label for="overrideNotes">Notes</label>
                            <textarea id="overrideNotes" rows="2" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px;" placeholder="Special agreements, bulk discounts, etc."></textarea>
                        </div>

                        <button type="submit" class="btn btn-success">‚úÖ Add School Override</button>
                    </form>
                </div>

                <!-- Existing Overrides -->
                <div id="existingOverrides">
                    <h4>üìã Existing School Overrides</h4>
                    <div id="overridesList">
                        <!-- Dynamically loaded -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Load required scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="js/auth-guard.js"></script>
    <script>
        class PricingManager {
            constructor() {
                this.currentPricing = null;
                this.schools = [];
                this.init();
            }

            async init() {
                try {
                    await this.loadCurrentPricing();
                    await this.loadSchoolOverrides();
                    await this.loadSchoolNames();
                    this.setupEventListeners();
                } catch (error) {
                    console.error('‚ùå Error initializing pricing manager:', error);
                    this.showMessage('Error loading pricing data', 'error');
                }
            }

            async loadCurrentPricing() {
                const { data, error } = await supabaseClient
                    .from('pricing_config')
                    .select('*')
                    .eq('is_active', true)
                    .single();

                if (error) {
                    console.error('Error loading pricing:', error);
                    return;
                }

                this.currentPricing = data;
                this.populatePricingForm(data);
            }

            populatePricingForm(pricing) {
                document.getElementById('visitPriceChild').value = pricing.visit_price_child;
                document.getElementById('visitPriceAdult').value = pricing.visit_price_adult;
                document.getElementById('mealPriceChild').value = pricing.meal_price_child;
                document.getElementById('mealPriceAdult').value = pricing.meal_price_adult;
                document.getElementById('vatRate').value = pricing.vat_rate;
            }

            async loadSchoolOverrides() {
                const { data, error } = await supabaseClient
                    .from('school_pricing_overrides')
                    .select('*')
                    .eq('is_active', true)
                    .order('school_name');

                if (error) {
                    console.error('Error loading school overrides:', error);
                    return;
                }

                this.renderSchoolOverrides(data || []);
            }

            renderSchoolOverrides(overrides) {
                const container = document.getElementById('overridesList');

                if (overrides.length === 0) {
                    container.innerHTML = '<p style="color: #666; font-style: italic;">No school-specific overrides configured.</p>';
                    return;
                }

                container.innerHTML = overrides.map(override => `
                    <div class="school-override" data-id="${override.id}">
                        <h4>${override.school_name}</h4>
                        <div class="pricing-grid">
                            <div><strong>Visit Child:</strong> ${override.visit_price_child ? '‚Ç¨' + override.visit_price_child : 'Standard'}</div>
                            <div><strong>Visit Adult:</strong> ${override.visit_price_adult ? '‚Ç¨' + override.visit_price_adult : 'Standard'}</div>
                            <div><strong>Meal Child:</strong> ${override.meal_price_child ? '‚Ç¨' + override.meal_price_child : 'Standard'}</div>
                            <div><strong>Meal Adult:</strong> ${override.meal_price_adult ? '‚Ç¨' + override.meal_price_adult : 'Standard'}</div>
                            ${override.discount_percentage ? `<div><strong>Discount:</strong> ${override.discount_percentage}%</div>` : ''}
                        </div>
                        ${override.notes ? `<p><strong>Notes:</strong> ${override.notes}</p>` : ''}
                        <div class="override-controls">
                            <button class="btn btn-warning" onclick="pricingManager.editOverride('${override.id}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="pricingManager.deleteOverride('${override.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `).join('');
            }

            async loadSchoolNames() {
                console.log('üè´ Loading school names...');

                // Use fallback school list since table doesn't exist yet
                this.schools = [
                    'Barcelona International School',
                    'International School of Catalunya',
                    'American School of Barcelona',
                    'Zurich International School',
                    'International School of Geneva',
                    'British School of Barcelona',
                    'St. Peter\'s School Barcelona',
                    'Benjamin Franklin International School',
                    'Agora International School Barcelona'
                ];

                console.log('üìö Using fallback school list with', this.schools.length, 'schools');
                this.populateSchoolDropdown();
            }

            populateSchoolDropdown() {
                const select = document.getElementById('schoolNameSelect');
                console.log('üìù Populating dropdown with', this.schools.length, 'schools');

                // Clear existing options except the first two (placeholder and "Other")
                while (select.children.length > 2) {
                    select.removeChild(select.lastChild);
                }

                // Add school options
                this.schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school;
                    option.textContent = school;
                    select.appendChild(option);
                    console.log('‚ûï Added school option:', school);
                });

                console.log('‚úÖ Dropdown populated with', select.children.length - 2, 'school options');
            }

            setupEventListeners() {
                // Standard pricing form
                document.getElementById('standardPricingForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateStandardPricing();
                });

                // New override form
                document.getElementById('newOverrideForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addSchoolOverride();
                });

                // School dropdown change
                document.getElementById('schoolNameSelect').addEventListener('change', (e) => {
                    this.handleSchoolSelection(e.target.value);
                });
            }

            handleSchoolSelection(selectedValue) {
                const customDiv = document.getElementById('customSchoolDiv');
                const customInput = document.getElementById('customSchoolInput');

                if (selectedValue === 'OTHER') {
                    customDiv.style.display = 'block';
                    customInput.required = true;
                } else {
                    customDiv.style.display = 'none';
                    customInput.required = false;
                    customInput.value = '';
                }
            }


            async updateStandardPricing() {
                const formData = {
                    visit_price_child: parseFloat(document.getElementById('visitPriceChild').value),
                    visit_price_adult: parseFloat(document.getElementById('visitPriceAdult').value),
                    meal_price_child: parseFloat(document.getElementById('mealPriceChild').value),
                    meal_price_adult: parseFloat(document.getElementById('mealPriceAdult').value),
                    vat_rate: parseFloat(document.getElementById('vatRate').value)
                };

                // Deactivate current pricing
                if (this.currentPricing) {
                    await supabaseClient
                        .from('pricing_config')
                        .update({ is_active: false })
                        .eq('id', this.currentPricing.id);
                }

                // Create new pricing config
                const { data, error } = await supabaseClient
                    .from('pricing_config')
                    .insert({
                        ...formData,
                        is_active: true,
                        created_by: (await supabaseClient.auth.getUser()).data.user?.id
                    })
                    .select()
                    .single();

                if (error) {
                    console.error('Error updating pricing:', error);
                    this.showMessage('Error updating pricing configuration', 'error');
                    return;
                }

                this.currentPricing = data;
                this.showMessage('Standard pricing updated successfully!', 'success');
            }

            async addSchoolOverride() {
                const selectedSchool = document.getElementById('schoolNameSelect').value;
                const customSchool = document.getElementById('customSchoolInput').value.trim();
                const schoolName = selectedSchool === 'OTHER' ? customSchool : selectedSchool;

                const formData = {
                    school_name: schoolName,
                    visit_price_child: this.parsePrice('overrideVisitChild'),
                    visit_price_adult: this.parsePrice('overrideVisitAdult'),
                    meal_price_child: this.parsePrice('overrideMealChild'),
                    meal_price_adult: this.parsePrice('overrideMealAdult'),
                    discount_percentage: this.parsePrice('discountPercentage'),
                    notes: document.getElementById('overrideNotes').value.trim() || null,
                    created_by: (await supabaseClient.auth.getUser()).data.user?.id
                };

                if (!formData.school_name) {
                    this.showMessage('School name is required', 'error');
                    return;
                }

                const { data, error } = await supabaseClient
                    .from('school_pricing_overrides')
                    .insert(formData);

                if (error) {
                    console.error('Error adding school override:', error);
                    this.showMessage('Error adding school override', 'error');
                    return;
                }

                // Reset form
                document.getElementById('newOverrideForm').reset();

                // Reload overrides
                await this.loadSchoolOverrides();

                this.showMessage(`School override added for ${formData.school_name}`, 'success');
            }

            parsePrice(fieldId) {
                const value = document.getElementById(fieldId).value;
                return value ? parseFloat(value) : null;
            }

            async deleteOverride(overrideId) {
                if (!confirm('Are you sure you want to delete this school override?')) {
                    return;
                }

                const { error } = await supabaseClient
                    .from('school_pricing_overrides')
                    .update({ is_active: false })
                    .eq('id', overrideId);

                if (error) {
                    console.error('Error deleting override:', error);
                    this.showMessage('Error deleting school override', 'error');
                    return;
                }

                await this.loadSchoolOverrides();
                this.showMessage('School override deleted', 'success');
            }

            showMessage(message, type) {
                const container = document.getElementById('messages');
                const alertClass = type === 'error' ? 'alert-error' : 'alert-success';

                container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        // Initialize when DOM is loaded and Supabase is ready
        document.addEventListener('DOMContentLoaded', function() {
            function waitForSupabaseClient() {
                if (typeof supabaseClient !== 'undefined') {
                    window.pricingManager = new PricingManager();
                } else {
                    setTimeout(waitForSupabaseClient, 100);
                }
            }
            waitForSupabaseClient();
        });
    </script>
</body>
</html>