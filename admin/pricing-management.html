<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Management - GUIDAL Admin</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .admin-nav {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .admin-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 2rem;
        }

        .admin-nav a {
            text-decoration: none;
            color: #495057;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 4px;
        }

        .admin-nav a:hover,
        .admin-nav a.active {
            background: #1565c0;
            color: white;
        }

        .pricing-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .section-header h3 {
            margin: 0;
            color: #1565c0;
        }

        .section-content {
            padding: 1.5rem;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .price-input {
            display: flex;
            flex-direction: column;
        }

        .price-input label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .price-input input {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .price-input input:focus {
            outline: none;
            border-color: #1565c0;
        }

        .euro-symbol {
            position: relative;
        }

        .euro-symbol::before {
            content: '€';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }

        .euro-symbol input {
            padding-left: 2rem;
        }

        .percent-symbol {
            position: relative;
        }

        .percent-symbol::after {
            content: '%';
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }

        .percent-symbol input {
            padding-right: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #1565c0;
            color: white;
        }

        .btn-primary:hover {
            background: #0d47a1;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .school-override {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
        }

        .school-override h4 {
            margin: 0 0 1rem 0;
            color: #1565c0;
        }

        .override-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .school-search {
            margin-bottom: 1rem;
            position: relative;
            overflow: visible;
        }

        .school-search select {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            width: 100%;
            background: white;
            position: relative;
            z-index: 10;

            /* Force dropdown direction */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        .school-search select:focus {
            outline: none;
            border-color: #1565c0;
        }

        /* Ensure parent containers don't interfere */
        .section-content {
            overflow: visible !important;
        }

        .pricing-section {
            overflow: visible !important;
        }

        .visit-type-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: white;
            position: relative;
        }

        .visit-type-card.editing {
            border-color: #1565c0;
            box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
        }

        .visit-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .visit-type-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1565c0;
        }

        .visit-type-controls {
            display: flex;
            gap: 0.5rem;
        }

        .visit-type-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .free-adults-section {
            grid-column: 1 / -1;
            padding: 1rem;
            background: #f0f8ff;
            border-radius: 6px;
            border-left: 4px solid #1565c0;
        }

        .workshop-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background: white;
            position: relative;
            transition: all 0.3s ease;
        }

        .workshop-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #1565c0;
        }

        .workshop-card.editing {
            border-color: #1565c0;
            box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
        }

        .workshop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .workshop-info {
            flex: 1;
        }

        .workshop-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1565c0;
            margin-bottom: 0.25rem;
        }

        .workshop-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .workshop-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #888;
        }

        .workshop-controls {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .workshop-pricing-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .price-badge {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            text-align: center;
            border-left: 3px solid #1565c0;
        }

        .price-badge .label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .price-badge .value {
            font-weight: 600;
            color: #1565c0;
            font-size: 1.1rem;
        }

        .workshop-form {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .workshop-form.editing {
            display: grid;
        }

        .form-section {
            grid-column: 1 / -1;
            border-top: 1px solid #dee2e6;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .form-section:first-child {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <h1>🏢 GUIDAL Admin - Pricing Management</h1>
            <p>Configure standard pricing and school-specific overrides</p>
        </div>
    </header>

    <nav class="admin-nav">
        <div class="container">
            <ul>
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="visits.html">Visits</a></li>
                <li><a href="pricing-management.html" class="active">Pricing</a></li>
                <li><a href="invoices.html">Invoices</a></li>
                <li><a href="form-editor.html">Form Editor</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div id="messages"></div>

        <!-- Workshop/Activity Catalog -->
        <div class="pricing-section">
            <div class="section-header">
                <h3>🎯 Workshop & Activity Catalog</h3>
                <p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;">Configure individual pricing for each workshop and activity. Visits can include multiple workshops.</p>
            </div>
            <div class="section-content">
                <div id="workshopCatalogContainer">
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        Loading workshop catalog...
                    </div>
                </div>
                <button type="button" class="btn btn-success" onclick="addNewWorkshop()" style="margin-top: 1rem;">➕ Add New Workshop/Activity</button>
            </div>
        </div>

        <!-- Base Visit Pricing -->
        <div class="pricing-section">
            <div class="section-header">
                <h3>🏫 Base Visit Pricing</h3>
                <p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;">Base pricing for site access, tours, and facilities (before workshop add-ons)</p>
            </div>
            <div class="section-content">
                <form id="baseVisitForm">
                    <div class="pricing-grid">
                        <div class="price-input">
                            <label for="baseVisitChild">Base Visit - Child</label>
                            <div class="euro-symbol">
                                <input type="number" id="baseVisitChild" step="0.01" min="0" value="10" required>
                            </div>
                        </div>
                        <div class="price-input">
                            <label for="baseVisitAdult">Base Visit - Adult</label>
                            <div class="euro-symbol">
                                <input type="number" id="baseVisitAdult" step="0.01" min="0" value="15" required>
                            </div>
                        </div>
                        <div class="price-input">
                            <label for="freeAdultsBase">Free Adults (Base Visit)</label>
                            <input type="number" id="freeAdultsBase" min="0" value="1" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">💾 Update Base Visit Pricing</button>
                </form>
            </div>
        </div>

        <!-- Standard Pricing Configuration -->
        <div class="pricing-section">
            <div class="section-header">
                <h3>📊 Default Pricing Configuration</h3>
                <p style="margin: 0.5rem 0; color: #666; font-size: 0.9rem;">Fallback pricing when no specific visit type pricing is configured</p>
            </div>
            <div class="section-content">
                <form id="standardPricingForm">
                    <div class="pricing-grid">
                        <div class="price-input">
                            <label for="visitPriceChild">Visit Price - Child</label>
                            <div class="euro-symbol">
                                <input type="number" id="visitPriceChild" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="price-input">
                            <label for="visitPriceAdult">Visit Price - Adult</label>
                            <div class="euro-symbol">
                                <input type="number" id="visitPriceAdult" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="price-input">
                            <label for="mealPriceChild">Meal Price - Child</label>
                            <div class="euro-symbol">
                                <input type="number" id="mealPriceChild" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="price-input">
                            <label for="mealPriceAdult">Meal Price - Adult</label>
                            <div class="euro-symbol">
                                <input type="number" id="mealPriceAdult" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="price-input">
                            <label for="vatRate">VAT Rate</label>
                            <div class="percent-symbol">
                                <input type="number" id="vatRate" step="0.01" min="0" max="100" value="21" required>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">💾 Update Standard Pricing</button>
                </form>
            </div>
        </div>

        <!-- School-Specific Overrides -->
        <div class="pricing-section">
            <div class="section-header">
                <h3>🏫 School-Specific Pricing Overrides</h3>
            </div>
            <div class="section-content">
                <!-- Add New Override -->
                <div style="margin-bottom: 3rem; padding: 1rem; border: 2px dashed #dee2e6; border-radius: 6px; position: relative; overflow: visible;">
                    <h4>➕ Add New School Override</h4>
                    <form id="newOverrideForm">
                        <div class="school-search">
                            <label for="schoolNameSelect">School Name</label>
                            <select id="schoolNameSelect" required>
                                <option value="">Select a school...</option>
                                <option value="OTHER">Other (specify below)</option>
                            </select>
                            <div id="customSchoolDiv" style="display: none; margin-top: 0.5rem;">
                                <input type="text" id="customSchoolInput" placeholder="Enter new school name..." style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px;">
                            </div>
                        </div>

                        <div class="pricing-grid">
                            <div class="price-input">
                                <label for="overrideVisitChild">Visit Price - Child</label>
                                <div class="euro-symbol">
                                    <input type="number" id="overrideVisitChild" step="0.01" min="0" placeholder="Leave blank for standard">
                                </div>
                            </div>

                            <div class="price-input">
                                <label for="overrideVisitAdult">Visit Price - Adult</label>
                                <div class="euro-symbol">
                                    <input type="number" id="overrideVisitAdult" step="0.01" min="0" placeholder="Leave blank for standard">
                                </div>
                            </div>

                            <div class="price-input">
                                <label for="overrideMealChild">Meal Price - Child</label>
                                <div class="euro-symbol">
                                    <input type="number" id="overrideMealChild" step="0.01" min="0" placeholder="Leave blank for standard">
                                </div>
                            </div>

                            <div class="price-input">
                                <label for="overrideMealAdult">Meal Price - Adult</label>
                                <div class="euro-symbol">
                                    <input type="number" id="overrideMealAdult" step="0.01" min="0" placeholder="Leave blank for standard">
                                </div>
                            </div>

                            <div class="price-input">
                                <label for="discountPercentage">Discount</label>
                                <div class="percent-symbol">
                                    <input type="number" id="discountPercentage" step="0.01" min="0" max="100" placeholder="Optional">
                                </div>
                            </div>
                        </div>

                        <div style="margin: 1rem 0;">
                            <label for="overrideNotes">Notes</label>
                            <textarea id="overrideNotes" rows="2" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px;" placeholder="Special agreements, bulk discounts, etc."></textarea>
                        </div>

                        <button type="submit" class="btn btn-success">✅ Add School Override</button>
                    </form>
                </div>

                <!-- Existing Overrides -->
                <div id="existingOverrides">
                    <h4>📋 Existing School Overrides</h4>
                    <div id="overridesList">
                        <!-- Dynamically loaded -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Load required scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="js/auth-guard.js"></script>
    <script>
        class PricingManager {
            constructor() {
                this.currentPricing = null;
                this.schools = [];
                this.init();
            }

            async init() {
                try {
                    await this.loadCurrentPricing();
                    await this.loadWorkshopCatalog();
                    await this.loadSchoolOverrides();
                    await this.loadSchoolNames();
                    this.setupEventListeners();
                } catch (error) {
                    console.error('❌ Error initializing pricing manager:', error);
                    this.showMessage('Error loading pricing data', 'error');
                }
            }

            async loadCurrentPricing() {
                const { data, error } = await supabaseClient
                    .from('pricing_config')
                    .select('*')
                    .eq('is_active', true)
                    .single();

                if (error) {
                    console.error('Error loading pricing:', error);
                    return;
                }

                this.currentPricing = data;
                this.populatePricingForm(data);
            }

            populatePricingForm(pricing) {
                document.getElementById('visitPriceChild').value = pricing.visit_price_child;
                document.getElementById('visitPriceAdult').value = pricing.visit_price_adult;
                document.getElementById('mealPriceChild').value = pricing.meal_price_child;
                document.getElementById('mealPriceAdult').value = pricing.meal_price_adult;
                document.getElementById('vatRate').value = pricing.vat_rate;
            }

            async loadSchoolOverrides() {
                const { data, error } = await supabaseClient
                    .from('school_pricing_overrides')
                    .select('*')
                    .eq('is_active', true)
                    .order('school_name');

                if (error) {
                    console.error('Error loading school overrides:', error);
                    return;
                }

                this.renderSchoolOverrides(data || []);
            }

            renderSchoolOverrides(overrides) {
                const container = document.getElementById('overridesList');

                if (overrides.length === 0) {
                    container.innerHTML = '<p style="color: #666; font-style: italic;">No school-specific overrides configured.</p>';
                    return;
                }

                container.innerHTML = overrides.map(override => `
                    <div class="school-override" data-id="${override.id}">
                        <h4>${override.school_name}</h4>
                        <div class="pricing-grid">
                            <div><strong>Visit Child:</strong> ${override.visit_price_child ? '€' + override.visit_price_child : 'Standard'}</div>
                            <div><strong>Visit Adult:</strong> ${override.visit_price_adult ? '€' + override.visit_price_adult : 'Standard'}</div>
                            <div><strong>Meal Child:</strong> ${override.meal_price_child ? '€' + override.meal_price_child : 'Standard'}</div>
                            <div><strong>Meal Adult:</strong> ${override.meal_price_adult ? '€' + override.meal_price_adult : 'Standard'}</div>
                            ${override.discount_percentage ? `<div><strong>Discount:</strong> ${override.discount_percentage}%</div>` : ''}
                        </div>
                        ${override.notes ? `<p><strong>Notes:</strong> ${override.notes}</p>` : ''}
                        <div class="override-controls">
                            <button class="btn btn-warning" onclick="pricingManager.editOverride('${override.id}')">✏️ Edit</button>
                            <button class="btn btn-danger" onclick="pricingManager.deleteOverride('${override.id}')">🗑️ Delete</button>
                        </div>
                    </div>
                `).join('');
            }

            async loadSchoolNames() {
                console.log('🏫 Loading school names...');

                // Use fallback school list since table doesn't exist yet
                this.schools = [
                    'Barcelona International School',
                    'International School of Catalunya',
                    'American School of Barcelona',
                    'Zurich International School',
                    'International School of Geneva',
                    'British School of Barcelona',
                    'St. Peter\'s School Barcelona',
                    'Benjamin Franklin International School',
                    'Agora International School Barcelona'
                ];

                console.log('📚 Using fallback school list with', this.schools.length, 'schools');
                this.populateSchoolDropdown();
            }

            populateSchoolDropdown() {
                const select = document.getElementById('schoolNameSelect');
                console.log('📝 Populating dropdown with', this.schools.length, 'schools');

                // Clear existing options except the first two (placeholder and "Other")
                while (select.children.length > 2) {
                    select.removeChild(select.lastChild);
                }

                // Add school options
                this.schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school;
                    option.textContent = school;
                    select.appendChild(option);
                    console.log('➕ Added school option:', school);
                });

                console.log('✅ Dropdown populated with', select.children.length - 2, 'school options');
            }

            setupEventListeners() {
                // Standard pricing form
                document.getElementById('standardPricingForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateStandardPricing();
                });

                // New override form
                document.getElementById('newOverrideForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addSchoolOverride();
                });

                // School dropdown change
                document.getElementById('schoolNameSelect').addEventListener('change', (e) => {
                    this.handleSchoolSelection(e.target.value);
                });
            }

            handleSchoolSelection(selectedValue) {
                const customDiv = document.getElementById('customSchoolDiv');
                const customInput = document.getElementById('customSchoolInput');

                if (selectedValue === 'OTHER') {
                    customDiv.style.display = 'block';
                    customInput.required = true;
                } else {
                    customDiv.style.display = 'none';
                    customInput.required = false;
                    customInput.value = '';
                }
            }


            async updateStandardPricing() {
                const formData = {
                    visit_price_child: parseFloat(document.getElementById('visitPriceChild').value),
                    visit_price_adult: parseFloat(document.getElementById('visitPriceAdult').value),
                    meal_price_child: parseFloat(document.getElementById('mealPriceChild').value),
                    meal_price_adult: parseFloat(document.getElementById('mealPriceAdult').value),
                    vat_rate: parseFloat(document.getElementById('vatRate').value)
                };

                // Deactivate current pricing
                if (this.currentPricing) {
                    await supabaseClient
                        .from('pricing_config')
                        .update({ is_active: false })
                        .eq('id', this.currentPricing.id);
                }

                // Create new pricing config
                const { data, error } = await supabaseClient
                    .from('pricing_config')
                    .insert({
                        ...formData,
                        is_active: true,
                        created_by: (await supabaseClient.auth.getUser()).data.user?.id
                    })
                    .select()
                    .single();

                if (error) {
                    console.error('Error updating pricing:', error);
                    this.showMessage('Error updating pricing configuration', 'error');
                    return;
                }

                this.currentPricing = data;
                this.showMessage('Standard pricing updated successfully!', 'success');
            }

            async addSchoolOverride() {
                const selectedSchool = document.getElementById('schoolNameSelect').value;
                const customSchool = document.getElementById('customSchoolInput').value.trim();
                const schoolName = selectedSchool === 'OTHER' ? customSchool : selectedSchool;

                const formData = {
                    school_name: schoolName,
                    visit_price_child: this.parsePrice('overrideVisitChild'),
                    visit_price_adult: this.parsePrice('overrideVisitAdult'),
                    meal_price_child: this.parsePrice('overrideMealChild'),
                    meal_price_adult: this.parsePrice('overrideMealAdult'),
                    discount_percentage: this.parsePrice('discountPercentage'),
                    notes: document.getElementById('overrideNotes').value.trim() || null,
                    created_by: (await supabaseClient.auth.getUser()).data.user?.id
                };

                if (!formData.school_name) {
                    this.showMessage('School name is required', 'error');
                    return;
                }

                const { data, error } = await supabaseClient
                    .from('school_pricing_overrides')
                    .insert(formData);

                if (error) {
                    console.error('Error adding school override:', error);
                    this.showMessage('Error adding school override', 'error');
                    return;
                }

                // Reset form
                document.getElementById('newOverrideForm').reset();

                // Reload overrides
                await this.loadSchoolOverrides();

                this.showMessage(`School override added for ${formData.school_name}`, 'success');
            }

            parsePrice(fieldId) {
                const value = document.getElementById(fieldId).value;
                return value ? parseFloat(value) : null;
            }

            async deleteOverride(overrideId) {
                if (!confirm('Are you sure you want to delete this school override?')) {
                    return;
                }

                const { error } = await supabaseClient
                    .from('school_pricing_overrides')
                    .update({ is_active: false })
                    .eq('id', overrideId);

                if (error) {
                    console.error('Error deleting override:', error);
                    this.showMessage('Error deleting school override', 'error');
                    return;
                }

                await this.loadSchoolOverrides();
                this.showMessage('School override deleted', 'success');
            }

            async loadWorkshopCatalog() {
                try {
                    // Workshop/Activity pricing catalog (operational details managed elsewhere)
                    const defaultWorkshops = [
                        {
                            id: 'compost-workshop',
                            name: '🌱 Composting Workshop',
                            description: 'Learn hands-on composting techniques and soil health',
                            child_price: 8.50,
                            adult_price: 12.00,
                            category: 'Soil & Agriculture'
                        },
                        {
                            id: 'hydro-workshop',
                            name: '💧 Hydroponic Systems',
                            description: 'Build and understand soilless growing systems',
                            child_price: 15.00,
                            adult_price: 22.00,
                            category: 'Technology'
                        },
                        {
                            id: 'solar-workshop',
                            name: '☀️ Solar Energy Lab',
                            description: 'Hands-on solar panel construction and testing',
                            child_price: 18.00,
                            adult_price: 25.00,
                            category: 'Renewable Energy'
                        },
                        {
                            id: 'permaculture-design',
                            name: '🌿 Permaculture Design',
                            description: 'Design sustainable food systems and landscapes',
                            child_price: 22.00,
                            adult_price: 32.00,
                            category: 'Design & Planning'
                        },
                        {
                            id: 'water-management',
                            name: '🚰 Water Systems Workshop',
                            description: 'Rainwater harvesting and greywater systems',
                            child_price: 12.00,
                            adult_price: 18.00,
                            category: 'Water Management'
                        },
                        {
                            id: 'bio-construction',
                            name: '🏡 Bio-Construction Workshop',
                            description: 'Natural building techniques with local materials',
                            child_price: 25.00,
                            adult_price: 35.00,
                            category: 'Construction'
                        },
                        {
                            id: 'farm-tour',
                            name: '🚜 Guided Farm Tour',
                            description: 'Educational walk through sustainable farming practices',
                            child_price: 5.00,
                            adult_price: 8.00,
                            category: 'Tours'
                        },
                        {
                            id: 'lunch-preparation',
                            name: '🥗 Farm-to-Table Lunch',
                            description: 'Fresh meal prepared with on-site ingredients',
                            child_price: 8.00,
                            adult_price: 12.00,
                            category: 'Meals'
                        }
                    ];

                    this.workshopCatalog = defaultWorkshops;
                    this.renderWorkshopCatalog();
                } catch (error) {
                    console.error('Error loading workshop catalog:', error);
                }
            }

            renderWorkshopCatalog() {
                const container = document.getElementById('workshopCatalogContainer');

                if (!this.workshopCatalog || this.workshopCatalog.length === 0) {
                    container.innerHTML = '<p style="color: #666; font-style: italic;">No workshops configured.</p>';
                    return;
                }

                const html = this.workshopCatalog.map(workshop => `
                    <div class="workshop-card" data-workshop-id="${workshop.id}">
                        <div class="workshop-header">
                            <div class="workshop-info">
                                <div class="workshop-title">${workshop.name}</div>
                                <div class="workshop-description">${workshop.description}</div>
                                <div class="workshop-meta">
                                    <span>📂 ${workshop.category}</span>
                                </div>
                            </div>
                            <div class="workshop-controls">
                                <button class="btn btn-warning btn-sm" onclick="pricingManager.editWorkshop('${workshop.id}')">✏️ Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="pricingManager.deleteWorkshop('${workshop.id}')">🗑️ Delete</button>
                            </div>
                        </div>

                        <div class="workshop-pricing-display" id="display-${workshop.id}">
                            <div class="price-badge">
                                <div class="label">Child Price</div>
                                <div class="value">€${workshop.child_price.toFixed(2)}</div>
                            </div>
                            <div class="price-badge">
                                <div class="label">Adult Price</div>
                                <div class="value">€${workshop.adult_price.toFixed(2)}</div>
                            </div>
                        </div>

                        <div class="workshop-form" id="form-${workshop.id}">
                            <div class="price-input">
                                <label>Workshop Name</label>
                                <input type="text" id="name-${workshop.id}" value="${workshop.name}">
                            </div>
                            <div class="price-input">
                                <label>Description</label>
                                <textarea id="description-${workshop.id}" rows="2" style="resize: vertical; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px; width: 100%;">${workshop.description}</textarea>
                            </div>
                            <div class="price-input">
                                <label>Category</label>
                                <select id="category-${workshop.id}" style="padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 6px; width: 100%;">
                                    <option value="Soil & Agriculture" ${workshop.category === 'Soil & Agriculture' ? 'selected' : ''}>Soil & Agriculture</option>
                                    <option value="Technology" ${workshop.category === 'Technology' ? 'selected' : ''}>Technology</option>
                                    <option value="Renewable Energy" ${workshop.category === 'Renewable Energy' ? 'selected' : ''}>Renewable Energy</option>
                                    <option value="Design & Planning" ${workshop.category === 'Design & Planning' ? 'selected' : ''}>Design & Planning</option>
                                    <option value="Water Management" ${workshop.category === 'Water Management' ? 'selected' : ''}>Water Management</option>
                                    <option value="Construction" ${workshop.category === 'Construction' ? 'selected' : ''}>Construction</option>
                                    <option value="Tours" ${workshop.category === 'Tours' ? 'selected' : ''}>Tours</option>
                                    <option value="Meals" ${workshop.category === 'Meals' ? 'selected' : ''}>Meals</option>
                                </select>
                            </div>
                            <div class="price-input">
                                <label>Child Price</label>
                                <div class="euro-symbol">
                                    <input type="number" id="childPrice-${workshop.id}" step="0.01" min="0" value="${workshop.child_price}">
                                </div>
                            </div>
                            <div class="price-input">
                                <label>Adult Price</label>
                                <div class="euro-symbol">
                                    <input type="number" id="adultPrice-${workshop.id}" step="0.01" min="0" value="${workshop.adult_price}">
                                </div>
                            </div>

                            <div style="grid-column: 1 / -1; margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-success" onclick="pricingManager.saveWorkshop('${workshop.id}')">💾 Save Changes</button>
                                <button class="btn btn-warning" onclick="pricingManager.cancelEditWorkshop('${workshop.id}')">❌ Cancel</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
            }

            editWorkshop(workshopId) {
                document.getElementById(`form-${workshopId}`).classList.add('editing');
                document.querySelector(`[data-workshop-id="${workshopId}"]`).classList.add('editing');
            }

            cancelEditWorkshop(workshopId) {
                document.getElementById(`form-${workshopId}`).classList.remove('editing');
                document.querySelector(`[data-workshop-id="${workshopId}"]`).classList.remove('editing');
            }

            saveWorkshop(workshopId) {
                // Get form values (pricing-focused only)
                const name = document.getElementById(`name-${workshopId}`).value;
                const description = document.getElementById(`description-${workshopId}`).value;
                const category = document.getElementById(`category-${workshopId}`).value;
                const childPrice = parseFloat(document.getElementById(`childPrice-${workshopId}`).value);
                const adultPrice = parseFloat(document.getElementById(`adultPrice-${workshopId}`).value);

                // Basic validation
                if (!name || childPrice < 0 || adultPrice < 0) {
                    this.showMessage('Please enter valid name and prices', 'error');
                    return;
                }

                // Update the workshop in memory
                const index = this.workshopCatalog.findIndex(w => w.id === workshopId);
                if (index !== -1) {
                    this.workshopCatalog[index] = {
                        ...this.workshopCatalog[index],
                        name,
                        description,
                        category,
                        child_price: childPrice,
                        adult_price: adultPrice
                    };
                }

                // Re-render the catalog
                this.renderWorkshopCatalog();
                this.showMessage(`Workshop "${name}" pricing updated successfully!`, 'success');
            }

            deleteWorkshop(workshopId) {
                if (!confirm('Are you sure you want to delete this workshop?')) {
                    return;
                }

                this.workshopCatalog = this.workshopCatalog.filter(w => w.id !== workshopId);
                this.renderWorkshopCatalog();
                this.showMessage('Workshop deleted', 'success');
            }

            showMessage(message, type) {
                const container = document.getElementById('messages');
                const alertClass = type === 'error' ? 'alert-error' : 'alert-success';

                container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        // Global functions for workshop management
        function addNewWorkshop() {
            const id = prompt('Enter workshop ID (e.g., "advanced-solar"):');
            const name = prompt('Enter workshop name (e.g., "⚡ Advanced Solar Lab"):');

            if (id && name) {
                // Check if ID already exists
                if (window.pricingManager.workshopCatalog.some(w => w.id === id)) {
                    alert('Workshop ID already exists. Please choose a different ID.');
                    return;
                }

                const newWorkshop = {
                    id: id,
                    name: name,
                    description: 'Description pending...',
                    child_price: 15.00,
                    adult_price: 25.00,
                    category: 'Technology'
                };

                window.pricingManager.workshopCatalog.push(newWorkshop);
                window.pricingManager.renderWorkshopCatalog();
                window.pricingManager.showMessage(`New workshop "${name}" added! Click Edit to configure details.`, 'success');
            }
        }

        // Initialize when DOM is loaded and Supabase is ready
        document.addEventListener('DOMContentLoaded', function() {
            function waitForSupabaseClient() {
                if (typeof supabaseClient !== 'undefined') {
                    window.pricingManager = new PricingManager();
                } else {
                    setTimeout(waitForSupabaseClient, 100);
                }
            }
            waitForSupabaseClient();
        });
    </script>
</body>
</html>