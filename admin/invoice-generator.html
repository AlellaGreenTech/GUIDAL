<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator - GUIDAL Admin</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .admin-nav {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .admin-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 2rem;
        }

        .admin-nav a {
            text-decoration: none;
            color: #495057;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .admin-nav a:hover,
        .admin-nav a.active {
            background: #1565c0;
            color: white;
        }

        .invoice-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .visit-selector {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .invoice-preview {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 2rem;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .visit-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .visit-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #1565c0;
        }

        .visit-card.selected {
            border-color: #1565c0;
            background: #e3f2fd;
        }

        .visit-card h4 {
            margin: 0 0 0.5rem 0;
            color: #1565c0;
        }

        .visit-details {
            font-size: 0.9rem;
            color: #666;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            width: fit-content;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-needs-invoice {
            background: #fff3cd;
            color: #856404;
        }

        .invoice-header {
            border-bottom: 2px solid #1565c0;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .invoice-header h2 {
            margin: 0;
            color: #1565c0;
        }

        .invoice-header .invoice-number {
            font-size: 0.9rem;
            color: #666;
        }

        .invoice-section {
            margin-bottom: 1.5rem;
        }

        .invoice-section h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            color: #333;
        }

        .pricing-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            table-layout: fixed;
        }

        .pricing-table th,
        .pricing-table td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            word-wrap: break-word;
        }

        .pricing-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .pricing-table th:nth-child(1),
        .pricing-table td:nth-child(1) {
            width: 45%;
        }

        .pricing-table th:nth-child(2),
        .pricing-table td:nth-child(2) {
            width: 15%;
            text-align: center;
        }

        .pricing-table th:nth-child(3),
        .pricing-table td:nth-child(3) {
            width: 20%;
            text-align: right;
        }

        .pricing-table th:nth-child(4),
        .pricing-table td:nth-child(4) {
            width: 20%;
            text-align: right;
            font-weight: 600;
        }

        .total-section {
            border-top: 2px solid #1565c0;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .total-row.final {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1565c0;
            border-top: 1px solid #dee2e6;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #1565c0;
            color: white;
        }

        .btn-primary:hover {
            background: #0d47a1;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-block {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .form-group select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        @media (max-width: 1024px) {
            .invoice-container {
                grid-template-columns: 1fr;
            }

            .invoice-preview {
                position: static;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .visit-details {
                grid-template-columns: 1fr;
            }

            .admin-nav ul {
                flex-direction: column;
                gap: 0.5rem;
            }

            .pricing-table {
                font-size: 0.85rem;
            }

            .pricing-table th,
            .pricing-table td {
                padding: 0.5rem 0.25rem;
            }

            .pricing-table th:nth-child(1),
            .pricing-table td:nth-child(1) {
                width: 40%;
            }

            .pricing-table th:nth-child(2),
            .pricing-table td:nth-child(2) {
                width: 12%;
            }

            .pricing-table th:nth-child(3),
            .pricing-table td:nth-child(3) {
                width: 24%;
            }

            .pricing-table th:nth-child(4),
            .pricing-table td:nth-child(4) {
                width: 24%;
            }
        }

        @media print {
            .admin-header,
            .admin-nav,
            .visit-selector,
            .btn,
            body > *:not(.invoice-preview) {
                display: none !important;
            }

            .invoice-preview {
                position: static !important;
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .invoice-container {
                display: block !important;
            }
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="container">
            <h1>üí∞ Invoice Generator</h1>
            <p>Generate invoices for completed visits and events</p>
        </div>
    </div>

    <nav class="admin-nav">
        <div class="container">
            <ul>
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="visits.html">Visits</a></li>
                <li><a href="events-management.html">Events & Workshops</a></li>
                <li><a href="pricing-management.html">Pricing</a></li>
                <li><a href="invoice-generator.html" class="active">Invoice Generator</a></li>
                <li><a href="../index.html">Back to Site</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div class="invoice-container">
            <!-- Visit Selector -->
            <div class="visit-selector">
                <h3>üè´ Select Visit to Invoice</h3>

                <!-- Filters -->
                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="statusFilter">Status Filter</label>
                            <select id="statusFilter">
                                <option value="needs-invoice">Needs Invoice</option>
                                <option value="completed">All Completed</option>
                                <option value="all">All Visits</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="typeFilter">Visit Type</label>
                            <select id="typeFilter">
                                <option value="all">All Types</option>
                                <option value="school-visit">School Visits</option>
                                <option value="workshop">Workshops</option>
                                <option value="special-lunch">Special Lunches</option>
                                <option value="family-visit">Family Visits</option>
                                <option value="corporate-visit">Corporate Events</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Visit List -->
                <div id="visitsList">
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        Loading visits...
                    </div>
                </div>
            </div>

            <!-- Invoice Preview -->
            <div class="invoice-preview">
                <div id="invoiceContent">
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        Select a visit to generate invoice
                    </div>
                </div>

                <!-- Custom Items Section -->
                <div id="customItemsSection" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                    <h4>Add Custom Items</h4>
                    <div style="display: grid; grid-template-columns: 2fr 80px 100px 100px auto; gap: 0.5rem; align-items: end; margin-bottom: 0.5rem;">
                        <input type="text" id="customDescription" placeholder="Item description" style="padding: 0.5rem;">
                        <input type="number" id="customQuantity" placeholder="Qty" min="1" value="1" style="padding: 0.5rem;">
                        <input type="number" id="customPrice" placeholder="‚Ç¨0.00" step="0.01" style="padding: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="addCustomItem()">+ Add</button>
                    </div>
                    <div id="customItemsList"></div>
                </div>

                <div id="invoiceActions" style="display: none;">
                    <button class="btn btn-primary btn-block" onclick="toggleCustomItems()" id="customItemsBtn">‚ûï Add Custom Items</button>
                    <button class="btn btn-warning btn-block" onclick="openFullPageInvoice()">üîç Full Page View</button>
                    <button class="btn btn-primary btn-block" onclick="printInvoice()">üñ®Ô∏è Print Invoice</button>
                    <button class="btn btn-success btn-block" onclick="markAsInvoiced()">‚úÖ Mark as Invoiced</button>
                    <button class="btn btn-primary btn-block" onclick="downloadPDF()">üìÑ Download PDF</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Load required scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="js/auth-guard.js"></script>
    <script>
        class InvoiceGenerator {
            constructor() {
                this.selectedVisit = null;
                this.pricingData = null;
                this.init();
            }

            async init() {
                console.log('üí∞ Initializing Invoice Generator...');
                await this.loadPricingData();

                // Check for pre-selected visit from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const visitId = urlParams.get('visit');
                this.preSelectedVisitId = visitId;

                if (visitId) {
                    console.log('üîç URL visitId found:', visitId);
                    // Set filter to "all" to ensure we can find any visit
                    document.getElementById('statusFilter').value = 'all';
                    document.getElementById('typeFilter').value = 'all';
                }

                await this.loadVisits();
                this.setupEventHandlers();

                // Auto-select visit after loading is complete
                if (this.preSelectedVisitId) {
                    await this.autoSelectVisit(this.preSelectedVisitId);
                }
            }

            async autoSelectVisit(visitId) {
                console.log('üéØ Attempting to auto-select visit:', visitId);

                if (this.visitsData && this.visitsData[visitId]) {
                    console.log('‚úÖ Auto-selecting visit:', visitId);
                    this.selectVisit(visitId);

                    // Scroll to the selected visit card
                    setTimeout(() => {
                        const selectedCard = document.querySelector(`[data-visit-id="${visitId}"]`);
                        if (selectedCard) {
                            selectedCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                } else {
                    console.log('‚ùå Visit not found with ID:', visitId);
                    console.log('Available visits:', Object.keys(this.visitsData || {}));

                    // Try to fetch the specific visit if not in filtered results
                    await this.fetchSpecificVisit(visitId);
                }
            }

            async fetchSpecificVisit(visitId) {
                try {
                    console.log('üîç Fetching specific visit:', visitId);

                    // Show loading message
                    const loadingMessage = document.createElement('div');
                    loadingMessage.id = 'loading-specific-visit';
                    loadingMessage.innerHTML = `
                        <div style="background: #e3f2fd; color: #1565c0; padding: 1rem; border-radius: 4px; margin: 1rem 0; border-left: 4px solid #1565c0;">
                            üîç <strong>Loading invoice for visit:</strong> ${visitId.substring(0, 8)}...
                        </div>
                    `;
                    document.querySelector('.visit-selector').insertBefore(loadingMessage, document.getElementById('visitsList'));

                    const { data: visit, error } = await supabaseClient
                        .from('visits')
                        .select('*')
                        .eq('id', visitId)
                        .single();

                    // Remove loading message
                    const loadingEl = document.getElementById('loading-specific-visit');
                    if (loadingEl) loadingEl.remove();

                    if (error) {
                        console.error('‚ùå Database error:', error);
                        throw error;
                    }

                    if (visit) {
                        console.log('‚úÖ Found specific visit:', visit.school_name);
                        console.log('üìÑ Visit details:', {
                            id: visit.id,
                            school: visit.school_name,
                            status: visit.status,
                            invoice_status: visit.invoice_status
                        });

                        // Add to visits data
                        this.visitsData = this.visitsData || {};
                        this.visitsData[visitId] = visit;

                        // Add to the display list
                        this.addVisitToDisplay(visit);

                        // Select it
                        this.selectVisit(visitId);

                        // Show success message
                        const statusMessage = document.createElement('div');
                        statusMessage.innerHTML = `
                            <div style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 4px; margin: 1rem 0; border-left: 4px solid #28a745;">
                                ‚úÖ <strong>Invoice loaded for:</strong> ${visit.school_name}
                            </div>
                        `;
                        document.querySelector('.visit-selector').insertBefore(statusMessage, document.getElementById('visitsList'));

                        // Remove message after 5 seconds
                        setTimeout(() => statusMessage.remove(), 5000);
                    } else {
                        throw new Error('Visit data is null');
                    }
                } catch (error) {
                    console.error('‚ùå Error fetching specific visit:', error);

                    // Remove loading message if still there
                    const loadingEl = document.getElementById('loading-specific-visit');
                    if (loadingEl) loadingEl.remove();

                    // Show detailed error message
                    const errorMessage = document.createElement('div');
                    errorMessage.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 4px; margin: 1rem 0; border-left: 4px solid #dc3545;">
                            ‚ùå <strong>Could not load visit:</strong> ${visitId.substring(0, 8)}...<br>
                            <small><strong>Error:</strong> ${error.message}</small><br>
                            <small><strong>Debug info:</strong> Check browser console for details</small><br>
                            <button onclick="location.reload()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #721c24; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üîÑ Retry Page
                            </button>
                        </div>
                    `;
                    document.querySelector('.visit-selector').insertBefore(errorMessage, document.getElementById('visitsList'));

                    // Also try to load all visits to show something useful
                    console.log('üîÑ Attempting to load all visits as fallback...');
                    document.getElementById('statusFilter').value = 'all';
                    await this.loadVisits();
                }
            }

            addVisitToDisplay(visit) {
                const container = document.getElementById('visitsList');
                const visitCard = document.createElement('div');
                visitCard.innerHTML = `
                    <div class="visit-card" onclick="selectVisit('${visit.id}')" data-visit-id="${visit.id}">
                        <h4>${this.getVisitTypeIcon(visit.visit_type)} ${visit.school_name}</h4>
                        <div class="visit-details">
                            <div><strong>Contact:</strong> ${visit.contact_name}</div>
                            <div><strong>Date:</strong> ${new Date(visit.preferred_date).toLocaleDateString()}</div>
                            <div><strong>Participants:</strong> ${visit.student_count + (visit.teacher_count || 0)}</div>
                            <div><strong>Type:</strong> ${this.getVisitTypeLabel(visit.visit_type)}</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${visit.invoice_status === 'not-invoiced' ? 'status-needs-invoice' : 'status-completed'}">
                                ${visit.invoice_status === 'not-invoiced' ? 'Needs Invoice' : 'Invoiced'}
                            </span>
                        </div>
                    </div>
                `;

                // Add to top of list
                const firstCard = container.querySelector('.visit-card');
                if (firstCard) {
                    container.insertBefore(visitCard.firstElementChild, firstCard);
                } else {
                    container.innerHTML = '';
                    container.appendChild(visitCard.firstElementChild);
                }
            }

            async loadPricingData() {
                try {
                    // Load standard pricing
                    const { data: standardPricing } = await supabaseClient
                        .from('pricing_config')
                        .select('*')
                        .eq('is_active', true)
                        .single();

                    // Load school overrides
                    const { data: schoolPricing } = await supabaseClient
                        .from('school_pricing_overrides')
                        .select('*')
                        .eq('is_active', true);

                    this.pricingData = {
                        standard: standardPricing,
                        schools: schoolPricing || []
                    };

                    console.log('‚úÖ Pricing data loaded');
                } catch (error) {
                    console.error('Error loading pricing data:', error);
                }
            }

            async loadVisits() {
                try {
                    console.log('üìã Loading visits...');
                    const statusFilter = document.getElementById('statusFilter').value;
                    const typeFilter = document.getElementById('typeFilter').value;

                    console.log('üîç Filters:', { statusFilter, typeFilter, preSelectedVisitId: this.preSelectedVisitId });

                    let query = supabaseClient
                        .from('visits')
                        .select('*')
                        .order('preferred_date', { ascending: false });

                    // Apply status filter
                    if (statusFilter === 'needs-invoice') {
                        query = query.eq('status', 'completed').eq('invoice_status', 'not-invoiced');
                    } else if (statusFilter === 'completed') {
                        query = query.eq('status', 'completed');
                    }

                    // Apply type filter
                    if (typeFilter !== 'all') {
                        query = query.eq('visit_type', typeFilter);
                    }

                    const { data: visits, error } = await query;

                    if (error) {
                        console.error('‚ùå Database error:', error);
                        throw error;
                    }

                    console.log(`‚úÖ Loaded ${visits?.length || 0} visits from database`);

                    // Store visits data for later use
                    this.visitsData = visits.reduce((acc, visit) => {
                        acc[visit.id] = visit;
                        return acc;
                    }, {});

                    console.log('üìä Available visit IDs:', Object.keys(this.visitsData));

                    // If we have a pre-selected visit ID, check if it's in the results
                    if (this.preSelectedVisitId && !this.visitsData[this.preSelectedVisitId]) {
                        console.log('‚ö†Ô∏è Pre-selected visit not in filtered results, will fetch separately');
                    }

                    this.renderVisitsList(visits);

                } catch (error) {
                    console.error('‚ùå Error loading visits:', error);
                    document.getElementById('visitsList').innerHTML = `
                        <div style="text-align: center; color: #721c24; background: #f8d7da; padding: 1rem; border-radius: 4px;">
                            <strong>Error loading visits:</strong><br>
                            ${error.message}<br>
                            <button onclick="location.reload()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #721c24; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üîÑ Retry
                            </button>
                        </div>
                    `;
                }
            }

            renderVisitsList(visits) {
                const container = document.getElementById('visitsList');

                if (!visits || visits.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No visits found for the selected filters.</p>';
                    return;
                }

                const html = visits.map(visit => `
                    <div class="visit-card" onclick="selectVisit('${visit.id}')" data-visit-id="${visit.id}">
                        <h4>${this.getVisitTypeIcon(visit.visit_type)} ${visit.school_name}</h4>
                        <div class="visit-details">
                            <div><strong>Contact:</strong> ${visit.contact_name}</div>
                            <div><strong>Date:</strong> ${new Date(visit.preferred_date).toLocaleDateString()}</div>
                            <div><strong>Participants:</strong> ${visit.student_count + (visit.teacher_count || 0)}</div>
                            <div><strong>Type:</strong> ${this.getVisitTypeLabel(visit.visit_type)}</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span class="status-badge ${visit.invoice_status === 'not-invoiced' ? 'status-needs-invoice' : 'status-completed'}">
                                ${visit.invoice_status === 'not-invoiced' ? 'Needs Invoice' : 'Invoiced'}
                            </span>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = html;
            }

            getVisitTypeIcon(visitType) {
                const icons = {
                    'school-visit': 'üè´',
                    'workshop': 'üî¨',
                    'special-lunch': 'üçΩÔ∏è',
                    'family-visit': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                    'corporate-visit': 'üè¢',
                    'individual-visit': 'üë§',
                    'homeschool-visit': 'üè†'
                };
                return icons[visitType] || 'üìã';
            }

            getVisitTypeLabel(visitType) {
                const labels = {
                    'school-visit': 'School Visit',
                    'workshop': 'Workshop',
                    'special-lunch': 'Special Lunch',
                    'family-visit': 'Family Visit',
                    'corporate-visit': 'Corporate Event',
                    'individual-visit': 'Individual Visit',
                    'homeschool-visit': 'Homeschool Visit'
                };
                return labels[visitType] || visitType;
            }

            selectVisit(visitId) {
                // Remove previous selection
                document.querySelectorAll('.visit-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Add selection to clicked card if it exists
                const cardElement = document.querySelector(`[data-visit-id="${visitId}"]`);
                if (cardElement) {
                    cardElement.classList.add('selected');
                }

                // Store selected visit
                this.selectedVisit = this.visitsData[visitId];

                // Generate invoice
                this.generateInvoice();
            }

            generateInvoice() {
                if (!this.selectedVisit) return;

                const visit = this.selectedVisit;
                const pricing = this.calculatePricing(visit);

                const invoiceNumber = `INV-${visit.id.substring(0, 8).toUpperCase()}-${new Date().getFullYear()}`;
                const invoiceDate = new Date().toLocaleDateString();

                const html = `
                    <div class="invoice-header">
                        <h2>INVOICE</h2>
                        <div class="invoice-number">Invoice #: ${invoiceNumber}</div>
                        <div class="invoice-number">Date: ${invoiceDate}</div>
                    </div>

                    <div class="invoice-section">
                        <h3>From:</h3>
                        <strong>Alella Green Tech Foundation</strong><br>
                        International Green Tech Foundation<br>
                        Alella, Spain<br>
                        Email: info@alellagreentech.org
                    </div>

                    <div class="invoice-section">
                        <h3>To:</h3>
                        <strong>${visit.school_name}</strong><br>
                        Contact: ${visit.contact_name}<br>
                        Email: ${visit.contact_email}<br>
                        ${visit.contact_phone ? `Phone: ${visit.contact_phone}<br>` : ''}
                    </div>

                    <div class="invoice-section">
                        <h3>Visit Details:</h3>
                        <strong>${this.getVisitTypeIcon(visit.visit_type)} ${this.getVisitTypeLabel(visit.visit_type)}</strong><br>
                        Date: ${new Date(visit.preferred_date).toLocaleDateString()}<br>
                        Duration: ${visit.visit_duration}<br>
                        Educational Focus: ${visit.educational_focus || 'General'}
                    </div>

                    <table class="pricing-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th class="amount">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pricing.lineItems.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.quantity}</td>
                                    <td>‚Ç¨${item.unitPrice.toFixed(2)}</td>
                                    <td class="amount">‚Ç¨${item.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span>‚Ç¨${pricing.subtotal.toFixed(2)}</span>
                        </div>
                        <div class="total-row">
                            <span>VAT (${pricing.vatRate}%):</span>
                            <span>‚Ç¨${pricing.vatAmount.toFixed(2)}</span>
                        </div>
                        <div class="total-row final">
                            <span>Total:</span>
                            <span>‚Ç¨${pricing.total.toFixed(2)}</span>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; font-size: 0.9rem; color: #666;">
                        <p><strong>Payment Terms:</strong> Net 30 days</p>
                        <p><strong>Notes:</strong> ${visit.additional_requests || 'Thank you for visiting Alella Green Tech!'}</p>
                    </div>
                `;

                document.getElementById('invoiceContent').innerHTML = html;
                document.getElementById('invoiceActions').style.display = 'block';
                document.getElementById('customItemsSection').style.display = 'none';

                // Store original pricing for recalculation with custom items
                this.originalPricing = pricing;
            }

            getVisitTypePricing(visitType) {
                // Default visit type pricing configuration (same as pricing management)
                const visitTypePricing = [
                    { visit_type: 'school-visit', display_name: 'üè´ School Visit', child_price: 15, adult_price: 25, free_adults: 0, meal_child: 8, meal_adult: 12 },
                    { visit_type: 'workshop-class-a', display_name: 'üî¨ Workshop Class A', child_price: 20, adult_price: 30, free_adults: 2, meal_child: 8, meal_adult: 12 },
                    { visit_type: 'workshop-class-b', display_name: 'üß™ Workshop Class B', child_price: 25, adult_price: 35, free_adults: 1, meal_child: 10, meal_adult: 15 },
                    { visit_type: 'workshop-class-c', display_name: '‚öóÔ∏è Workshop Class C', child_price: 35, adult_price: 45, free_adults: 0, meal_child: 12, meal_adult: 18 },
                    { visit_type: 'special-lunch', display_name: 'üçΩÔ∏è Special Lunch', child_price: 15, adult_price: 20, free_adults: 1, meal_child: 0, meal_adult: 0 },
                    { visit_type: 'family-visit', display_name: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Visit', child_price: 12, adult_price: 18, free_adults: 0, meal_child: 8, meal_adult: 12 },
                    { visit_type: 'corporate-visit', display_name: 'üè¢ Corporate Event', child_price: 40, adult_price: 40, free_adults: 0, meal_child: 20, meal_adult: 20 }
                ];

                return visitTypePricing.find(vt => vt.visit_type === visitType);
            }

            calculatePricing(visit) {
                const lineItems = [];
                let subtotal = 0;

                // Check for visit-type-specific pricing first
                const visitTypePricing = this.getVisitTypePricing(visit.visit_type);

                // Check for school-specific pricing
                const schoolPricing = this.pricingData.schools.find(s =>
                    s.school_name === visit.school_name
                );

                // Determine pricing rates priority: school override > visit type > standard pricing
                const rates = schoolPricing || visitTypePricing || this.pricingData.standard;

                if (!rates) {
                    console.error('No pricing rates found');
                    return { lineItems: [], subtotal: 0, vatAmount: 0, total: 0, vatRate: 21 };
                }

                // Calculate visit fees
                if (visit.student_count > 0) {
                    const childPrice = rates.child_price || rates.visit_price_child || 15;
                    const childTotal = visit.student_count * childPrice;
                    lineItems.push({
                        description: `Visit - Children (${visit.student_count} participants)`,
                        quantity: visit.student_count,
                        unitPrice: childPrice,
                        total: childTotal
                    });
                    subtotal += childTotal;
                }

                if (visit.teacher_count > 0) {
                    const adultPrice = rates.adult_price || rates.visit_price_adult || 25;
                    const freeAdults = rates.free_adults || 0;
                    const chargeableAdults = Math.max(0, visit.teacher_count - freeAdults);

                    if (chargeableAdults > 0) {
                        const adultTotal = chargeableAdults * adultPrice;
                        lineItems.push({
                            description: `Visit - Adults (${chargeableAdults} chargeable${freeAdults > 0 ? `, ${freeAdults} free` : ''})`,
                            quantity: chargeableAdults,
                            unitPrice: adultPrice,
                            total: adultTotal
                        });
                        subtotal += adultTotal;
                    } else if (freeAdults > 0) {
                        lineItems.push({
                            description: `Visit - Adults (${visit.teacher_count} free)`,
                            quantity: visit.teacher_count,
                            unitPrice: 0,
                            total: 0
                        });
                    }
                }

                // Calculate meal fees if applicable
                if (visit.lunch_needs && visit.lunch_needs !== 'none' && visit.lunch_needs !== 'own_lunch') {
                    const childMealPrice = rates.meal_child || rates.meal_price_child || 8;
                    const adultMealPrice = rates.meal_adult || rates.meal_price_adult || 12;

                    if (visit.student_count > 0) {
                        const childMealTotal = visit.student_count * childMealPrice;
                        lineItems.push({
                            description: `Meals - Children (${visit.lunch_needs})`,
                            quantity: visit.student_count,
                            unitPrice: childMealPrice,
                            total: childMealTotal
                        });
                        subtotal += childMealTotal;
                    }

                    if (visit.teacher_count > 0) {
                        const adultMealTotal = visit.teacher_count * adultMealPrice;
                        lineItems.push({
                            description: `Meals - Adults (${visit.lunch_needs})`,
                            quantity: visit.teacher_count,
                            unitPrice: adultMealPrice,
                            total: adultMealTotal
                        });
                        subtotal += adultMealTotal;
                    }
                }

                // Calculate VAT
                const vatRate = rates.vat_rate || this.pricingData.standard?.vat_rate || 21;
                const vatAmount = subtotal * (vatRate / 100);
                const total = subtotal + vatAmount;

                return {
                    lineItems,
                    subtotal,
                    vatAmount,
                    total,
                    vatRate
                };
            }

            setupEventHandlers() {
                document.getElementById('statusFilter').addEventListener('change', () => {
                    this.loadVisits();
                });

                document.getElementById('typeFilter').addEventListener('change', () => {
                    this.loadVisits();
                });
            }

            async markAsInvoiced() {
                if (!this.selectedVisit) return;

                try {
                    const { error } = await supabaseClient
                        .from('visits')
                        .update({
                            invoice_status: 'invoiced',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', this.selectedVisit.id);

                    if (error) throw error;

                    alert('‚úÖ Visit marked as invoiced!');
                    await this.loadVisits();

                    // Clear selection
                    this.selectedVisit = null;
                    document.getElementById('invoiceContent').innerHTML =
                        '<div style="text-align: center; padding: 3rem; color: #666;">Select a visit to generate invoice</div>';
                    document.getElementById('invoiceActions').style.display = 'none';

                } catch (error) {
                    console.error('Error marking as invoiced:', error);
                    alert('‚ùå Error updating invoice status');
                }
            }
        }

        // Global functions for onclick handlers
        let invoiceGenerator;

        function selectVisit(visitId) {
            invoiceGenerator.selectVisit(visitId);
        }

        function printInvoice() {
            window.print();
        }

        function markAsInvoiced() {
            invoiceGenerator.markAsInvoiced();
        }

        function downloadPDF() {
            // This would integrate with a PDF generation service
            alert('PDF download functionality would be implemented here with a service like jsPDF or server-side PDF generation');
        }

        function openFullPageInvoice() {
            if (!invoiceGenerator.selectedVisit) {
                alert('No visit selected for invoice generation');
                return;
            }

            // Get the current invoice content
            const invoiceContent = document.getElementById('invoiceContent').innerHTML;

            // Create a new window for the full-page invoice
            const fullPageWindow = window.open('', '_blank', 'width=1000,height=800,scrollbars=yes,resizable=yes');

            // Write the full-page HTML
            fullPageWindow.document.write(`
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Invoice - ${invoiceGenerator.selectedVisit.school_name}</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 2rem;
                            background: white;
                        }

                        .invoice-header {
                            text-align: center;
                            margin-bottom: 2rem;
                            border-bottom: 3px solid #1565c0;
                            padding-bottom: 1rem;
                        }

                        .invoice-header h2 {
                            margin: 0;
                            font-size: 2.5rem;
                            color: #1565c0;
                        }

                        .invoice-number {
                            font-size: 1.1rem;
                            color: #666;
                            margin: 0.5rem 0;
                        }

                        .invoice-section {
                            margin: 1.5rem 0;
                            padding: 1rem;
                            background: #f8f9fa;
                            border-left: 4px solid #1565c0;
                            border-radius: 4px;
                        }

                        .invoice-section h3 {
                            margin: 0 0 0.5rem 0;
                            color: #1565c0;
                            font-size: 1.2rem;
                        }

                        .pricing-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 2rem 0;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        }

                        .pricing-table th,
                        .pricing-table td {
                            padding: 1rem;
                            text-align: left;
                            border-bottom: 1px solid #dee2e6;
                        }

                        .pricing-table th {
                            background: #1565c0;
                            color: white;
                            font-weight: 600;
                            text-transform: uppercase;
                            font-size: 0.9rem;
                            letter-spacing: 0.5px;
                        }

                        .pricing-table tbody tr:nth-child(even) {
                            background: #f8f9fa;
                        }

                        .pricing-table tbody tr:hover {
                            background: #e3f2fd;
                        }

                        .pricing-table th:nth-child(1),
                        .pricing-table td:nth-child(1) { width: 45%; }
                        .pricing-table th:nth-child(2),
                        .pricing-table td:nth-child(2) { width: 15%; text-align: center; }
                        .pricing-table th:nth-child(3),
                        .pricing-table td:nth-child(3) { width: 20%; text-align: right; }
                        .pricing-table th:nth-child(4),
                        .pricing-table td:nth-child(4) { width: 20%; text-align: right; font-weight: 600; }

                        .total-section {
                            border-top: 3px solid #1565c0;
                            padding-top: 1rem;
                            margin-top: 2rem;
                            text-align: right;
                        }

                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            padding: 0.5rem 0;
                            font-size: 1.1rem;
                        }

                        .total-row.final {
                            border-top: 2px solid #1565c0;
                            margin-top: 1rem;
                            padding-top: 1rem;
                            font-size: 1.3rem;
                            font-weight: bold;
                            color: #1565c0;
                        }

                        .actions-bar {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            display: flex;
                            gap: 10px;
                            z-index: 1000;
                        }

                        .btn {
                            padding: 0.5rem 1rem;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 600;
                            text-decoration: none;
                            display: inline-block;
                            transition: all 0.3s ease;
                        }

                        .btn-primary { background: #1565c0; color: white; }
                        .btn-primary:hover { background: #0d47a1; }
                        .btn-success { background: #28a745; color: white; }
                        .btn-success:hover { background: #218838; }

                        @media print {
                            .actions-bar { display: none; }
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="actions-bar">
                        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print</button>
                        <button class="btn btn-success" onclick="window.close()">‚úÖ Close</button>
                    </div>

                    ${invoiceContent}

                    <script>
                        // Focus the window
                        window.focus();

                        // Optional: Auto-print dialog
                        // window.print();
                    </script>
                </body>
                </html>
            `);

            fullPageWindow.document.close();
        }

        // Custom items functionality
        let customItems = [];

        function toggleCustomItems() {
            const section = document.getElementById('customItemsSection');
            const btn = document.getElementById('customItemsBtn');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                btn.textContent = '‚ûñ Hide Custom Items';
            } else {
                section.style.display = 'none';
                btn.textContent = '‚ûï Add Custom Items';
            }
        }

        function addCustomItem() {
            const description = document.getElementById('customDescription').value;
            const quantity = parseInt(document.getElementById('customQuantity').value) || 1;
            const price = parseFloat(document.getElementById('customPrice').value) || 0;

            if (!description || price <= 0) {
                alert('Please enter a description and valid price');
                return;
            }

            const customItem = {
                id: Date.now(),
                description,
                quantity,
                unitPrice: price,
                total: quantity * price
            };

            customItems.push(customItem);
            updateCustomItemsList();
            regenerateInvoiceWithCustomItems();

            // Clear form
            document.getElementById('customDescription').value = '';
            document.getElementById('customQuantity').value = '1';
            document.getElementById('customPrice').value = '';
        }

        function removeCustomItem(itemId) {
            customItems = customItems.filter(item => item.id !== itemId);
            updateCustomItemsList();
            regenerateInvoiceWithCustomItems();
        }

        function updateCustomItemsList() {
            const container = document.getElementById('customItemsList');

            if (customItems.length === 0) {
                container.innerHTML = '';
                return;
            }

            const html = customItems.map(item => `
                <div style="display: grid; grid-template-columns: 2fr 80px 100px 100px auto; gap: 0.5rem; align-items: center; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.25rem;">
                    <div>${item.description}</div>
                    <div>${item.quantity}</div>
                    <div>‚Ç¨${item.unitPrice.toFixed(2)}</div>
                    <div>‚Ç¨${item.total.toFixed(2)}</div>
                    <button class="btn btn-danger btn-sm" onclick="removeCustomItem(${item.id})" style="background: #dc3545; color: white; padding: 0.4rem 0.6rem; border-radius: 4px; border: none; cursor: pointer; font-weight: bold;">üóëÔ∏è</button>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function regenerateInvoiceWithCustomItems() {
            if (!invoiceGenerator.selectedVisit || !invoiceGenerator.originalPricing) return;

            // Combine original items with custom items
            const allLineItems = [...invoiceGenerator.originalPricing.lineItems, ...customItems];

            // Recalculate totals
            const subtotal = allLineItems.reduce((sum, item) => sum + item.total, 0);
            const vatRate = invoiceGenerator.originalPricing.vatRate;
            const vatAmount = subtotal * (vatRate / 100);
            const total = subtotal + vatAmount;

            // Update the invoice display
            const visit = invoiceGenerator.selectedVisit;
            const invoiceNumber = `INV-${visit.id.substring(0, 8).toUpperCase()}-${new Date().getFullYear()}`;
            const invoiceDate = new Date().toLocaleDateString();

            const html = `
                <div class="invoice-header">
                    <h2>INVOICE</h2>
                    <div class="invoice-number">Invoice #: ${invoiceNumber}</div>
                    <div class="invoice-number">Date: ${invoiceDate}</div>
                </div>

                <div class="invoice-section">
                    <h3>From:</h3>
                    <strong>Alella Green Tech Foundation</strong><br>
                    International Green Tech Foundation<br>
                    Alella, Spain<br>
                    Email: info@alellagreentech.org
                </div>

                <div class="invoice-section">
                    <h3>To:</h3>
                    <strong>${visit.school_name}</strong><br>
                    Contact: ${visit.contact_name}<br>
                    Email: ${visit.contact_email}<br>
                    ${visit.contact_phone ? `Phone: ${visit.contact_phone}<br>` : ''}
                </div>

                <div class="invoice-section">
                    <h3>Visit Details:</h3>
                    <strong>${invoiceGenerator.getVisitTypeIcon(visit.visit_type)} ${invoiceGenerator.getVisitTypeLabel(visit.visit_type)}</strong><br>
                    Date: ${new Date(visit.preferred_date).toLocaleDateString()}<br>
                    Duration: ${visit.visit_duration}<br>
                    Educational Focus: ${visit.educational_focus || 'General'}
                </div>

                <table class="pricing-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th class="amount">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allLineItems.map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.quantity}</td>
                                <td>‚Ç¨${item.unitPrice.toFixed(2)}</td>
                                <td class="amount">‚Ç¨${item.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div class="total-section">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>‚Ç¨${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>VAT (${vatRate}%):</span>
                        <span>‚Ç¨${vatAmount.toFixed(2)}</span>
                    </div>
                    <div class="total-row final">
                        <span>Total:</span>
                        <span>‚Ç¨${total.toFixed(2)}</span>
                    </div>
                </div>

                <div style="margin-top: 2rem; font-size: 0.9rem; color: #666;">
                    <p><strong>Payment Terms:</strong> Net 30 days</p>
                    <p><strong>Notes:</strong> ${visit.additional_requests || 'Thank you for visiting Alella Green Tech!'}</p>
                </div>
            `;

            document.getElementById('invoiceContent').innerHTML = html;
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced initialization with retry mechanism
            let initAttempts = 0;
            const maxAttempts = 10;

            function tryInitialization() {
                initAttempts++;
                console.log(`üîÑ Attempt ${initAttempts}: Checking for supabaseClient...`);

                if (typeof supabaseClient !== 'undefined') {
                    console.log('‚úÖ Supabase client found, initializing invoice generator...');
                    invoiceGenerator = new InvoiceGenerator();
                } else if (initAttempts < maxAttempts) {
                    console.log('‚è≥ Waiting for supabaseClient...');
                    setTimeout(tryInitialization, 500);
                } else {
                    console.error('‚ùå Failed to load Supabase client after', maxAttempts, 'attempts');
                    // Show error message to user
                    const container = document.querySelector('main .container');
                    if (container) {
                        container.innerHTML = `
                            <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 1rem; border-radius: 4px; margin: 2rem 0;">
                                <h3>‚ö†Ô∏è Loading Error</h3>
                                <p>Unable to connect to the database. Please check your internet connection and try refreshing the page.</p>
                                <button onclick="location.reload()" style="background: #721c24; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
                                    üîÑ Retry
                                </button>
                            </div>
                        `;
                    }
                }
            }

            // Start trying to initialize
            tryInitialization();
        });
    </script>
</body>
</html>