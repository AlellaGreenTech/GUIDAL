<!DOCTYPE html>
<html>
<head>
    <title>Test Visit Creation - GUIDAL</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .info { background: #e3f2fd; color: #1976d2; }
        .btn { background: #1565c0; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test Visit Creation</h1>
    <p>This will test creating a visit with minimal required fields to understand the schema.</p>

    <div id="status"></div>
    <button onclick="testMinimalVisit()" class="btn">Test Minimal Visit</button>
    <button onclick="testEventVisit()" class="btn">Test Event Visit</button>

    <div id="results"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://lmsuyhzcmgdpjynosxvp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxtc3V5aHpjbWdkcGp5bm9zeHZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NzM5NjksImV4cCI6MjA3MzI0OTk2OX0.rRpHs_0ZLW3erdFnm2SwFTAmyQJYRMpcSlNzMBlcq4U';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function appendResults(content) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += content;
        }

        async function testMinimalVisit() {
            showStatus('üß™ Testing minimal visit creation...', 'info');
            appendResults('<h3>üß™ Minimal Visit Test</h3>');

            const minimalData = {
                school_name: 'Test School',
                contact_email: 'test@example.com',
                contact_name: 'Test Contact',
                grade_level: 'Grade 5',
                student_count: 25,
                teacher_count: 2,
                preferred_date: '2025-01-15',
                visit_duration: 'full_day'  // Adding required duration field
            };

            try {
                appendResults(`<p><strong>Testing with:</strong></p><pre>${JSON.stringify(minimalData, null, 2)}</pre>`);

                const { data, error } = await supabase
                    .from('visits')
                    .insert([minimalData])
                    .select()
                    .single();

                if (error) {
                    appendResults(`<div class="status error"><strong>‚ùå Failed:</strong> ${error.message}</div>`);
                    appendResults(`<p><strong>Error details:</strong></p><pre>${JSON.stringify(error, null, 2)}</pre>`);
                } else {
                    appendResults(`<div class="status success"><strong>‚úÖ Success!</strong> Created visit with ID: ${data.id}</div>`);
                    appendResults(`<p><strong>Created record:</strong></p><pre>${JSON.stringify(data, null, 2)}</pre>`);

                    // Clean up - delete the test record
                    await supabase.from('visits').delete().eq('id', data.id);
                    appendResults(`<p><em>Test record deleted.</em></p>`);
                }

            } catch (error) {
                appendResults(`<div class="status error"><strong>‚ùå Exception:</strong> ${error.message}</div>`);
            }
        }

        async function testEventVisit() {
            showStatus('üß™ Testing event visit creation...', 'info');
            appendResults('<h3>üéâ Event Visit Test</h3>');

            const eventData = {
                school_name: '2022 Mayday 4 Ukraine',
                contact_email: 'events@guidal.com',
                contact_name: 'Event Coordinator',
                grade_level: 'Mixed/Adult',
                student_count: 150,
                teacher_count: 15,
                status: 'completed',
                preferred_date: '2022-05-22',
                confirmed_date: '2022-05-22',
                visit_type: 'event',
                visit_format: 'event',
                visit_duration: 'full_day',
                invoice_status: 'not-invoiced'
            };

            try {
                appendResults(`<p><strong>Testing with:</strong></p><pre>${JSON.stringify(eventData, null, 2)}</pre>`);

                const { data, error } = await supabase
                    .from('visits')
                    .insert([eventData])
                    .select()
                    .single();

                if (error) {
                    appendResults(`<div class="status error"><strong>‚ùå Failed:</strong> ${error.message}</div>`);
                    appendResults(`<p><strong>Error details:</strong></p><pre>${JSON.stringify(error, null, 2)}</pre>`);

                    // If it's a missing column error, let's try without that field
                    if (error.message.includes('does not exist')) {
                        appendResults(`<p><strong>üîß Trying without problematic fields...</strong></p>`);

                        const basicEventData = {
                            school_name: '2022 Mayday 4 Ukraine',
                            contact_email: 'events@guidal.com',
                            contact_name: 'Event Coordinator',
                            grade_level: 'Mixed/Adult',
                            student_count: 150,
                            teacher_count: 15,
                            status: 'completed',
                            preferred_date: '2022-05-22',
                            visit_duration: 'full_day',
                            invoice_status: 'not-invoiced'  // Use valid invoice status
                        };

                        const { data: basicData, error: basicError } = await supabase
                            .from('visits')
                            .insert([basicEventData])
                            .select()
                            .single();

                        if (basicError) {
                            appendResults(`<div class="status error"><strong>‚ùå Basic attempt also failed:</strong> ${basicError.message}</div>`);
                        } else {
                            appendResults(`<div class="status success"><strong>‚úÖ Basic version worked!</strong> Created visit with ID: ${basicData.id}</div>`);
                            appendResults(`<p><strong>Created record:</strong></p><pre>${JSON.stringify(basicData, null, 2)}</pre>`);

                            appendResults(`<p><strong>‚úÖ This proves the migration is possible! We just need to use the basic fields only.</strong></p>`);

                            // Don't delete this one - it's our successful event migration!
                            appendResults(`<p><em>‚úÖ Keeping this record as our successful event migration!</em></p>`);
                        }
                    }
                } else {
                    appendResults(`<div class="status success"><strong>‚úÖ Full success!</strong> Created visit with ID: ${data.id}</div>`);
                    appendResults(`<p><strong>Created record:</strong></p><pre>${JSON.stringify(data, null, 2)}</pre>`);

                    appendResults(`<p><strong>‚úÖ Event migration successful! This is our final migrated record.</strong></p>`);
                }

            } catch (error) {
                appendResults(`<div class="status error"><strong>‚ùå Exception:</strong> ${error.message}</div>`);
            }
        }
    </script>
</body>
</html>