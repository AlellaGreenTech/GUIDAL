<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - GUIDAL</title>
    <link rel="stylesheet" href="../../styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* Fix white subtitle text - need to override header background color inheritance */
        header {
            background: white !important;
        }

        header .subtitle {
            color: #333 !important;
        }

        header h1, header h1 a {
            color: var(--primary-green) !important;
        }

        header .foundation-presents {
            color: #666 !important;
        }

        .admin-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .admin-header {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #1b5e20;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            border: 2px solid var(--primary-green);
        }

        .admin-header h2 {
            color: #1b5e20;
            margin: 0 0 0.5rem 0;
        }

        .admin-header p {
            color: #2e7d32;
            margin: 0;
        }

        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 1.1rem;
        }

        .admin-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .admin-tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .admin-tab.active {
            background: var(--primary-green);
            color: white;
        }

        .tab-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
            min-height: 400px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: var(--light-green);
            font-weight: 600;
            color: var(--primary-green);
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .btn-edit {
            background: #2196f3;
            color: white;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-view {
            background: #4caf50;
            color: white;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .form-section h3 {
            color: var(--primary-green);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--accent-green);
            padding-bottom: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-published { background: #e8f5e8; color: #2e7d32; }
        .status-draft { background: #fff3e0; color: #f57c00; }
        .status-cancelled { background: #ffebee; color: #c62828; }

        .user-type-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .type-admin { background: #f3e5f5; color: #7b1fa2; }
        .type-teacher { background: #e3f2fd; color: #1976d2; }
        .type-student { background: #e8f5e8; color: #2e7d32; }
        .type-staff { background: #fff3e0; color: #f57c00; }

        .search-filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
        }

        .search-filter-bar input,
        .search-filter-bar select {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .search-filter-bar select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 12px;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            margin: 1rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .admin-tabs {
                flex-direction: column;
            }

            .stats-dashboard {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .search-filter-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .data-table {
                font-size: 0.9rem;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <p class="foundation-presents">The International Green Tech Foundation Presents</p>
            <h1><a href="../../index.html">GUIDAL</a></h1>
            <p class="subtitle">Admin Dashboard</p>
        </div>
    </header>

    <nav class="main-nav">
        <div class="container">
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            <ul class="nav-menu">
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../profile.html">Profile</a></li>
                <li><a href="#" id="logoutBtn">Logout</a></li>
            </ul>
        </div>
    </nav>

    <main class="admin-container">
        <div id="accessDenied" class="error-message" style="display: none;">
            <h3>üö´ Access Denied</h3>
            <p>You don't have admin privileges. Please contact an administrator for access.</p>
            <a href="../../index.html" class="btn">‚Üê Back to Home</a>
        </div>

        <div id="adminContent" style="display: none;">
            <div class="admin-header">
                <h2>üõ†Ô∏è Admin Dashboard</h2>
                <p>Manage activities, users, and system settings</p>
            </div>

            <div class="stats-dashboard" id="statsCards">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalActivities">-</div>
                    <div class="stat-label">Total Activities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRegistrations">-</div>
                    <div class="stat-label">Total Registrations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSchools">-</div>
                    <div class="stat-label">Total Schools</div>
                </div>
            </div>

            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="users">Users</button>
                <button class="admin-tab" data-tab="activities">Activities</button>
                <button class="admin-tab" data-tab="schools">Schools</button>
                <button class="admin-tab" data-tab="registrations">Registrations</button>
                <button class="admin-tab" data-tab="notifications">Send Notifications</button>
            </div>

            <div class="tab-content">
                <!-- Users Tab -->
                <div class="tab-panel active" id="users">
                    <div class="search-filter-bar">
                        <input type="text" id="userSearch" placeholder="Search users...">
                        <select id="userTypeFilter">
                            <option value="">All User Types</option>
                            <option value="user">Users</option>
                            <option value="admin">Admins</option>
                            <option value="staff">Staff</option>
                        </select>
                        <select id="schoolFilter">
                            <option value="">All Schools</option>
                        </select>
                    </div>

                    <div class="loading" id="usersLoading">Loading users...</div>
                    <div id="usersTable" style="display: none;"></div>
                </div>

                <!-- Activities Tab -->
                <div class="tab-panel" id="activities">
                    <div class="search-filter-bar">
                        <input type="text" id="activitySearch" placeholder="Search activities...">
                        <select id="activityStatusFilter">
                            <option value="">All Statuses</option>
                            <option value="published">Published</option>
                            <option value="draft">Draft</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="btn btn-primary" onclick="adminDashboard.showCreateActivityModal()">+ New Activity</button>
                    </div>

                    <div class="loading" id="activitiesLoading">Loading activities...</div>
                    <div id="activitiesTable" style="display: none;"></div>
                </div>

                <!-- Schools Tab -->
                <div class="tab-panel" id="schools">
                    <div class="search-filter-bar">
                        <input type="text" id="schoolSearch" placeholder="Search schools...">
                        <button class="btn btn-primary" onclick="adminDashboard.showCreateSchoolModal()">+ New School</button>
                    </div>

                    <div class="loading" id="schoolsLoading">Loading schools...</div>
                    <div id="schoolsTable" style="display: none;"></div>
                </div>

                <!-- Registrations Tab -->
                <div class="tab-panel" id="registrations">
                    <div class="search-filter-bar">
                        <select id="registrationStatusFilter">
                            <option value="">All Statuses</option>
                            <option value="registered">Registered</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="attended">Attended</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>

                    <div class="loading" id="registrationsLoading">Loading registrations...</div>
                    <div id="registrationsTable" style="display: none;"></div>
                </div>

                <!-- Notifications Tab -->
                <div class="tab-panel" id="notifications">
                    <form id="notificationForm">
                        <div class="form-section">
                            <h3>Send Notification</h3>
                            <div class="form-group">
                                <label for="notificationRecipients">Recipients</label>
                                <select id="notificationRecipients" required>
                                    <option value="all">All Users</option>
                                    <option value="students">Students Only</option>
                                    <option value="teachers">Teachers Only</option>
                                    <option value="admins">Admins Only</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="notificationTitle">Title</label>
                                <input type="text" id="notificationTitle" required placeholder="Notification title">
                            </div>

                            <div class="form-group">
                                <label for="notificationMessage">Message</label>
                                <textarea id="notificationMessage" rows="4" required placeholder="Notification message"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="notificationType">Type</label>
                                <select id="notificationType">
                                    <option value="info">Info</option>
                                    <option value="success">Success</option>
                                    <option value="warning">Warning</option>
                                    <option value="error">Error</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-primary">Send Notification</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Edit Item</h3>
                <button class="modal-close" onclick="adminDashboard.closeModal('editModal')">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 GUIDAL - The International Green Tech Foundation. All rights reserved.</p>
        </div>
    </footer>

    <script src="../../js/supabase-client.js"></script>
    <script>
        class AdminDashboard {
            constructor() {
                this.currentUser = null;
                this.currentTab = 'users';
                this.data = {
                    users: [],
                    activities: [],
                    schools: [],
                    registrations: []
                };

                this.init();
            }

            async init() {
                await this.checkAdminAccess();

                if (this.currentUser?.profile?.role === 'admin') {
                    this.setupEventListeners();
                    this.setupTabNavigation();
                    await this.loadDashboardStats();
                    await this.loadInitialData();
                }
            }

            async checkAdminAccess() {
                try {
                    this.currentUser = await GuidalDB.getCurrentUser();

                    if (!this.currentUser || this.currentUser.profile?.role !== 'admin') {
                        document.getElementById('accessDenied').style.display = 'block';
                        return;
                    }

                    document.getElementById('adminContent').style.display = 'block';
                } catch (error) {
                    console.error('Admin access check failed:', error);
                    document.getElementById('accessDenied').style.display = 'block';
                }
            }

            async loadDashboardStats() {
                try {
                    console.log('üìä Loading dashboard stats...');

                    // Load each stat separately to handle errors better
                    let users = [];
                    let activities = [];
                    let schools = [];

                    try {
                        users = await GuidalDB.getAllUsers() || [];
                        console.log('‚úÖ Users loaded:', users.length);
                        document.getElementById('totalUsers').textContent = users.length;
                    } catch (error) {
                        console.error('‚ùå Failed to load users:', error);
                        document.getElementById('totalUsers').textContent = 'Error';
                    }

                    try {
                        activities = await GuidalDB.getActivities() || [];
                        console.log('‚úÖ Activities loaded:', activities.length);
                        document.getElementById('totalActivities').textContent = activities.length;
                    } catch (error) {
                        console.error('‚ùå Failed to load activities:', error);
                        document.getElementById('totalActivities').textContent = 'Error';
                    }

                    try {
                        schools = await GuidalDB.getSchools() || [];
                        console.log('‚úÖ Schools loaded:', schools.length);
                        document.getElementById('totalSchools').textContent = schools.length;
                    } catch (error) {
                        console.error('‚ùå Failed to load schools:', error);
                        document.getElementById('totalSchools').textContent = 'Error';
                    }

                    // Count registrations (simplified)
                    try {
                        let totalRegistrations = 0;
                        for (let activity of activities) {
                            totalRegistrations += activity.current_participants || 0;
                        }
                        document.getElementById('totalRegistrations').textContent = totalRegistrations;
                    } catch (error) {
                        console.error('‚ùå Failed to count registrations:', error);
                        document.getElementById('totalRegistrations').textContent = 'Error';
                    }

                } catch (error) {
                    console.error('‚ùå Failed to load dashboard stats:', error);
                }
            }

            async loadInitialData() {
                await this.loadUsers();
                await this.loadSchoolOptions();
            }

            setupTabNavigation() {
                const tabButtons = document.querySelectorAll('.admin-tab');
                const tabPanels = document.querySelectorAll('.tab-panel');

                tabButtons.forEach(button => {
                    button.addEventListener('click', async () => {
                        const tabName = button.dataset.tab;

                        // Update active tab button
                        tabButtons.forEach(b => b.classList.remove('active'));
                        button.classList.add('active');

                        // Update active panel
                        tabPanels.forEach(p => p.classList.remove('active'));
                        document.getElementById(tabName).classList.add('active');

                        this.currentTab = tabName;

                        // Load data for the selected tab
                        await this.loadTabData(tabName);
                    });
                });
            }

            async loadTabData(tabName) {
                switch (tabName) {
                    case 'users':
                        if (this.data.users.length === 0) await this.loadUsers();
                        break;
                    case 'activities':
                        await this.loadActivities();
                        break;
                    case 'schools':
                        await this.loadSchools();
                        break;
                    case 'registrations':
                        await this.loadRegistrations();
                        break;
                }
            }

            async loadUsers() {
                const loading = document.getElementById('usersLoading');
                const table = document.getElementById('usersTable');

                loading.style.display = 'block';
                table.style.display = 'none';

                try {
                    this.data.users = await GuidalDB.getAllUsers();
                    this.renderUsersTable();
                } catch (error) {
                    console.error('Failed to load users:', error);
                    table.innerHTML = '<div class="error-message">Failed to load users</div>';
                } finally {
                    loading.style.display = 'none';
                    table.style.display = 'block';
                }
            }

            renderUsersTable(usersToRender = null) {
                const container = document.getElementById('usersTable');
                const users = usersToRender || this.data.users;

                if (users.length === 0) {
                    container.innerHTML = '<p>No users found.</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>School</th>
                                <th>Credits</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td>${user.full_name || 'No name'}</td>
                                    <td>${user.email}</td>
                                    <td><span class="user-type-badge type-${user.role}">${user.role}</span></td>
                                    <td>${user.school?.name || 'No school'}</td>
                                    <td>${user.credits || 0}</td>
                                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-small btn-view" onclick="adminDashboard.viewUser('${user.id}')">View</button>
                                            <button class="btn-small btn-edit" onclick="adminDashboard.editUser('${user.id}')">Edit</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            async loadActivities() {
                const loading = document.getElementById('activitiesLoading');
                const table = document.getElementById('activitiesTable');

                loading.style.display = 'block';
                table.style.display = 'none';

                try {
                    this.data.activities = await GuidalDB.getActivities();
                    this.renderActivitiesTable();
                } catch (error) {
                    console.error('Failed to load activities:', error);
                    table.innerHTML = '<div class="error-message">Failed to load activities</div>';
                } finally {
                    loading.style.display = 'none';
                    table.style.display = 'block';
                }
            }

            renderActivitiesTable(activitiesToRender = null) {
                const container = document.getElementById('activitiesTable');
                const activities = activitiesToRender || this.data.activities;

                if (activities.length === 0) {
                    container.innerHTML = '<p>No activities found.</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Date</th>
                                <th>Participants</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities.map(activity => `
                                <tr>
                                    <td>${activity.title}</td>
                                    <td>${activity.activity_type?.name || activity.type || 'N/A'}</td>
                                    <td>${activity.date_time ? new Date(activity.date_time).toLocaleDateString() : 'TBD'}</td>
                                    <td>${activity.current_participants || 0}/${activity.max_participants || '‚àû'}</td>
                                    <td><span class="status-badge status-${activity.status}">${activity.status}</span></td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-small btn-edit" onclick="adminDashboard.editActivity('${activity.id}')">Edit</button>
                                            <button class="btn-small btn-delete" onclick="adminDashboard.deleteActivity('${activity.id}')">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            async loadSchools() {
                const loading = document.getElementById('schoolsLoading');
                const table = document.getElementById('schoolsTable');

                loading.style.display = 'block';
                table.style.display = 'none';

                try {
                    this.data.schools = await GuidalDB.getSchools();
                    this.renderSchoolsTable();
                } catch (error) {
                    console.error('Failed to load schools:', error);
                    table.innerHTML = '<div class="error-message">Failed to load schools</div>';
                } finally {
                    loading.style.display = 'none';
                    table.style.display = 'block';
                }
            }

            renderSchoolsTable(schoolsToRender = null) {
                const container = document.getElementById('schoolsTable');
                const schools = schoolsToRender || this.data.schools;

                if (schools.length === 0) {
                    container.innerHTML = '<p>No schools found.</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Contact Person</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${schools.map(school => `
                                <tr>
                                    <td>${school.name}</td>
                                    <td>${school.contact_person || '-'}</td>
                                    <td>${school.contact_email || '-'}</td>
                                    <td>${school.contact_phone || '-'}</td>
                                    <td>${school.active ? '‚úÖ' : '‚ùå'}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-small btn-edit" onclick="adminDashboard.editSchool('${school.id}')">Edit</button>
                                            <button class="btn-small btn-delete" onclick="adminDashboard.deleteSchool('${school.id}')">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            async loadSchoolOptions() {
                try {
                    const schools = await GuidalDB.getSchools();
                    const select = document.getElementById('schoolFilter');

                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Failed to load school options:', error);
                }
            }

            async loadRegistrations() {
                // Implementation for registrations - would need to create a proper registrations query
                console.log('Load registrations - to be implemented');
            }

            setupEventListeners() {
                // Logout
                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });

                // Notification form
                document.getElementById('notificationForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendNotification();
                });

                // User search and filters
                document.getElementById('userSearch').addEventListener('input', () => this.filterUsers());
                document.getElementById('userTypeFilter').addEventListener('change', () => this.filterUsers());
                document.getElementById('schoolFilter').addEventListener('change', () => this.filterUsers());

                // Activity search and filters
                document.getElementById('activitySearch').addEventListener('input', () => this.filterActivities());
                document.getElementById('activityStatusFilter').addEventListener('change', () => this.filterActivities());

                // School search
                document.getElementById('schoolSearch').addEventListener('input', () => this.filterSchools());
            }

            filterUsers() {
                const searchTerm = document.getElementById('userSearch').value.toLowerCase();
                const typeFilter = document.getElementById('userTypeFilter').value;
                const schoolFilter = document.getElementById('schoolFilter').value;

                const filteredUsers = this.data.users.filter(user => {
                    const matchesSearch = !searchTerm ||
                        user.full_name?.toLowerCase().includes(searchTerm) ||
                        user.email?.toLowerCase().includes(searchTerm);
                    const matchesType = !typeFilter || user.role === typeFilter;
                    const matchesSchool = !schoolFilter || user.school_id === schoolFilter;

                    return matchesSearch && matchesType && matchesSchool;
                });

                this.renderUsersTable(filteredUsers);
            }

            filterActivities() {
                const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
                const statusFilter = document.getElementById('activityStatusFilter').value;

                const filteredActivities = this.data.activities.filter(activity => {
                    const matchesSearch = !searchTerm ||
                        activity.title?.toLowerCase().includes(searchTerm);
                    const matchesStatus = !statusFilter || activity.status === statusFilter;

                    return matchesSearch && matchesStatus;
                });

                this.renderActivitiesTable(filteredActivities);
            }

            filterSchools() {
                const searchTerm = document.getElementById('schoolSearch').value.toLowerCase();

                const filteredSchools = this.data.schools.filter(school => {
                    return !searchTerm ||
                        school.name?.toLowerCase().includes(searchTerm) ||
                        school.country?.toLowerCase().includes(searchTerm);
                });

                this.renderSchoolsTable(filteredSchools);
            }

            async sendNotification() {
                try {
                    const recipients = document.getElementById('notificationRecipients').value;
                    const title = document.getElementById('notificationTitle').value;
                    const message = document.getElementById('notificationMessage').value;
                    const type = document.getElementById('notificationType').value;

                    // Get users based on recipients selection
                    let targetUsers = [];
                    if (recipients === 'all') {
                        targetUsers = await GuidalDB.getAllUsers();
                    } else {
                        targetUsers = await GuidalDB.getAllUsers({ userType: recipients.slice(0, -1) }); // Remove 's' from end
                    }

                    // Send notification to each user
                    const promises = targetUsers.map(user =>
                        GuidalDB.createNotification(user.id, title, message, type)
                    );

                    await Promise.all(promises);

                    this.showNotification(`Notification sent to ${targetUsers.length} users!`, 'success');

                    // Clear form
                    document.getElementById('notificationForm').reset();
                } catch (error) {
                    console.error('Send notification failed:', error);
                    this.showNotification('Failed to send notification. Please try again.', 'error');
                }
            }

            // Placeholder methods for CRUD operations
            viewUser(userId) {
                console.log('View user:', userId);
                // Implementation would show user details in modal
            }

            editUser(userId) {
                console.log('Edit user:', userId);
                // Implementation would show edit form in modal
            }

            editActivity(activityId) {
                console.log('Edit activity:', activityId);
                // Implementation would show edit form in modal
            }

            deleteActivity(activityId) {
                if (confirm('Are you sure you want to delete this activity?')) {
                    console.log('Delete activity:', activityId);
                    // Implementation would delete activity
                }
            }

            editSchool(schoolId) {
                console.log('Edit school:', schoolId);
                // Implementation would show edit form in modal
            }

            deleteSchool(schoolId) {
                if (confirm('Are you sure you want to delete this school?')) {
                    console.log('Delete school:', schoolId);
                    // Implementation would delete school
                }
            }

            showCreateActivityModal() {
                console.log('Create activity modal');
                // Implementation would show create form
            }

            showCreateSchoolModal() {
                console.log('Create school modal');
                // Implementation would show create form
            }

            closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            async logout() {
                try {
                    await GuidalDB.signOut();
                    window.location.href = '../../index.html';
                } catch (error) {
                    console.error('Logout failed:', error);
                }
            }

            showNotification(message, type = 'info') {
                // Same notification system as in other components
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'} ${message}
                    </div>
                `;

                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
                    color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
                    padding: 1rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    z-index: 1001;
                    max-width: 400px;
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }
        }

        // Initialize admin dashboard
        let adminDashboard;
        document.addEventListener('DOMContentLoaded', () => {
            adminDashboard = new AdminDashboard();
        });
    </script>
</body>
</html>