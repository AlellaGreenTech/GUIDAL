<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Alella Green Tech</title>
    <link rel="stylesheet" href="../../css/main.css">
    <style>
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .info-message {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .activities-accordion {
            margin: 2rem 0;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            background: white;
        }

        .accordion-title {
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 1.1rem;
            color: #2e7d32;
            cursor: pointer;
            list-style: none;
            background: linear-gradient(135deg, #f1f8e9, #e8f5e8);
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .accordion-title:hover {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
        }

        .accordion-title::-webkit-details-marker {
            display: none;
        }

        .accordion-title::before {
            content: "‚ñ∂ ";
            margin-right: 0.5rem;
            transition: transform 0.3s ease;
        }

        details[open] .accordion-title::before {
            transform: rotate(90deg);
        }

        .activities-benefits {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <p class="foundation-presents">The International Green Tech Foundation Presents</p>
            <h1><a href="../../index.html">GUIDAL</a></h1>
            <p class="subtitle">Welcome to <a href="https://alellagreentech.org" target="_blank" class="agt-link">Alella Green Tech</a></p>
        </div>
    </header>
    
    <nav class="main-nav">
        <div class="container">
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            <ul class="nav-menu">
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../../index.html#activities">Activities</a></li>
                <li><a href="login.html">Login</a></li>
                <li><a href="#about-activities">About Activities</a></li>
            </ul>
        </div>
    </nav>
    
    <main class="container">
        <section id="about-activities" class="activities-intro">
            <div class="activities-hero">
                <h2>üå± Welcome to Alella Green Tech</h2>
                <p class="activities-subtitle">Where you can think like a permaculture farmer and build like an engineer.</p>

                <details class="activities-accordion">
                    <summary class="accordion-title">What you'll do at Alella Green Tech</summary>
                    <div class="activities-benefits">
                        <div class="benefit">
                            <h3>üéì Learn by Doing</h3>
                            <p>Participate in hands-on educational activities at our farm</p>
                        </div>
                        <div class="benefit">
                            <h3>üåø Connect with Nature</h3>
                            <p>Experience sustainable technology in a real farm setting</p>
                        </div>
                        <div class="benefit">
                            <h3>‚öôÔ∏è Try Real Engineering in the Field</h3>
                            <p>Learn Internet of Things (IoT) programming, smart irrigation, microcontrollers etc BY DOING IT.</p>
                        </div>
                        <div class="benefit">
                            <h3>üèÜ Track Your Journey</h3>
                            <p>See your impact and learning progress over time</p>
                        </div>
                    </div>
                </details>
            </div>
        </section>

        <section id="register" class="register-section">
            <div class="register-container">
                <h2>Create Your Account</h2>
                <p class="register-intro">Once registered you can participate in educational or fun activities at our farm or online.</p>
                
                <form id="registerForm" class="register-form">
                    <!-- Personal Information -->
                    <div class="form-section">
                        <h3>Personal Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fullName">Full Name *</label>
                                <input type="text" id="fullName" name="fullName" required>
                            </div>
                            <div class="form-group">
                                <label for="username">Username *</label>
                                <input type="text" id="username" name="username" required placeholder="Choose a unique username">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email Address *</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number (with country code)</label>
                                <input type="tel" id="phone" name="phone"
                                       placeholder="+34 612 345 678"
                                       pattern="^\+[1-9]\d{1,14}$"
                                       title="Please enter phone number with country code (e.g., +34 612 345 678)">
                                <small style="color: #666; font-size: 0.85em;">Include country code for WhatsApp compatibility (e.g., +34 for Spain, +1 for US)</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="password">Password *</label>
                                <input type="password" id="password" name="password" required
                                       minlength="6" placeholder="At least 6 characters">
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm Password *</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" required
                                       minlength="6" placeholder="Repeat your password">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="birthday">Birthday</label>
                                <input type="date" id="birthday" name="birthday" value="2015-01-01">
                            </div>
                        </div>
                    </div>

                    <!-- Location Information -->
                    <div class="form-section">
                        <h3>Location</h3>
                        <div class="form-group">
                            <label for="schoolCity">What city is your school in? (or where do you live)</label>
                            <input type="text" id="schoolCity" name="schoolCity" placeholder="Enter city name">
                        </div>
                    </div>

                    <!-- Educational Information -->
                    <div class="form-section">
                        <h3>School Information</h3>
                        <div class="form-group">
                            <label for="schoolId">Select your school/company</label>
                            <select id="schoolId" name="schoolId">
                                <option value="">Select your school/company</option>
                                <!-- Will be populated dynamically with registered schools -->
                                <option value="other">OTHER - I'll enter my school/company name</option>
                            </select>
                        </div>
                        <div class="form-group" id="customSchoolGroup" style="display: none;">
                            <label for="customSchool">Enter your school/company name</label>
                            <input type="text" id="customSchool" name="customSchool" placeholder="School or company name">
                        </div>
                    </div>

                    <!-- Languages and Social Media -->
                    <div class="form-section">
                        <h3>Languages & Social Media</h3>
                        <div class="form-group">
                            <label for="languages">Languages Spoken</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="languages" value="English" checked> English</label>
                                <label><input type="checkbox" name="languages" value="Spanish"> Spanish</label>
                                <label><input type="checkbox" name="languages" value="French"> French</label>
                                <label><input type="checkbox" name="languages" value="German"> German</label>
                                <label><input type="checkbox" name="languages" value="Catalan"> Catalan</label>
                                <label><input type="checkbox" name="languages" value="Dutch"> Dutch</label>
                                <label><input type="checkbox" name="languages" value="Czech"> Czech</label>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="instagram">Instagram Handle</label>
                                <input type="text" id="instagram" name="instagram" placeholder="@yourusername">
                            </div>
                            <div class="form-group">
                                <label for="tiktok">TikTok Handle</label>
                                <input type="text" id="tiktok" name="tiktok" placeholder="@yourusername">
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="form-section">
                        <h3>Additional Information</h3>
                        <div class="form-group">
                            <label for="dietaryRestrictions">Dietary Restrictions/Allergies</label>
                            <textarea id="dietaryRestrictions" name="dietaryRestrictions" rows="2" placeholder="Please list any food allergies or dietary restrictions..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="emergencyContact">Emergency Contact</label>
                            <input type="text" id="emergencyContact" name="emergencyContact" placeholder="Name and phone number">
                        </div>
                    </div>

                    <!-- Terms and Submit -->
                    <div class="form-section">
                        <div class="terms-checkbox">
                            <label>
                                <input type="checkbox" id="acceptTerms" required>
                                I agree to the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a>
                            </label>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="history.back()">Cancel</button>
                            <button type="submit" class="btn btn-primary">üå± Create Account</button>
                        </div>
                    </div>
                </form>
                
                <div class="login-link">
                    <p>Already have an account? <a href="login.html">Login here</a></p>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <div class="container">
            <p>&copy; 2024 Alella Green Tech. <a href="../../index.html">Back to GUIDAL</a></p>
            <p>Start your sustainable learning journey with GREENs!</p>
        </div>
    </footer>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- GUIDAL Database Clients -->
    <script src="../../js/supabase-client.js"></script>
    <script src="../../js/greens-client.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu functionality
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            const navMenu = document.querySelector('.nav-menu');
            
            if (mobileMenuToggle && navMenu) {
                mobileMenuToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                    mobileMenuToggle.classList.toggle('active');
                });
                
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.main-nav')) {
                        navMenu.classList.remove('active');
                        mobileMenuToggle.classList.remove('active');
                    }
                });
            }

            // Load schools for dropdown
            loadSchools();

            // Phone number formatting and validation
            const phoneInput = document.getElementById('phone');
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, ''); // Remove all non-digits

                // Auto-add + if user starts typing without it
                if (value && !e.target.value.startsWith('+')) {
                    e.target.value = '+' + value;
                }

                // Basic validation feedback
                const isValid = e.target.value.match(/^\+[1-9]\d{1,14}$/);
                e.target.style.borderColor = e.target.value === '' ? '' : (isValid ? '#28a745' : '#dc3545');
            });

            phoneInput.addEventListener('blur', function(e) {
                if (e.target.value && !e.target.value.match(/^\+[1-9]\d{1,14}$/)) {
                    e.target.setCustomValidity('Please enter a valid phone number with country code (e.g., +34 612 345 678)');
                } else {
                    e.target.setCustomValidity('');
                }
            });

            // Handle OTHER school selection
            document.getElementById('schoolId').addEventListener('change', function() {
                const customSchoolGroup = document.getElementById('customSchoolGroup');
                if (this.value === 'other') {
                    customSchoolGroup.style.display = 'block';
                } else {
                    customSchoolGroup.style.display = 'none';
                }
            });

            // Registration form handling
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await handleRegistration();
                });
            }

            async function loadSchools() {
                try {
                    const schools = await GuidalDB.getSchools();
                    const schoolSelect = document.getElementById('schoolId');
                    
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        schoolSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading schools:', error);
                }
            }

            async function handleRegistration() {
                const submitBtn = registerForm.querySelector('button[type="submit"]');

                try {
                    // Disable form during submission
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating Account...';
                    registerForm.classList.add('loading');

                    const formData = new FormData(registerForm);

                    // Validate passwords match
                    const password = formData.get('password');
                    const confirmPassword = formData.get('confirmPassword');

                    if (password !== confirmPassword) {
                        throw new Error('Passwords do not match');
                    }

                    if (password.length < 6) {
                        throw new Error('Password must be at least 6 characters long');
                    }

                    // Validate phone number format if provided
                    const phone = formData.get('phone');
                    if (phone && !phone.match(/^\+[1-9]\d{1,14}$/)) {
                        throw new Error('Phone number must include country code (e.g., +34 612 345 678)');
                    }

                    // Get selected languages
                    const languageCheckboxes = document.querySelectorAll('input[name="languages"]:checked');
                    const languages = Array.from(languageCheckboxes).map(cb => cb.value);

                    // Build social media object
                    const socialMedia = {};
                    if (formData.get('instagram')) socialMedia.instagram = formData.get('instagram');
                    if (formData.get('tiktok')) socialMedia.tiktok = formData.get('tiktok');

                    // Prepare user data for Supabase Auth
                    const email = formData.get('email');
                    const userData = {
                        fullName: formData.get('fullName'),
                        userType: 'student',
                        schoolId: formData.get('schoolId') || null,
                        phone: formData.get('phone'),
                        emergencyContact: formData.get('emergencyContact'),
                        dietaryRestrictions: formData.get('dietaryRestrictions')
                    };

                    // Create account using new auth system
                    const result = await GuidalDB.signUp(email, password, userData);

                    // Show detailed success message
                    showMessage(`
                        ‚úÖ <strong>Account Created Successfully!</strong><br>
                        üìß Check your email: <strong>martin@alellagreentech.org</strong><br>
                        üëÜ Click the confirmation link to activate your account<br>
                        ‚è≥ Redirecting to login in 5 seconds...
                    `, 'success');

                    // Clear form
                    registerForm.reset();

                    // Redirect to login after a delay
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 5000);

                } catch (error) {
                    console.error('Registration error:', error);

                    // Show detailed error message
                    let errorMessage = '‚ùå <strong>Registration Failed</strong><br>';
                    if (error.message) {
                        errorMessage += `Error: ${error.message}<br>`;
                    }
                    if (error.code) {
                        errorMessage += `Code: ${error.code}<br>`;
                    }
                    errorMessage += 'Please check your details and try again.';

                    showMessage(errorMessage, 'error');
                } finally {
                    // Re-enable form
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üå± Create Account';
                    registerForm.classList.remove('loading');
                }
            }

            // Add showMessage function for user feedback
            function showMessage(message, type = 'info') {
                // Remove existing messages
                const existingMessages = document.querySelectorAll('.message');
                existingMessages.forEach(msg => msg.remove());

                // Create new message
                const messageEl = document.createElement('div');
                messageEl.className = `message ${type}-message`;
                messageEl.innerHTML = message;

                // Make success messages more prominent
                if (type === 'success') {
                    messageEl.style.cssText = `
                        padding: 2rem;
                        font-size: 1.1rem;
                        text-align: center;
                        border: 2px solid #28a745;
                        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                        animation: slideDown 0.5s ease-out;
                    `;
                }

                // Insert at top of page
                const body = document.body;
                body.insertBefore(messageEl, body.firstChild);

                // Scroll to top to ensure message is visible
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Auto-hide non-error messages
                if (type !== 'error') {
                    setTimeout(() => {
                        if (messageEl.parentNode) {
                            messageEl.remove();
                        }
                    }, type === 'success' ? 6000 : 4000);
                }
            }
        });
    </script>
</body>
</html>