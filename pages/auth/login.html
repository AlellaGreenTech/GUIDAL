<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - GUIDAL</title>
    <link rel="stylesheet" href="../../css/main.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .auth-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }

        .auth-tab {
            flex: 1;
            padding: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .auth-tab.active {
            border-bottom: 2px solid var(--primary-green);
            color: var(--primary-green);
        }

        .auth-panel {
            display: none;
        }

        .auth-panel.active {
            display: block;
        }

        .forgot-password {
            text-align: center;
            margin-top: 1rem;
        }

        .forgot-password a {
            color: var(--primary-green);
            text-decoration: none;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        .auth-links {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #eee;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid #f5c6cb;
        }

        .school-note {
            background: #e3f2fd;
            padding: 0.8rem;
            border-radius: 6px;
            border: 1px solid #bbdefb;
            font-size: 0.9rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <p class="foundation-presents">The International Green Tech Foundation Presents</p>
            <h1><a href="../../index.html">GUIDAL</a></h1>
            <p class="subtitle">Login to Your Account</p>
        </div>
    </header>

    <nav class="main-nav">
        <div class="container">
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            <ul class="nav-menu">
                <li><a href="../../index.html">Home</a></li>
                <li><a href="../../index.html#activities">Activities</a></li>
                <li><a href="register.html">Register</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <section class="login-section">
            <div class="login-container">
                <div id="authMessages"></div>

                <!-- Unified Login -->
                <div class="auth-panel active" id="unified">
                    <h2>Login to GUIDAL</h2>
                    <p class="login-description">Access your account to register for activities, earn GREENs rewards, and track your sustainable learning progress. Individual students and school groups use the same system.</p>

                    <form id="loginForm" class="login-form">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" name="email" required
                                   placeholder="Enter your email address">
                        </div>

                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" name="password" required
                                   placeholder="Enter your password">
                        </div>

                        <button type="submit" class="btn login-btn-submit">Login</button>
                    </form>

                    <div class="forgot-password">
                        <a href="#" id="forgotPasswordLink">Forgot your password?</a>
                    </div>

                    <div class="auth-links">
                        <p>Don't have an account? <a href="register.html">Register here</a></p>
                        <p class="school-note">üìö <strong>School groups:</strong> Create individual accounts to join your group and maintain your GREEN$ across visits!</p>
                    </div>
                </div>

                <!-- Forgot Password Form (initially hidden) -->
                <div class="auth-panel" id="forgotPassword" style="display: none;">
                    <h2>Reset Password</h2>
                    <p class="login-description">Enter your email address and we'll send you a reset link</p>

                    <form id="forgotPasswordForm" class="login-form">
                        <div class="form-group">
                            <label for="resetEmail">Email Address</label>
                            <input type="email" id="resetEmail" name="email" required
                                   placeholder="Enter your email address">
                        </div>

                        <button type="submit" class="btn login-btn-submit">Send Reset Link</button>
                    </form>

                    <div class="auth-links">
                        <p><a href="#" id="backToLoginLink">‚Üê Back to Login</a></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- GREENs Information Section -->
        <section id="about-greens" class="greens-info-section">
            <div class="container">
                <h2>About GREENs Rewards</h2>
                <p class="section-intro">Earn blockchain-verified rewards for your sustainable learning activities!</p>

                <div class="greens-explanation">
                    <div class="greens-feature">
                        <details class="greens-dropdown">
                            <summary>üéì How to Earn GREENs</summary>
                            <div class="dropdown-content">
                                <ul>
                                    <li><strong>1 GREEN</strong> - Easy educational activities (presentations, simple workshops)</li>
                                    <li><strong>2 GREENs</strong> - Activities with manual work (planting, building, experiments)</li>
                                    <li><strong>3 GREENs</strong> - Full-day activities with manual work and instruction</li>
                                </ul>
                            </div>
                        </details>
                    </div>

                    <div class="greens-feature">
                        <details class="greens-dropdown">
                            <summary>‚öΩ How to Use GREENs</summary>
                            <div class="dropdown-content">
                                <ul>
                                    <li><strong>1 GREEN</strong> - 30 minutes of recreational activities (football, games)</li>
                                    <li><strong>2 GREENs</strong> - Special recreational events</li>
                                    <li><strong>3 GREENs</strong> - Premium recreational experiences</li>
                                </ul>
                            </div>
                        </details>
                    </div>

                    <div class="greens-feature">
                        <details class="greens-dropdown">
                            <summary>üîó Blockchain Technology</summary>
                            <div class="dropdown-content">
                                <p>Every GREENs transaction is recorded on our blockchain system, ensuring transparency and preventing fraud. Your learning achievements are permanently documented!</p>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <footer>
        <div class="container">
            <p>&copy; 2024 GUIDAL - The International Green Tech Foundation. All rights reserved.</p>
        </div>
    </footer>

    <script src="../../js/supabase-client.js"></script>
    <script>
        class LoginManager {
            constructor() {
                this.returnUrl = new URLSearchParams(window.location.search).get('return_url');
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkExistingAuth();
            }

            setupEventListeners() {
                // Login form
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                // Forgot password form
                document.getElementById('forgotPasswordForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleForgotPassword();
                });

                // Forgot password link
                document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showForgotPassword();
                });

                // Back to login link
                document.getElementById('backToLoginLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showLogin();
                });
            }

            async checkExistingAuth() {
                try {
                    const user = await GuidalDB.getCurrentUser();
                    if (user) {
                        // User is already logged in, redirect
                        this.redirectAfterLogin();
                    }
                } catch (error) {
                    // User not logged in, continue with login flow
                    console.log('User not authenticated');
                }
            }

            async handleLogin() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('loginPassword').value;
                const submitBtn = document.querySelector('#loginForm button[type="submit"]');

                submitBtn.disabled = true;
                submitBtn.textContent = 'Logging in...';
                document.getElementById('loginForm').classList.add('loading');

                try {
                    const { user, session } = await GuidalDB.signIn(email, password);

                    this.showMessage('Login successful! Redirecting...', 'success');

                    setTimeout(() => {
                        this.redirectAfterLogin();
                    }, 1000);

                } catch (error) {
                    console.error('Login error:', error);
                    const message = GuidalDB.handleError(error, 'Login');
                    this.showMessage(message, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Login';
                    document.getElementById('loginForm').classList.remove('loading');
                }
            }

            async handleForgotPassword() {
                const email = document.getElementById('resetEmail').value;
                const submitBtn = document.querySelector('#forgotPasswordForm button[type="submit"]');

                submitBtn.disabled = true;
                submitBtn.textContent = 'Sending...';

                try {
                    await GuidalDB.resetPassword(email);
                    this.showMessage('Password reset email sent! Check your inbox.', 'success');

                    // Clear form and show back to login after a delay
                    document.getElementById('forgotPasswordForm').reset();
                    setTimeout(() => {
                        this.showLogin();
                    }, 3000);

                } catch (error) {
                    console.error('Password reset error:', error);
                    const message = GuidalDB.handleError(error, 'Password Reset');
                    this.showMessage(message, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Reset Link';
                }
            }

            showForgotPassword() {
                // Hide all panels
                document.querySelectorAll('.auth-panel').forEach(panel => {
                    panel.classList.remove('active');
                });

                // Show forgot password panel
                document.getElementById('forgotPassword').style.display = 'block';
                document.getElementById('forgotPassword').classList.add('active');
            }

            showLogin() {
                // Hide forgot password panel
                document.getElementById('forgotPassword').style.display = 'none';
                document.getElementById('forgotPassword').classList.remove('active');

                // Show unified login panel
                document.getElementById('unified').classList.add('active');
            }

            redirectAfterLogin() {
                if (this.returnUrl) {
                    window.location.href = decodeURIComponent(this.returnUrl);
                } else {
                    window.location.href = '../../index.html';
                }
            }

            showMessage(message, type = 'info') {
                const messagesContainer = document.getElementById('authMessages');
                messagesContainer.innerHTML = `
                    <div class="${type}-message">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'} ${message}
                    </div>
                `;

                // Auto-hide after 5 seconds for non-error messages
                if (type !== 'error') {
                    setTimeout(() => {
                        messagesContainer.innerHTML = '';
                    }, 5000);
                }
            }
        }

        // Initialize login manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new LoginManager();
        });
    </script>
</body>
</html>