<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest Book - Alella Green Tech</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .guest-book-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .guest-book-form {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2e7d32;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #c8e6c9;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4caf50;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .submit-btn {
            background: #4caf50;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .submit-btn:hover {
            background: #45a049;
        }

        .submit-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .guest-book-entries {
            margin-top: 3rem;
        }

        .entry {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            border-left: 4px solid #4caf50;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .entry-name {
            font-weight: 600;
            color: #2e7d32;
            font-size: 1.1rem;
        }

        .entry-date {
            color: #666;
            font-size: 0.9rem;
        }

        .entry-details {
            margin-bottom: 1rem;
        }

        .entry-detail {
            margin-bottom: 0.5rem;
            color: #555;
        }

        .entry-detail strong {
            color: #2e7d32;
        }

        .entry-message {
            font-style: italic;
            color: #333;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        /* Social sharing modal styles */
        .social-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .social-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .social-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .social-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .social-modal h3 {
            color: #2e7d32;
            margin-bottom: 1rem;
            text-align: center;
        }

        .social-sharing-buttons {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
            justify-content: center;
        }

        .social-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.2s ease;
        }

        .social-btn:hover {
            transform: translateY(-2px);
            text-decoration: none;
            color: white;
        }

        .social-btn.facebook {
            background: #1877f2;
        }

        .social-btn.instagram {
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        }

        .social-btn.twitter {
            background: #1da1f2;
        }

        .incentive-box {
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
            border: 2px solid #4caf50;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .incentive-box h4 {
            color: #2e7d32;
            margin-bottom: 0.5rem;
        }

        .incentive-box p {
            margin-bottom: 0.5rem;
        }

        .hashtag {
            background: #4caf50;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }

        .share-canvas {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 1rem 0;
            max-width: 100%;
        }

        .preview-container {
            text-align: center;
            margin: 1rem 0;
        }

        .download-btn {
            background: #4caf50;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 0.5rem;
            transition: background 0.3s ease;
        }

        .download-btn:hover {
            background: #45a049;
        }

        @media (max-width: 768px) {
            .guest-book-container {
                padding: 1rem;
            }

            .guest-book-form {
                padding: 1.5rem;
            }

            .social-sharing-buttons {
                flex-direction: column;
            }

            .social-modal-content {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <p class="foundation-presents">The International Green Tech Foundation Presents</p>
            <h1><a href="../index.html">GUIDAL</a></h1>
            <p class="subtitle">Guest Book - Share Your Experience</p>
        </div>
    </header>

    <nav class="main-nav">
        <div class="container">
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
            <ul class="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="welcome.html">Welcome</a></li>
                <li><a href="about.html">About Us</a></li>
                <li><a href="../index.html#activities">Activities</a></li>
                <li><a href="../index.html#activities" onclick="filterActivitiesByType('events')">Events</a></li>
                <li><a href="guest-book.html" class="active">Guest Book</a></li>
                <li><a href="https://alellagreentech.com/testimonials/" target="_blank">Blog</a></li>
                <li><a href="https://alellagreentech.com/shop/" target="_blank">Store</a></li>
                <li><a href="auth/login.html" class="login-btn">Login/Register</a></li>
            </ul>
        </div>
    </nav>

    <main class="guest-book-container">
        <div class="guest-book-form">
            <h2>Share Your Experience</h2>
            <p>Tell us about your visit to Alella Green Tech! Your feedback helps us improve and inspires others.</p>

            <div id="messageContainer"></div>

            <form id="guestBookForm">
                <div class="form-group">
                    <label for="studentName">Your Name *</label>
                    <input type="text" id="studentName" name="studentName" required placeholder="Enter your name">
                </div>

                <div class="form-group">
                    <label for="groupName">Group/School Name</label>
                    <input type="text" id="groupName" name="groupName" placeholder="Enter your group or school name">
                </div>

                <div class="form-group">
                    <label for="favoriteStation">Favorite Station</label>
                    <select id="favoriteStation" name="favoriteStation">
                        <option value="">Select your favorite station</option>
                        <option value="Robotic Gardening">ü§ñ Robotic Gardening</option>
                        <option value="Wattle & Daub">üè† Wattle & Daub Construction</option>
                        <option value="Erosion Challenge">‚õ∞Ô∏è Erosion Challenge</option>
                        <option value="Hydraulic Ram Pumps">üíß Hydraulic Ram Pumps</option>
                        <option value="SchoolAIR IoT Sensors">üìä SchoolAIR IoT Sensors</option>
                        <option value="Smart Irrigation Demo">üí¶ Smart Irrigation Demo</option>
                        <option value="Agricultural Drones">üöÅ Agricultural Drones & Vineyard</option>
                        <option value="Composting">üå± Composting & Soil Science</option>
                        <option value="Planting">üåø Planting & Growing</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="interests">What interests you most?</label>
                    <select id="interests" name="interests">
                        <option value="">Select your interest</option>
                        <option value="Volunteering">Volunteering</option>
                        <option value="Building cool stuff">Building cool stuff</option>
                        <option value="The gardening robot">The gardening robot</option>
                        <option value="Doing R&D with microcontrollers">Doing R&D with microcontrollers</option>
                        <option value="The SchoolAIR project">The SchoolAIR project</option>
                        <option value="Tending animals">Tending animals</option>
                        <option value="Gardening at AGT">Gardening at AGT</option>
                        <option value="Starting a weekend workshop or similar business at AGT">Starting a weekend workshop or similar business at AGT</option>
                        <option value="Receiving cool stuff to read">Receiving cool stuff to read</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="instagramHandle">Instagram Handle (optional)</label>
                    <input type="text" id="instagramHandle" name="instagramHandle" placeholder="@yourhandle">
                </div>

                <div class="form-group">
                    <label for="message">Your Message *</label>
                    <textarea id="message" name="message" required placeholder="Share your thoughts about your visit to Alella Green Tech..."></textarea>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">Share Your Experience</button>
            </form>
        </div>

        <div class="guest-book-entries">
            <h2>Recent Visitor Messages</h2>
            <div id="entriesContainer" class="loading">
                Loading recent entries...
            </div>
        </div>
    </main>

    <!-- Social Sharing Modal -->
    <div id="socialModal" class="social-modal">
        <div class="social-modal-content">
            <button class="social-modal-close" onclick="closeSocialModal()">&times;</button>
            <h3>üéâ Share Your Experience!</h3>

            <div class="incentive-box">
                <h4>üí° Win Amazing Prizes!</h4>
                <p>Share your visit photo with <span class="hashtag">#alellagreentech</span> and tag us to win:</p>
                <ul style="list-style: none; padding: 0; margin: 1rem 0;">
                    <li>üå± <strong>Free plant from our greenhouse</strong></li>
                    <li>üéüÔ∏è <strong>20% discount on your next visit</strong></li>
                    <li>üìö <strong>Exclusive sustainability guide</strong></li>
                </ul>
                <p><small>Winners announced monthly on our social media!</small></p>
            </div>

            <div class="preview-container">
                <h4>Your Shareable Image:</h4>
                <canvas id="shareCanvas" class="share-canvas" width="600" height="400"></canvas>
                <br>
                <button class="download-btn" onclick="downloadShareableImage()">üì• Download Image</button>
            </div>

            <div class="social-sharing-buttons">
                <a href="#" class="social-btn facebook" id="facebookShare" target="_blank">
                    üìò Share on Facebook
                </a>
                <a href="#" class="social-btn instagram" id="instagramShare" target="_blank">
                    üì∑ Share on Instagram
                </a>
                <a href="#" class="social-btn twitter" id="twitterShare" target="_blank">
                    üê¶ Share on Twitter
                </a>
            </div>

            <div style="text-align: center; margin-top: 1.5rem;">
                <p><strong>Don't forget to:</strong></p>
                <ul style="list-style: none; padding: 0; margin: 1rem 0; text-align: left; display: inline-block;">
                    <li>‚úÖ Use hashtag <span class="hashtag">#alellagreentech</span></li>
                    <li>‚úÖ Tag us: <strong>@alellagreentech</strong></li>
                    <li>‚úÖ Include your favorite station from the visit</li>
                    <li>‚úÖ Share what you learned about sustainability</li>
                </ul>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 Alella Green Tech. Sustainable learning for a better future.</p>
        </div>
    </footer>

    <!-- Mobile Menu Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            const navMenu = document.querySelector('.nav-menu');

            mobileMenuToggle.addEventListener('click', function() {
                navMenu.classList.toggle('active');
                mobileMenuToggle.classList.toggle('active');
            });

            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.main-nav')) {
                    navMenu.classList.remove('active');
                    mobileMenuToggle.classList.remove('active');
                }
            });

            // Close menu when clicking a nav link
            const navLinks = document.querySelectorAll('.nav-menu a');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    navMenu.classList.remove('active');
                    mobileMenuToggle.classList.remove('active');
                });
            });
        });
    </script>

    <!-- Required Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/privacy-config.js"></script>

    <script>
        let currentUser = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            loadGuestBookEntries();
            setupForm();
        });

        async function checkAuthStatus() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
            } catch (error) {
                console.error('Auth check error:', error);
            }
        }

        function setupForm() {
            const form = document.getElementById('guestBookForm');
            form.addEventListener('submit', handleFormSubmit);
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const messageContainer = document.getElementById('messageContainer');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const formData = new FormData(e.target);
                const entry = {
                    student_name: formData.get('studentName'),
                    group_name: formData.get('groupName') || null,
                    favorite_station: formData.get('favoriteStation') || null,
                    interests: formData.get('interests') || null,
                    instagram_handle: formData.get('instagramHandle') || null,
                    message: formData.get('message')
                };

                console.log('Submitting guest book entry:', entry);

                const { data, error } = await supabase
                    .from('guest_book_entries')
                    .insert([entry])
                    .select();

                if (error) {
                    // Check if table doesn't exist
                    if (error.message && (error.message.includes('relation "public.guest_book_entries" does not exist') ||
                        error.message.includes('table "guest_book_entries" does not exist') ||
                        error.code === 'PGRST116')) {
                        messageContainer.innerHTML = `
                            <div class="error">
                                <h4>Guest Book Not Available Yet</h4>
                                <p>The guest book feature is currently being set up. Your feedback is important to us!</p>
                                <p>Please share your experience with us through these alternative ways:</p>
                                <ul style="margin: 1rem 0; padding-left: 2rem;">
                                    <li>Speak with our staff during your visit</li>
                                    <li><a href="https://alellagreentech.com/social/" target="_blank">Connect with us on social media</a></li>
                                    <li>Email us your feedback directly</li>
                                </ul>
                            </div>
                        `;
                        return;
                    }
                    throw error;
                }

                console.log('Guest book entry created:', data);

                messageContainer.innerHTML = '<div class="success">Thank you for sharing your experience! Your entry has been added to the guest book.</div>';

                // Show social sharing modal
                showSocialModal(entry);

                // Reset form
                e.target.reset();

                // Reload entries
                loadGuestBookEntries();

            } catch (error) {
                console.error('Error submitting guest book entry:', error);
                messageContainer.innerHTML = `
                    <div class="error">
                        <h4>Unable to Submit Entry</h4>
                        <p>Sorry, there was an error submitting your entry. Please try again or contact us directly.</p>
                        <p><small>Error details: ${error.message}</small></p>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Share Your Experience';
            }
        }

        async function loadGuestBookEntries() {
            const container = document.getElementById('entriesContainer');

            try {
                const { data: entries, error } = await supabase
                    .from('guest_book_entries')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) {
                    console.error('Database error:', error);

                    // Check if table doesn't exist
                    if (error.message && (error.message.includes('relation "public.guest_book_entries" does not exist') ||
                        error.message.includes('table "guest_book_entries" does not exist') ||
                        error.code === 'PGRST116')) {
                        container.innerHTML = `
                            <div class="info" style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 6px; border: 1px solid #ffeeba;">
                                <h3>Guest Book Coming Soon!</h3>
                                <p>The guest book feature is currently being set up. Please check back soon to share your experience!</p>
                                <p>In the meantime, you can share your thoughts with us through our other channels:</p>
                                <ul style="margin: 1rem 0; padding-left: 2rem;">
                                    <li><a href="https://alellagreentech.com/social/" target="_blank">Follow us on social media</a></li>
                                    <li><a href="https://alellagreentech.com/testimonials/" target="_blank">Read our blog</a></li>
                                    <li>Contact us directly during your visit</li>
                                </ul>
                            </div>
                        `;

                        // Also disable the form
                        const form = document.getElementById('guestBookForm');
                        const submitBtn = document.getElementById('submitBtn');
                        if (form && submitBtn) {
                            form.style.opacity = '0.5';
                            form.style.pointerEvents = 'none';
                            submitBtn.disabled = true;
                            submitBtn.textContent = 'Coming Soon';
                        }
                        return;
                    } else {
                        throw error;
                    }
                }

                if (entries && entries.length > 0) {
                    container.innerHTML = entries.map(entry => `
                        <div class="entry">
                            <div class="entry-header">
                                <div class="entry-name">${escapeHtml(entry.student_name)}</div>
                                <div class="entry-date">${new Date(entry.created_at).toLocaleDateString()}</div>
                            </div>
                            <div class="entry-details">
                                ${entry.group_name ? `<div class="entry-detail"><strong>Group:</strong> ${escapeHtml(entry.group_name)}</div>` : ''}
                                ${entry.favorite_station ? `<div class="entry-detail"><strong>Favorite Station:</strong> ${escapeHtml(entry.favorite_station)}</div>` : ''}
                                ${entry.interests ? `<div class="entry-detail"><strong>Interests:</strong> ${escapeHtml(entry.interests)}</div>` : ''}
                                ${entry.instagram_handle ? `<div class="entry-detail"><strong>Instagram:</strong> @${escapeHtml(entry.instagram_handle)}</div>` : ''}
                            </div>
                            <div class="entry-message">"${escapeHtml(entry.message)}"</div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>No guest book entries yet. Be the first to share your experience!</p>';
                }

            } catch (error) {
                console.error('Error loading guest book entries:', error);
                container.innerHTML = `
                    <div class="error">
                        <h3>Unable to load guest book entries</h3>
                        <p>There seems to be a technical issue. Please try refreshing the page or contact us if the problem persists.</p>
                        <p><small>Error details: ${error.message}</small></p>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Social sharing functionality
        let currentEntry = null;

        function showSocialModal(entry) {
            currentEntry = entry;
            const modal = document.getElementById('socialModal');

            // Generate the shareable image
            generateShareableImage(entry);

            // Set up social sharing links
            setupSocialLinks(entry);

            // Show the modal
            modal.classList.add('show');
        }

        function closeSocialModal() {
            const modal = document.getElementById('socialModal');
            modal.classList.remove('show');
            currentEntry = null;
        }

        function generateShareableImage(entry) {
            const canvas = document.getElementById('shareCanvas');
            const ctx = canvas.getContext('2d');

            // Set canvas size
            canvas.width = 600;
            canvas.height = 400;

            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, 600, 400);
            gradient.addColorStop(0, '#e8f5e8');
            gradient.addColorStop(1, '#4caf50');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 600, 400);

            // Add logo/title area
            ctx.fillStyle = '#2e7d32';
            ctx.font = 'bold 28px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('ALELLA GREEN TECH', 300, 50);

            ctx.font = '16px Arial, sans-serif';
            ctx.fillText('Sustainable Learning Experience', 300, 75);

            // Add visitor message (word wrap)
            const message = entry.message || 'Amazing experience at Alella Green Tech!';
            const maxWidth = 520;
            const lineHeight = 25;
            let y = 130;

            ctx.fillStyle = '#333';
            ctx.font = '18px Arial, sans-serif';
            ctx.textAlign = 'center';

            // Simple word wrap
            const words = message.split(' ');
            let line = '';

            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;

                if (testWidth > maxWidth && i > 0) {
                    ctx.fillText(line.trim(), 300, y);
                    line = words[i] + ' ';
                    y += lineHeight;

                    // Prevent text overflow
                    if (y > 280) break;
                } else {
                    line = testLine;
                }
            }

            if (line.trim().length > 0 && y <= 280) {
                ctx.fillText(line.trim(), 300, y);
            }

            // Add visitor name
            if (entry.student_name) {
                y += 40;
                ctx.fillStyle = '#2e7d32';
                ctx.font = '16px Arial, sans-serif';
                ctx.fillText(`- ${entry.student_name}`, 300, Math.min(y, 320));
            }

            // Add favorite station if provided
            if (entry.favorite_station) {
                y += 25;
                ctx.fillStyle = '#666';
                ctx.font = '14px Arial, sans-serif';
                ctx.fillText(`Favorite station: ${entry.favorite_station}`, 300, Math.min(y, 340));
            }

            // Add hashtag and call-to-action
            ctx.fillStyle = '#4caf50';
            ctx.font = 'bold 16px Arial, sans-serif';
            ctx.fillText('#alellagreentech #sustainability #greentech', 300, 375);
        }

        function setupSocialLinks(entry) {
            const message = entry.message || 'Amazing experience at Alella Green Tech!';
            const baseText = `Just visited @alellagreentech and learned about sustainable technology! ${message.substring(0, 100)}${message.length > 100 ? '...' : ''}`;
            const hashtags = 'alellagreentech,sustainability,greentech,education';
            const url = window.location.origin;

            // Facebook
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(baseText + ' #' + hashtags.split(',').join(' #'))}`;
            document.getElementById('facebookShare').href = facebookUrl;

            // Twitter
            const twitterText = `${baseText} #${hashtags.split(',').join(' #')}`;
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(twitterText)}&url=${encodeURIComponent(url)}`;
            document.getElementById('twitterShare').href = twitterUrl;

            // Instagram (opens Instagram web - users will need to copy the image and text)
            const instagramUrl = `https://www.instagram.com/`;
            document.getElementById('instagramShare').href = instagramUrl;
            document.getElementById('instagramShare').addEventListener('click', function(e) {
                e.preventDefault();
                // Copy text to clipboard for Instagram
                const instagramText = `${baseText}\n\n#${hashtags.split(',').join(' #')}\n\nTag @alellagreentech for a chance to win amazing prizes!`;

                if (navigator.clipboard) {
                    navigator.clipboard.writeText(instagramText).then(() => {
                        alert('Text copied to clipboard! Now opening Instagram where you can paste it with your downloaded image.');
                        window.open(instagramUrl, '_blank');
                    });
                } else {
                    // Fallback for older browsers
                    prompt('Copy this text for your Instagram post:', instagramText);
                    window.open(instagramUrl, '_blank');
                }
            });
        }

        function downloadShareableImage() {
            const canvas = document.getElementById('shareCanvas');
            const link = document.createElement('a');

            // Convert canvas to blob and download
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = `alella-green-tech-visit-${Date.now()}.png`;
                link.click();

                // Clean up
                setTimeout(() => URL.revokeObjectURL(url), 100);
            }, 'image/png');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('socialModal');
            if (e.target === modal) {
                closeSocialModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSocialModal();
            }
        });
    </script>
</body>
</html>