<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Science-in-Action Integration - GUIDAL</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .test-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 30px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; }
        .test-controls { background: #f8f9fa; padding: 15px; margin-bottom: 20px; }
        .test-controls button { margin: 5px; padding: 8px 15px; }
        .results { margin-top: 15px; }
        .success { border-color: #28a745; background-color: #d4edda; }
        .error { border-color: #dc3545; background-color: #f8d7da; }
        .info { border-color: #17a2b8; background-color: #d1ecf1; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; max-height: 300px; }

        /* Activity grid styles */
        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .activity-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .activity-info { padding: 15px; }
        .activity-type {
            background: #e91e63;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            display: inline-block;
            margin-bottom: 8px;
        }
        .activity-image {
            height: 150px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üî¨ Science-in-Action Integration Test</h1>

        <div class="test-controls">
            <h3>Test Controls</h3>
            <button onclick="testScienceInActionFilter()">Test Science-in-Action Filter</button>
            <button onclick="testActivityTemplates()">Test Activity Templates</button>
            <button onclick="testScheduledWorkshops()">Test Scheduled Workshops</button>
            <button onclick="testMixedResults()">Test Mixed Results</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div class="test-section" id="filter-test">
            <h3>1. Science-in-Action Filter Test</h3>
            <p>Testing if science-in-action activities appear when filtered</p>
            <div class="results" id="filter-results"></div>
        </div>

        <div class="test-section" id="template-test">
            <h3>2. Activity Templates Test</h3>
            <p>Testing pure activity templates (no dates)</p>
            <div class="results" id="template-results"></div>
        </div>

        <div class="test-section" id="workshop-test">
            <h3>3. Scheduled Workshops Test</h3>
            <p>Testing scheduled workshops with dates</p>
            <div class="results" id="workshop-results"></div>
        </div>

        <div class="test-section" id="visual-test">
            <h3>4. Visual Integration Test</h3>
            <p>Simulating how science-in-action would appear in the main app</p>

            <!-- Mock Activity Filter -->
            <div style="margin: 20px 0;">
                <label for="mock-filter">Activity Filter:</label>
                <select id="mock-filter" onchange="handleMockFilter()">
                    <option value="all">All Activities</option>
                    <option value="science-stations">Science-in-Action</option>
                    <option value="workshops">Workshops</option>
                    <option value="school-visits">School Visits</option>
                </select>
            </div>

            <!-- Mock Activity Grid -->
            <div class="activity-grid" id="mock-activity-grid">
                <!-- Activities will be populated here -->
            </div>
        </div>
    </div>

    <!-- Include dependencies -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>

    <script>
        // Mock activities for testing
        const mockScienceStations = [
            {
                id: 'sci-1',
                title: 'Robotic Gardening',
                description: 'Tend your garden from 1,000km away - or let the bot do it! Explore automated agriculture and precision farming with real robotic systems.',
                activity_type: {
                    id: 'science-stations',
                    name: 'Science Stations',
                    slug: 'science-stations',
                    color: '#e91e63',
                    icon: 'üî¨'
                },
                date_time: null, // No date = template
                suggested_duration_minutes: 60,
                status: 'published',
                featured_image: 'images/robotic-gardening-system.png'
            },
            {
                id: 'sci-2',
                title: 'Erosion Challenge',
                description: 'Stop erosion, retain water and create a fertile hillside through natural engineering solutions.',
                activity_type: {
                    id: 'science-stations',
                    name: 'Science Stations',
                    slug: 'science-stations',
                    color: '#e91e63',
                    icon: 'üî¨'
                },
                date_time: null,
                suggested_duration_minutes: 90,
                status: 'published',
                featured_image: 'images/swales.jpg'
            },
            {
                id: 'sci-3',
                title: 'Hydraulic Ram Pumps',
                description: 'Moving water up high without electricity! Discover genius inventions using water pressure.',
                activity_type: {
                    id: 'science-stations',
                    name: 'Science Stations',
                    slug: 'science-stations',
                    color: '#e91e63',
                    icon: 'üî¨'
                },
                date_time: null,
                suggested_duration_minutes: 75,
                status: 'published',
                featured_image: 'images/hydraulic-ram-pump-system.png'
            }
        ];

        const mockScheduledWorkshops = [
            {
                id: 'work-1',
                title: 'Composting Workshop',
                description: 'Learn the essential ingredients for good soil. Master different composting methods.',
                activity_type: {
                    id: 'workshops',
                    name: 'Workshops',
                    slug: 'workshops',
                    color: '#ff9800',
                    icon: 'üîß'
                },
                date_time: '2025-10-15T14:00:00+02:00',
                duration_minutes: 180,
                max_participants: 15,
                current_participants: 10,
                status: 'confirmed'
            }
        ];

        async function testScienceInActionFilter() {
            const resultsDiv = document.getElementById('filter-results');
            resultsDiv.innerHTML = '<p>üîç Testing science-in-action filter...</p>';

            try {
                // Test if the new filter works
                let activities = [];

                if (typeof GuidalDB !== 'undefined' && GuidalDB.getActivityTemplates) {
                    activities = await GuidalDB.getActivityTemplates({ type: 'science-stations' });
                } else {
                    // Use mock data
                    activities = mockScienceStations;
                    resultsDiv.innerHTML += '<p>‚ÑπÔ∏è Using mock data (GuidalDB not available)</p>';
                }

                resultsDiv.innerHTML += `
                    <h4>‚úÖ Science-in-Action Activities Found: ${activities.length}</h4>
                    <pre>${JSON.stringify(activities.map(a => ({
                        title: a.title,
                        type: a.activity_type?.name,
                        hasDate: !!a.date_time
                    })), null, 2)}</pre>
                `;
                resultsDiv.parentElement.className = 'test-section success';
            } catch (error) {
                resultsDiv.innerHTML += `<p>‚ùå Error: ${error.message}</p>`;
                resultsDiv.parentElement.className = 'test-section error';
            }
        }

        async function testActivityTemplates() {
            const resultsDiv = document.getElementById('template-results');
            resultsDiv.innerHTML = '<p>üîç Testing activity templates...</p>';

            try {
                let templates = [];

                if (typeof GuidalDB !== 'undefined' && GuidalDB.getActivityTemplates) {
                    templates = await GuidalDB.getActivityTemplates();
                } else {
                    templates = mockScienceStations;
                    resultsDiv.innerHTML += '<p>‚ÑπÔ∏è Using mock data</p>';
                }

                // Check that templates have no dates
                const templatesWithDates = templates.filter(t => t.date_time);
                const templatesWithoutDates = templates.filter(t => !t.date_time);

                resultsDiv.innerHTML += `
                    <h4>Activity Templates Analysis</h4>
                    <ul>
                        <li>‚úÖ Templates without dates: ${templatesWithoutDates.length}</li>
                        <li>${templatesWithDates.length ? '‚ö†Ô∏è' : '‚úÖ'} Templates with dates: ${templatesWithDates.length}</li>
                    </ul>
                    <pre>${JSON.stringify(templatesWithoutDates.slice(0, 2), null, 2)}</pre>
                `;
                resultsDiv.parentElement.className = templatesWithDates.length === 0 ? 'test-section success' : 'test-section info';
            } catch (error) {
                resultsDiv.innerHTML += `<p>‚ùå Error: ${error.message}</p>`;
                resultsDiv.parentElement.className = 'test-section error';
            }
        }

        async function testScheduledWorkshops() {
            const resultsDiv = document.getElementById('workshop-results');
            resultsDiv.innerHTML = '<p>üîç Testing scheduled workshops...</p>';

            try {
                let workshops = [];

                if (typeof GuidalDB !== 'undefined' && GuidalDB.getScheduledVisits) {
                    workshops = await GuidalDB.getScheduledVisits({ visit_type: 'individual_workshop' });
                } else {
                    workshops = mockScheduledWorkshops;
                    resultsDiv.innerHTML += '<p>‚ÑπÔ∏è Using mock data</p>';
                }

                resultsDiv.innerHTML += `
                    <h4>‚úÖ Scheduled Workshops Found: ${workshops.length}</h4>
                    <pre>${JSON.stringify(workshops.map(w => ({
                        title: w.title,
                        date: w.date_time || w.scheduled_date,
                        participants: `${w.current_participants || 0}/${w.max_participants || 'unlimited'}`
                    })), null, 2)}</pre>
                `;
                resultsDiv.parentElement.className = 'test-section success';
            } catch (error) {
                resultsDiv.innerHTML += `<p>‚ùå Error: ${error.message}</p>`;
                resultsDiv.parentElement.className = 'test-section error';
            }
        }

        async function testMixedResults() {
            const allSections = ['filter-test', 'template-test', 'workshop-test'];

            // Run all tests
            await testScienceInActionFilter();
            await testActivityTemplates();
            await testScheduledWorkshops();

            // Summary
            const successCount = allSections.filter(id =>
                document.getElementById(id).className.includes('success')
            ).length;

            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'test-section ' + (successCount === allSections.length ? 'success' : 'info');
            summaryDiv.innerHTML = `
                <h3>üèÅ Test Summary</h3>
                <p>Tests Passed: ${successCount}/${allSections.length}</p>
                <p>Status: ${successCount === allSections.length ? '‚úÖ All tests passed!' : '‚ö†Ô∏è Some tests need attention'}</p>
            `;

            document.querySelector('.test-container').appendChild(summaryDiv);
        }

        function clearResults() {
            const resultDivs = document.querySelectorAll('.results');
            resultDivs.forEach(div => div.innerHTML = '');

            const sections = document.querySelectorAll('.test-section');
            sections.forEach(section => {
                section.className = 'test-section';
            });

            // Remove summary if exists
            const summary = document.querySelector('.test-container > .test-section:last-child');
            if (summary && summary.innerHTML.includes('Test Summary')) {
                summary.remove();
            }
        }

        function handleMockFilter() {
            const filterValue = document.getElementById('mock-filter').value;
            const grid = document.getElementById('mock-activity-grid');

            let activitiesToShow = [];

            switch (filterValue) {
                case 'science-stations':
                    activitiesToShow = mockScienceStations;
                    break;
                case 'workshops':
                    activitiesToShow = mockScheduledWorkshops;
                    break;
                case 'all':
                    activitiesToShow = [...mockScienceStations, ...mockScheduledWorkshops];
                    break;
                default:
                    activitiesToShow = [];
            }

            renderMockActivities(activitiesToShow, grid);
        }

        function renderMockActivities(activities, container) {
            container.innerHTML = activities.map(activity => `
                <div class="activity-card">
                    <div class="activity-image">
                        ${activity.featured_image ? 'üñºÔ∏è ' + activity.title : 'üìã ' + activity.activity_type.icon + ' ' + activity.activity_type.name}
                    </div>
                    <div class="activity-info">
                        <div class="activity-type">${activity.activity_type.name}</div>
                        <h3>${activity.title}</h3>
                        <p class="activity-date">
                            ${activity.date_time ? new Date(activity.date_time).toLocaleDateString() : 'Coming soon (no date set)'}
                        </p>
                        <p>${activity.description.substring(0, 100)}...</p>
                        <button class="btn ${activity.date_time ? 'btn-primary' : 'btn-secondary'}">
                            ${activity.date_time ? 'Book Now' : 'Book Station'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Initialize with all activities
        document.addEventListener('DOMContentLoaded', () => {
            handleMockFilter();
        });
    </script>
</body>
</html>