<!DOCTYPE html>
<html>
<head>
    <title>Debug Activities Loading</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        .result { padding: 1rem; margin: 1rem 0; border-radius: 8px; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        pre { background: #f8f9fa; padding: 1rem; border-radius: 4px; overflow: auto; white-space: pre-wrap; }
        button { padding: 0.5rem 1rem; margin: 0.5rem; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
    </style>
</head>
<body>
    <h1>üîç Debug Activities Loading</h1>

    <button onclick="testVisitsTable()">Test Visits Table</button>
    <button onclick="testActivitiesTable()">Test Activities Table</button>
    <button onclick="testCombinedQuery()">Test Combined Query</button>
    <button onclick="testPastFilter()">Test Past Filter</button>

    <div id="results"></div>

    <script>
        let supabaseClient = null;

        window.addEventListener('DOMContentLoaded', async () => {
            // Wait for supabase to be initialized
            await new Promise(resolve => {
                const checkSupabase = () => {
                    if (window.supabaseClient) {
                        supabaseClient = window.supabaseClient;
                        resolve();
                    } else {
                        setTimeout(checkSupabase, 100);
                    }
                };
                checkSupabase();
            });

            showResult('info', 'Ready to debug activities');
        });

        function showResult(type, title, content = '') {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += `
                <div class="result ${type}">
                    <h3>${title}</h3>
                    ${content ? `<pre>${content}</pre>` : ''}
                </div>
            `;
        }

        async function testVisitsTable() {
            showResult('info', 'Testing Visits Table...', 'Querying visits table directly...');

            try {
                const { data, error } = await supabaseClient
                    .from('visits')
                    .select('*')
                    .limit(10);

                if (error) {
                    showResult('error', 'Visits Table Error', error.message);
                } else {
                    showResult('success', `Visits Table Results (${data.length} records)`, JSON.stringify(data, null, 2));
                }
            } catch (error) {
                showResult('error', 'Visits Table Exception', error.message);
            }
        }

        async function testActivitiesTable() {
            showResult('info', 'Testing Activities Table...', 'Querying activities table directly...');

            try {
                const { data, error } = await supabaseClient
                    .from('activities')
                    .select(`
                        *,
                        activity_type:activity_types!activity_type_id(id, name, slug, color, icon)
                    `)
                    .limit(10);

                if (error) {
                    showResult('error', 'Activities Table Error', error.message);
                } else {
                    showResult('success', `Activities Table Results (${data.length} records)`, JSON.stringify(data, null, 2));
                }
            } catch (error) {
                showResult('error', 'Activities Table Exception', error.message);
            }
        }

        async function testCombinedQuery() {
            showResult('info', 'Testing Combined Query...', 'Using GuidalDB.getActivities()...');

            try {
                const activities = await GuidalDB.getActivities({ include_completed: true });
                showResult('success', `Combined Query Results (${activities.length} records)`, JSON.stringify(activities, null, 2));
            } catch (error) {
                showResult('error', 'Combined Query Exception', error.message);
            }
        }

        async function testPastFilter() {
            showResult('info', 'Testing Past Filter...', 'Using time_filter: past with include_completed...');

            try {
                const activities = await GuidalDB.getActivities({
                    time_filter: 'past',
                    include_completed: true
                });
                showResult('success', `Past Filter Results (${activities.length} records)`, JSON.stringify(activities, null, 2));
            } catch (error) {
                showResult('error', 'Past Filter Exception', error.message);
            }
        }
    </script>
</body>
</html>
    <title>Debug Activities</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Activities Debug Page</h1>
    <div id="results"></div>

    <script src="js/supabase-client.js"></script>
    <script>
        async function debugActivities() {
            const resultsDiv = document.getElementById('results');

            try {
                // Check current user
                resultsDiv.innerHTML += '<h2>Authentication Status:</h2>';
                const user = await GuidalDB.getCurrentUser();
                resultsDiv.innerHTML += `<p>Current user: ${user ? user.email : 'Not logged in'}</p>`;

                // Test direct activities query
                resultsDiv.innerHTML += '<h2>Activities Query Test:</h2>';
                const activities = await GuidalDB.getActivities();
                resultsDiv.innerHTML += `<p>Activities found: ${activities.length}</p>`;

                if (activities.length > 0) {
                    resultsDiv.innerHTML += '<h3>First activity:</h3>';
                    resultsDiv.innerHTML += `<pre>${JSON.stringify(activities[0], null, 2)}</pre>`;
                } else {
                    resultsDiv.innerHTML += '<p>No activities returned</p>';
                }

                // Test activity types
                resultsDiv.innerHTML += '<h2>Activity Types Test:</h2>';
                const { data: types, error: typesError } = await supabase
                    .from('activity_types')
                    .select('*');

                if (typesError) {
                    resultsDiv.innerHTML += `<p>Activity types error: ${typesError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<p>Activity types found: ${types.length}</p>`;
                }

                // Test direct supabase query
                resultsDiv.innerHTML += '<h2>Direct Supabase Query:</h2>';
                const { data: directData, error: directError } = await supabase
                    .from('activities')
                    .select('*')
                    .limit(5);

                if (directError) {
                    resultsDiv.innerHTML += `<p>Direct query error: ${directError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<p>Direct query found: ${directData.length} activities</p>`;
                }

            } catch (error) {
                resultsDiv.innerHTML += `<p style="color: red;">Error: ${error.message}</p>`;
                console.error('Debug error:', error);
            }
        }

        // Run debug on page load
        debugActivities();
    </script>
</body>
</html>