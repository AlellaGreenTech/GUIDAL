<!DOCTYPE html>
<html>
<head>
    <title>Complete Historical Visits Migration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .loading { background: #e3f2fd; border: 1px solid #1976d2; }
        .success { background: #e8f5e8; border: 1px solid #4caf50; }
        .error { background: #ffebee; border: 1px solid #f44336; }
        .info { background: #fff3e0; border: 1px solid #ff9800; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #1976d2; color: white; }
        .btn-success { background: #4caf50; color: white; }
    </style>
</head>
<body>
    <h1>üîÑ Complete Historical Visits Migration</h1>

    <div id="status" class="status loading">üîç Analyzing your historical visit data...</div>

    <div id="summary"></div>
    <div id="preview"></div>
    <div id="migration-controls" style="display: none;">
        <button class="btn-primary" onclick="performMigration()">üìã Migrate All Historical Visits</button>
        <button class="btn-success" onclick="addSampleOnly()">‚ûï Keep Sample Data Only</button>
    </div>
    <div id="results"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-client.js"></script>
    <script>
        let historicalVisits = [];

        async function analyzeHistoricalData() {
            try {
                console.log('üîç Analyzing historical visit data structure...');

                // Step 1: Get all schools
                const { data: schools, error: schoolsError } = await supabaseClient
                    .from('schools')
                    .select('*');

                // Step 2: Get all activity types
                const { data: activityTypes, error: typesError } = await supabaseClient
                    .from('activity_types')
                    .select('*');

                // Step 3: Get all activities (especially school visit related)
                const { data: activities, error: activitiesError } = await supabaseClient
                    .from('activities')
                    .select('*');

                // Step 4: Get school_visits that link everything together
                const { data: schoolVisits, error: visitsError } = await supabaseClient
                    .from('school_visits')
                    .select('*');

                if (schoolsError || typesError || activitiesError || visitsError) {
                    throw new Error('Error accessing database tables');
                }

                console.log('üìä Data found:');
                console.log('- Schools:', schools?.length || 0);
                console.log('- Activity Types:', activityTypes?.length || 0);
                console.log('- Activities:', activities?.length || 0);
                console.log('- School Visits:', schoolVisits?.length || 0);

                // Create summary
                document.getElementById('status').innerHTML = '‚úÖ Historical data analysis complete!';
                document.getElementById('status').className = 'status success';

                let summaryHtml = `
                    <h2>üìä Your Historical Data Summary</h2>
                    <table>
                        <tr><th>Table</th><th>Records Found</th><th>Sample Data</th></tr>
                        <tr><td>Schools</td><td>${schools?.length || 0}</td><td>${schools?.[0]?.name || 'N/A'}</td></tr>
                        <tr><td>Activity Types</td><td>${activityTypes?.length || 0}</td><td>${activityTypes?.[0]?.name || 'N/A'}</td></tr>
                        <tr><td>Activities</td><td>${activities?.length || 0}</td><td>${activities?.[0]?.title || 'N/A'}</td></tr>
                        <tr><td>School Visits</td><td>${schoolVisits?.length || 0}</td><td>${schoolVisits?.[0]?.teacher_name || 'N/A'}</td></tr>
                    </table>
                `;

                // Build complete visit records by joining the data
                if (schoolVisits && schoolVisits.length > 0) {
                    historicalVisits = schoolVisits.map(visit => {
                        const school = schools?.find(s => s.id === visit.school_id);
                        const activity = activities?.find(a => a.id === visit.activity_id);
                        const activityType = activityTypes?.find(at => at.id === activity?.activity_type_id);

                        return {
                            // School/Entity information
                            school_name: school?.name || 'Unknown School',
                            contact_name: visit.teacher_name || school?.contact_person || 'Unknown',
                            contact_email: visit.teacher_email || school?.contact_email || 'unknown@email.com',
                            contact_phone: visit.teacher_phone || school?.phone || null,
                            school_location: school?.address || null,

                            // Visit details
                            student_count: visit.student_count || 1,
                            teacher_count: 2, // Default
                            grade_level: visit.grade_level || 'Unknown',
                            preferred_date: activity?.date_time ? activity.date_time.split('T')[0] : new Date().toISOString().split('T')[0],
                            visit_duration: this.calculateDuration(activity) || '4 hours',

                            // Status and metadata
                            status: this.determineStatus(activity),
                            submitted_at: visit.created_at || activity?.created_at || new Date().toISOString(),
                            created_at: visit.created_at || activity?.created_at || new Date().toISOString(),

                            // Additional information
                            additional_requests: visit.special_instructions || null,
                            lunch_needs: visit.lunch_required ? 'required' : 'none',
                            transportation: visit.transport_details || null,
                            internal_notes: `Migrated from: ${activityType?.name || 'school visit'} - Access: ${visit.access_code || 'N/A'}`,

                            // Original data for reference
                            original_visit_id: visit.id,
                            original_activity_id: activity?.id,
                            original_school_id: school?.id
                        };
                    });

                    summaryHtml += `
                        <h3>üéØ Migration Preview</h3>
                        <p><strong>${historicalVisits.length} historical visits</strong> will be migrated to the trip_requests table.</p>
                    `;

                    // Show preview of first few records
                    if (historicalVisits.length > 0) {
                        summaryHtml += `
                            <h4>Preview of migrated data:</h4>
                            <table>
                                <tr>
                                    <th>School/Entity</th>
                                    <th>Contact</th>
                                    <th>Students</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                        `;

                        historicalVisits.slice(0, 5).forEach(visit => {
                            summaryHtml += `
                                <tr>
                                    <td>${visit.school_name}</td>
                                    <td>${visit.contact_name}</td>
                                    <td>${visit.student_count}</td>
                                    <td>${visit.preferred_date}</td>
                                    <td>${visit.status}</td>
                                </tr>
                            `;
                        });

                        summaryHtml += '</table>';

                        if (historicalVisits.length > 5) {
                            summaryHtml += `<p>... and ${historicalVisits.length - 5} more visits</p>`;
                        }
                    }

                    document.getElementById('migration-controls').style.display = 'block';
                } else {
                    summaryHtml += `
                        <div class="status info">
                            <p>‚ÑπÔ∏è No school visit records found in school_visits table.</p>
                            <p>This might mean:</p>
                            <ul>
                                <li>The historical data is in a different table structure</li>
                                <li>All visits are stored only in the activities table</li>
                                <li>You don't have historical visits yet</li>
                            </ul>
                        </div>
                    `;
                }

                document.getElementById('summary').innerHTML = summaryHtml;

            } catch (err) {
                console.error('‚ùå Error analyzing data:', err);
                document.getElementById('status').innerHTML = `‚ùå Error: ${err.message}`;
                document.getElementById('status').className = 'status error';
            }
        }

        function calculateDuration(activity) {
            // Try to determine duration from activity data
            if (activity?.duration_minutes) {
                return Math.round(activity.duration_minutes / 60) + ' hours';
            }
            return '4 hours'; // Default
        }

        function determineStatus(activity) {
            if (!activity?.date_time) return 'completed';

            const activityDate = new Date(activity.date_time);
            const now = new Date();

            if (activityDate < now) {
                return 'completed';
            } else if (activity.status === 'published') {
                return 'scheduled';
            } else {
                return 'approved';
            }
        }

        async function performMigration() {
            try {
                document.getElementById('status').innerHTML = 'üìã Migrating historical visits...';
                document.getElementById('status').className = 'status loading';

                // Clear existing sample data first
                await supabaseClient
                    .from('trip_requests')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all

                // Insert historical data
                const { data, error } = await supabaseClient
                    .from('trip_requests')
                    .insert(historicalVisits);

                if (error) {
                    throw error;
                }

                document.getElementById('status').innerHTML = `‚úÖ Successfully migrated ${historicalVisits.length} historical visits!`;
                document.getElementById('status').className = 'status success';

                document.getElementById('results').innerHTML = `
                    <h3>üéâ Migration Complete!</h3>
                    <p>Your ${historicalVisits.length} historical visits have been imported into the trip_requests table.</p>
                    <p><a href="/admin/visit-requests.html">üìã View All Visits</a></p>
                    <p><a href="/admin/test-visits.html">üß™ Test Filtering</a></p>
                `;

                document.getElementById('migration-controls').style.display = 'none';

            } catch (err) {
                console.error('‚ùå Migration error:', err);
                document.getElementById('status').innerHTML = `‚ùå Migration failed: ${err.message}`;
                document.getElementById('status').className = 'status error';
            }
        }

        async function addSampleOnly() {
            document.getElementById('status').innerHTML = '‚úÖ Keeping existing sample data';
            document.getElementById('status').className = 'status success';
            document.getElementById('migration-controls').style.display = 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof supabaseClient === 'undefined') {
                console.error('‚ùå Supabase client not loaded');
                document.getElementById('status').innerHTML = '‚ùå Supabase client not loaded';
                document.getElementById('status').className = 'status error';
                return;
            }
            analyzeHistoricalData();
        });
    </script>
</body>
</html>