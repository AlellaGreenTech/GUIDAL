<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard Connection</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .log { background: #f5f5f5; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .btn { background: #1565c0; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 10px 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>
    <h1>üîß Test Dashboard Connection</h1>

    <button id="testBtn" class="btn">üöÄ Test Connection Like Dashboard</button>

    <div id="status"></div>
    <div class="log" id="log"></div>

    <!-- Load the same scripts as dashboard -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>

    <script>
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function testDashboardConnection() {
            log('üîß Testing dashboard connection exactly like admin/index.html...');

            try {
                // Step 1: Check if supabaseClient is available
                let attempts = 0;
                const maxAttempts = 10;

                function checkClient() {
                    attempts++;
                    log(`üîÑ Attempt ${attempts}: Checking for supabaseClient...`);

                    if (typeof supabaseClient !== 'undefined') {
                        log('‚úÖ supabaseClient found!');
                        testQueries();
                    } else if (attempts < maxAttempts) {
                        log('‚è≥ Waiting for supabaseClient...');
                        setTimeout(checkClient, 500);
                    } else {
                        log('‚ùå Failed to load supabaseClient after 10 attempts');
                        showStatus('Cannot find supabaseClient - same issue as dashboard', 'error');
                    }
                }

                async function testQueries() {
                    try {
                        log('üß™ Testing the exact dashboard queries...');

                        // Get pending requests count
                        const { count: pendingCount } = await supabaseClient
                            .from('visits')
                            .select('*', { count: 'exact', head: true })
                            .eq('status', 'pending');

                        log(`üìä Pending count: ${pendingCount}`);

                        // Get this month's requests
                        const startOfMonth = new Date();
                        startOfMonth.setDate(1);
                        startOfMonth.setHours(0, 0, 0, 0);

                        const { count: monthlyCount } = await supabaseClient
                            .from('visits')
                            .select('*', { count: 'exact', head: true })
                            .gte('submitted_at', startOfMonth.toISOString());

                        log(`üìä Monthly count: ${monthlyCount}`);

                        // Get ALL visits
                        const { data: allVisits } = await supabaseClient
                            .from('visits')
                            .select('*');

                        log(`üìä All visits: ${allVisits ? allVisits.length : 'null'}`);

                        if (allVisits && allVisits.length > 0) {
                            const uniqueSchools = [...new Set(allVisits.map(r => r.school_name))].length;
                            const totalVisitors = allVisits.reduce((sum, r) => {
                                const students = parseInt(r.student_count) || 0;
                                const adults = parseInt(r.teacher_count) || parseInt(r.accompanying_adults) || 2;
                                return sum + students + adults;
                            }, 0);

                            log(`üìä Unique schools: ${uniqueSchools}`);
                            log(`üìä Total visitors: ${totalVisitors}`);

                            showStatus(`‚úÖ Dashboard queries work! ${allVisits.length} visits, ${uniqueSchools} schools, ${totalVisitors} visitors`, 'success');
                        } else {
                            log(`‚ùå No visits data returned`);
                            showStatus('Queries work but no data returned', 'error');
                        }

                    } catch (error) {
                        log(`‚ùå Query error: ${error.message}`);
                        showStatus(`Query error: ${error.message}`, 'error');
                    }
                }

                checkClient();

            } catch (error) {
                log(`‚ùå Test error: ${error.message}`);
                showStatus(`Test error: ${error.message}`, 'error');
            }
        }

        document.getElementById('testBtn').addEventListener('click', testDashboardConnection);

        // Auto-test on load
        testDashboardConnection();
    </script>
</body>
</html>